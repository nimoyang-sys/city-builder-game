<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æŒäººæ§åˆ¶å° - å‰µæ™ºå‹•èƒ½ 2026</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }

    h1 .subtitle {
      display: block;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: normal;
      margin-top: 5px;
    }

    /* ç™»å…¥å€ */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }

    .login-form {
      background: var(--bg-card);
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
    }

    .login-form h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-muted);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* æ§åˆ¶å° */
    #control-panel {
      display: none;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .panel-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 800px) {
      .panel-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
    }

    .panel-card h3 {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 1.1rem;
    }

    .panel-card.full-width {
      grid-column: span 3;
    }

    @media (max-width: 1200px) {
      .panel-card.full-width {
        grid-column: span 2;
      }
    }

    @media (max-width: 800px) {
      .panel-card.full-width {
        grid-column: span 1;
      }
    }

    /* ç‹€æ…‹é¡¯ç¤º */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .status-item {
      background: var(--bg);
      padding: 15px 10px;
      border-radius: 8px;
      text-align: center;
    }

    .status-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .status-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* æŒ‰éˆ• */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin: 5px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: black;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-block {
      display: block;
      width: 100%;
      margin: 5px 0;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    /* äº‹ä»¶é¸æ“‡å€ */
    .event-select-container {
      margin-bottom: 15px;
    }

    .event-select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      cursor: pointer;
    }

    .event-select option {
      padding: 10px;
    }

    .event-preview {
      background: var(--bg);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }

    .event-preview-title {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .event-preview-desc {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .event-preview-effects {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .effect-tag {
      background: var(--bg-card);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .effect-tag.positive {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .effect-tag.negative {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* ç©å®¶åˆ†é æ¨£å¼ */
    .player-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .player-tab-btn {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .player-tab-btn:hover {
      background: var(--bg-hover);
      color: var(--text);
    }

    .player-tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: var(--bg-hover);
    }

    .player-tab-content {
      display: none;
    }

    .player-tab-content.active {
      display: block;
    }

    /* è§’è‰²ç¸½è¦½è¡¨æ ¼ */
    .roles-overview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .roles-overview-table th,
    .roles-overview-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .roles-overview-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .roles-overview-table tr:hover {
      background: var(--bg-hover);
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--bg-card);
    }

    /* ç©å®¶åˆ—è¡¨ - å¯æ”¶åˆå€å¡Š */
    .player-list-section {
      margin-top: 15px;
    }

    .player-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .player-list-header:hover {
      background: var(--bg-hover);
    }

    .player-list-header h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .player-list-toggle {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .player-list-toggle .arrow {
      transition: transform 0.2s;
    }

    .player-list-section.collapsed .player-list-toggle .arrow {
      transform: rotate(-90deg);
    }

    .player-list-section.collapsed .player-list {
      display: none;
    }

    /* ç©å®¶ç¶²æ ¼ */
    .player-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: var(--bg);
      border-radius: 0 0 8px 8px;
      margin-top: 2px;
    }

    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .player-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .player-chip:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .player-chip.selected {
      background: rgba(99, 102, 241, 0.2);
      border-color: var(--primary);
    }

    .player-chip .rank {
      width: 20px;
      height: 20px;
      background: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .player-chip .rank.top-3 {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: black;
    }

    .player-chip .name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .player-chip .score {
      color: var(--primary);
      font-weight: bold;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .player-chip .check {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.7rem;
    }

    .player-chip.selected .check {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* å·²é¸ç©å®¶é¡¯ç¤ºå€ */
    .selected-players-display {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      min-height: 32px;
    }

    .selected-player-tag {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .selected-player-tag .remove {
      cursor: pointer;
      opacity: 0.7;
      font-size: 0.9rem;
    }

    .selected-player-tag .remove:hover {
      opacity: 1;
    }

    .no-selection {
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 6px 0;
    }

    /* åŠ åˆ†å€ */
    .score-add-section {
      background: var(--bg);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .score-add-section h4 {
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .score-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .score-input-row input {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text);
      font-size: 1rem;
    }

    .score-input-row input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .score-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .score-preset-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .score-preset-btn:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .score-preset-btn.active {
      border-color: var(--primary);
      background: var(--primary);
    }

    .selected-players-info {
      background: rgba(99, 102, 241, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    /* äº‹ä»¶çµç®—æ˜ç´° */
    .settlement-panel {
      background: var(--bg);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .settlement-panel.show {
      display: block;
    }

    .settlement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .settlement-header h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .settlement-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .settlement-close:hover {
      color: var(--danger);
    }

    .settlement-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .settlement-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .settlement-item:last-child {
      border-bottom: none;
    }

    .settlement-item .player-name {
      flex: 1;
      font-weight: 500;
    }

    .settlement-item .income-detail {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .settlement-item .income {
      color: var(--success);
      font-weight: bold;
    }

    .settlement-item .income.negative {
      color: var(--danger);
    }

    .settlement-item .coins, .settlement-item .score {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .settlement-total {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-weight: bold;
    }

    /* äº‹ä»¶æ—¥èªŒ */
    .event-log {
      max-height: 250px;
      overflow-y: auto;
      background: var(--bg);
      border-radius: 8px;
      padding: 10px;
    }

    .log-item {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .log-item:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-muted);
      margin-right: 10px;
      font-size: 0.75rem;
    }

    .log-item.success {
      color: var(--success);
    }

    .log-item.error {
      color: var(--danger);
    }

    .log-item.warning {
      color: var(--warning);
    }

    /* æŠ½çå€ */
    .lottery-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* åŸå¸‚çµ±è¨ˆ */
    .city-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    @media (max-width: 600px) {
      .city-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .city-stat-item {
      background: var(--bg);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .city-stat-emoji {
      font-size: 1.5rem;
    }

    .city-stat-count {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .city-stat-name {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* æ»¾å‹•æ¢ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* å½ˆçª—æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      width: 90%;
      max-width: 1000px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.8) translateY(50px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 2px solid var(--border);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--text);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--danger);
      color: white;
    }

    .modal-body {
      padding: 20px 25px;
      overflow-y: auto;
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥ç•«é¢ -->
  <div id="login-screen">
    <div class="login-form">
      <h2>ğŸ® ä¸»æŒäººç™»å…¥</h2>
      <form id="login-form">
        <div class="form-group">
          <label>å¯†ç¢¼</label>
          <input type="password" id="host-password" placeholder="è«‹è¼¸å…¥ä¸»æŒäººå¯†ç¢¼" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">ç™»å…¥</button>
      </form>
      <p style="text-align: center; margin-top: 15px; color: var(--text-muted); font-size: 0.9rem;">
        é è¨­å¯†ç¢¼ï¼šbanquet2024
      </p>
    </div>
  </div>

  <!-- æ§åˆ¶å° -->
  <div id="control-panel" class="container">
    <h1>
      ğŸ™ï¸ å‰µæ™ºå‹•èƒ½ 2026 åŸå¸‚å»ºè¨­
      <span class="subtitle">ä¸»æŒäººæ§åˆ¶å°</span>
    </h1>

    <div class="panel-grid">
      <!-- éŠæˆ²ç‹€æ…‹ -->
      <div class="panel-card">
        <h3>ğŸ“Š éŠæˆ²ç‹€æ…‹</h3>
        <div class="status-grid">
          <div class="status-item">
            <div class="status-value" id="status-state">ç­‰å¾…ä¸­</div>
            <div class="status-label">ç›®å‰ç‹€æ…‹</div>
          </div>
          <div class="status-item">
            <div class="status-value" id="status-players">0</div>
            <div class="status-label">ç©å®¶äººæ•¸</div>
          </div>
          <div class="status-item">
            <div class="status-value" id="status-buildings">0</div>
            <div class="status-label">å»ºç¯‰ç¸½æ•¸</div>
          </div>
        </div>
      </div>

      <!-- éŠæˆ²æ§åˆ¶ -->
      <div class="panel-card">
        <h3>ğŸ¯ éŠæˆ²æ§åˆ¶</h3>
        <button class="btn btn-success btn-block" id="btn-start" onclick="startGame()">
          â–¶ï¸ é–‹å§‹éŠæˆ²
        </button>
        <button class="btn btn-danger btn-block" id="btn-end" onclick="endGame()" disabled>
          ğŸ çµæŸéŠæˆ²
        </button>
        <button class="btn btn-warning btn-block" id="btn-reset" onclick="resetGame()">
          ğŸ”„ é‡ç½®éŠæˆ²
        </button>
        <p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
          ç©å®¶åŠ å…¥æ™‚æœƒè‡ªå‹•åˆ†é…è§’è‰²<br>éŠæˆ²é–‹å§‹å¾Œç©å®¶å¯éš¨æ™‚å»ºç¯‰<br>ç™¼å¸ƒäº‹ä»¶ = å›åˆçµç®—
        </p>
      </div>

      <!-- äº‹ä»¶ç™¼å¸ƒ -->
      <div class="panel-card">
        <h3>ğŸ“¢ ç™¼å¸ƒäº‹ä»¶</h3>
        <button class="btn btn-warning btn-block" id="btn-random-event" onclick="triggerRandomEvent()" style="margin-bottom: 15px;">
          ğŸ² éš¨æ©Ÿç™¼å¸ƒäº‹ä»¶
        </button>
        <div class="event-select-container">
          <select class="event-select" id="event-select" onchange="previewEvent()">
            <option value="">-- æˆ–é¸æ“‡æŒ‡å®šäº‹ä»¶ --</option>
          </select>
        </div>
        <div class="event-preview" id="event-preview" style="display: none;">
          <div class="event-preview-title" id="preview-title"></div>
          <div class="event-preview-desc" id="preview-desc"></div>
          <div class="event-preview-effects" id="preview-effects"></div>
        </div>
        <button class="btn btn-primary btn-block" id="btn-trigger-event" onclick="triggerSelectedEvent()" disabled>
          ğŸ“£ ç™¼å¸ƒé¸å®šäº‹ä»¶
        </button>

        <!-- çµç®—æ˜ç´° -->
        <div class="settlement-panel" id="settlement-panel">
          <div class="settlement-header">
            <h4>ğŸ“Š æœ¬æ¬¡çµç®—æ˜ç´°</h4>
            <button class="settlement-close" onclick="hideSettlement()">âœ•</button>
          </div>
          <div class="settlement-event-info" id="settlement-event-info"></div>
          <div class="settlement-list" id="settlement-list">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
          <div class="settlement-total" id="settlement-total"></div>
        </div>

        <!-- æ­·å²ç´€éŒ„ -->
        <div style="margin-top: 15px;">
          <button class="btn btn-info btn-block btn-sm" onclick="showEventHistoryModal()">
            ğŸ“œ æŸ¥çœ‹äº‹ä»¶æ­·å²ç´€éŒ„
          </button>
        </div>
      </div>

      <!-- ç©å®¶åˆ—è¡¨èˆ‡åŠ åˆ† -->
      <div class="panel-card" style="grid-column: span 2;">
        <h3>ğŸ‘¥ ç©å®¶ç®¡ç†</h3>

        <!-- åˆ†é æ¨™ç±¤ -->
        <div class="player-tabs">
          <button class="player-tab-btn active" onclick="switchPlayerTab('scoring')">
            ğŸ® å°éŠæˆ²åŠ é‡‘å¹£
          </button>
          <button class="player-tab-btn" onclick="switchPlayerTab('roles')">
            ğŸ­ è§’è‰²èˆ‡ç©åˆ†ç¸½è¦½
          </button>
        </div>

        <!-- åˆ†é å…§å®¹ -->
        <div id="player-tab-scoring" class="player-tab-content active">
          <div class="score-add-section">
            <!-- å·²é¸ç©å®¶é¡¯ç¤º -->
            <div class="selected-players-info" id="selected-info">
              å·²é¸æ“‡ <strong id="selected-count">0</strong> ä½ç©å®¶
              <div class="selected-players-display" id="selected-display">
                <span class="no-selection">é»æ“Šä¸‹æ–¹ç©å®¶ä¾†é¸æ“‡</span>
              </div>
            </div>

            <!-- é‡‘å¹£è¨­å®š -->
            <div class="score-presets">
              <button class="score-preset-btn" onclick="setScoreAmount(50)">+50</button>
              <button class="score-preset-btn" onclick="setScoreAmount(100)">+100</button>
              <button class="score-preset-btn" onclick="setScoreAmount(200)">+200</button>
              <button class="score-preset-btn" onclick="setScoreAmount(500)">+500</button>
              <button class="score-preset-btn" onclick="setScoreAmount(1000)">+1000</button>
            </div>
            <div class="score-input-row">
              <input type="number" id="score-amount" placeholder="è‡ªè¨‚é‡‘å¹£" value="100">
              <input type="text" id="score-reason" placeholder="åŸå› ï¼ˆé¸å¡«ï¼‰" value="å°éŠæˆ²çå‹µ">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-success" style="flex: 1;" onclick="addCoinsToSelected()">
                âœ¨ ç‚ºé¸ä¸­ç©å®¶åŠ é‡‘å¹£
              </button>
              <button class="btn btn-info btn-sm" onclick="selectAllPlayers()">å…¨é¸</button>
              <button class="btn btn-sm" style="background: var(--border);" onclick="deselectAllPlayers()">å–æ¶ˆ</button>
            </div>
          </div>

          <!-- å¯æ”¶åˆç©å®¶åˆ—è¡¨ -->
          <div class="player-list-section" id="player-list-section">
            <div class="player-list-header" onclick="togglePlayerListSection()">
              <h4>ğŸ“‹ ç©å®¶åˆ—è¡¨ (<span id="player-total">0</span>äºº)</h4>
              <span class="player-list-toggle">
                é»æ“Šå±•é–‹/æ”¶åˆ <span class="arrow">â–¼</span>
              </span>
            </div>
            <div class="player-list" id="player-list">
              <p style="color: var(--text-muted); text-align: center; padding: 20px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
            </div>
          </div>
        </div>

        <!-- è§’è‰²èˆ‡ç©åˆ†ç¸½è¦½åˆ†é  -->
        <div id="player-tab-roles" class="player-tab-content">
          <div style="margin-top: 10px;">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
              é¡¯ç¤ºæ‰€æœ‰ç©å®¶çš„è§’è‰²ã€ç©åˆ†èˆ‡å»ºç¯‰æ•¸é‡
            </p>
            <div id="roles-overview-list">
              <p style="color: var(--text-muted); text-align: center; padding: 20px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- åŸå¸‚å»ºç¯‰çµ±è¨ˆ -->
      <div class="panel-card">
        <h3>ğŸ˜ï¸ åŸå¸‚å»ºç¯‰</h3>
        <div class="city-stats" id="city-stats">
          <p style="color: var(--text-muted); text-align: center; grid-column: span 5;">å°šç„¡å»ºç¯‰</p>
        </div>
      </div>

      <!-- é™æ™‚æ¶è³¼æ§åˆ¶ -->
      <div class="panel-card" id="flash-sale-panel">
        <h3>âš¡ é™æ™‚æ¶è³¼</h3>
        <div id="flash-sale-control">
          <div class="form-group">
            <label>é¸æ“‡å»ºç¯‰</label>
            <select id="flash-sale-building" class="event-select">
              <!-- å‹•æ…‹å¡«å…… -->
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label>ç‰¹åƒ¹é‡‘é¡</label>
              <input type="number" id="flash-sale-price" value="100" min="1" style="width: 100%;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>æ•¸é‡</label>
              <input type="number" id="flash-sale-quantity" value="3" min="1" max="20" style="width: 100%;">
            </div>
          </div>
          <div class="form-group">
            <label>æŒçºŒæ™‚é–“ï¼ˆç§’ï¼‰</label>
            <input type="number" id="flash-sale-duration" value="60" min="10" max="300" style="width: 100%;">
          </div>
          <button class="btn btn-danger btn-block" id="btn-flash-sale-start" onclick="startFlashSale()">
            âš¡ é–‹å§‹é™æ™‚æ¶è³¼
          </button>
        </div>
        <div id="flash-sale-active" style="display: none;">
          <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <span style="font-weight: bold;">é€²è¡Œä¸­çš„æ¶è³¼</span>
              <span id="flash-sale-timer" style="color: var(--warning); font-weight: bold;">--</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span id="flash-sale-item-display" style="font-size: 1.5rem;"></span>
              <div>
                <div id="flash-sale-name-display" style="font-weight: bold;"></div>
                <div style="font-size: 0.9rem;">
                  <span style="color: var(--text-muted); text-decoration: line-through;" id="flash-sale-original"></span>
                  <span style="color: var(--success); margin-left: 5px;" id="flash-sale-discount"></span>
                </div>
              </div>
            </div>
            <div style="margin-top: 10px; text-align: center;">
              å‰©é¤˜ï¼š<span id="flash-sale-remaining" style="color: var(--warning); font-weight: bold;">0</span> / <span id="flash-sale-total">0</span>
            </div>
          </div>
          <button class="btn btn-warning btn-block" onclick="endFlashSale()">
            â¹ï¸ çµæŸæ¶è³¼
          </button>
        </div>
      </div>

      <!-- å°éŠæˆ²æ§åˆ¶ -->
      <div class="panel-card" id="minigame-panel">
        <h3>ğŸ® å°éŠæˆ²</h3>

        <!-- å¿«å•å¿«ç­” -->
        <div style="margin-bottom: 15px;">
          <button class="btn btn-primary btn-block" onclick="startQuizGame()" id="btn-quiz">
            ğŸ’¡ å¿«å•å¿«ç­”
          </button>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
            ç©å®¶ç­”é¡Œï¼Œ10é¡Œéš¨æ©Ÿé¡Œç›®ï¼Œæ¯é¡Œ3ç§’ï¼Œç­”å°+50åˆ†
          </p>
        </div>

        <!-- å–å•¤é…’æ¯”è³½ -->
        <div style="margin-bottom: 15px;">
          <button class="btn btn-warning btn-block" onclick="startBeerGame()" id="btn-beer-waiting">
            ğŸº å–å•¤é…’æ¯”è³½
          </button>
          <div id="beer-game-control" style="display: none;">
            <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-top: 10px;">
              <p style="font-size: 0.85rem; margin-bottom: 5px;">
                åƒèˆ‡è€…ï¼š<span id="beer-participants-count">0</span> / 5
              </p>
              <div id="beer-participants-list" style="font-size: 0.8rem; color: var(--text-muted);"></div>
              <button class="btn btn-success btn-block btn-sm" onclick="startBeerGamePlay()" id="btn-beer-start" disabled style="margin-top: 10px;">
                é–‹å§‹æ¯”è³½
              </button>
              <div id="beer-ranking-control" style="display: none; margin-top: 10px;">
                <p style="font-size: 0.85rem; margin-bottom: 10px; font-weight: bold;">è¨­å®šæ’åï¼ˆæ‹–æ›³æ’åºï¼‰ï¼š</p>
                <div id="beer-ranking-list"></div>
                <button class="btn btn-primary btn-block btn-sm" onclick="confirmBeerRankings()" style="margin-top: 10px;">
                  ç¢ºèªæ’åä¸¦ç™¼æ”¾çå‹µ
                </button>
                <button class="btn btn-danger btn-block btn-sm" onclick="endBeerGameFinal()" style="margin-top: 5px;">
                  çµæŸæ¯”è³½
                </button>
              </div>
            </div>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
            3-5äººï¼Œç¬¬1å+500åˆ†ï¼Œç¬¬2å+300åˆ†ï¼Œå…¶ä»–+100åˆ†
          </p>
        </div>

        <!-- æ¯”å¤§å° -->
        <div>
          <button class="btn btn-info btn-block" onclick="startPokerGame()" id="btn-poker-start">
            ğŸƒ æ’²å…‹ç‰Œæ¯”å¤§å°
          </button>
          <div id="poker-game-control" style="display: none;">
            <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-top: 10px;">
              <p style="font-size: 0.85rem; margin-bottom: 5px;">
                éŠæˆ²é€²è¡Œä¸­... <span id="poker-timer" style="color: var(--warning); font-weight: bold;">20s</span>
              </p>
              <p style="font-size: 0.8rem; color: var(--text-muted);">
                å·²ä¸‹æ³¨ï¼š<span id="poker-bet-count">0</span> äºº
              </p>
              <button class="btn btn-danger btn-block btn-sm" onclick="endPokerGameNow()" style="margin-top: 10px;">
                ç«‹å³çµç®—
              </button>
            </div>
            <div id="poker-result-control" style="display: none; margin-top: 10px;">
              <div style="background: var(--bg); padding: 10px; border-radius: 8px;">
                <p style="font-size: 0.9rem; font-weight: bold; margin-bottom: 5px;">
                  çµæœï¼š<span id="poker-card-display"></span> = <span id="poker-result-display"></span>
                </p>
                <p style="font-size: 0.8rem; color: var(--success);">
                  è´å®¶ï¼ˆ+100åˆ†ï¼‰ï¼š<span id="poker-winners-count">0</span> äºº
                </p>
                <p style="font-size: 0.8rem; color: var(--danger);">
                  è¼¸å®¶ï¼ˆå–é…’ï¼‰ï¼š<span id="poker-losers-count">0</span> äºº
                </p>
                <button class="btn btn-primary btn-block btn-sm" onclick="nextPokerRound()" style="margin-top: 10px;">
                  ä¸‹ä¸€å±€
                </button>
              </div>
            </div>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
            å…¨å“¡åƒèˆ‡ï¼Œ20ç§’ä¸‹æ³¨ï¼ŒæŠ¼å°+100åˆ†ï¼ŒæŠ¼éŒ¯å–é…’
          </p>
        </div>
      </div>

      <!-- é ’çæ§åˆ¶ -->
      <div class="panel-card">
        <h3>ğŸ† é ’çå…¸ç¦®ï¼ˆä¾ç©åˆ†æ’åï¼‰</h3>
        <p id="lottery-hint" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">
          éœ€å…ˆã€ŒçµæŸéŠæˆ²ã€æ‰èƒ½é€²è¡Œé ’ç
        </p>

        <!-- çå“æ•¸é‡è¨­å®š -->
        <div id="prize-count-section" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-muted);">çå“æ•¸é‡ï¼ˆå‰å¹¾åå¾—çï¼‰</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="prize-count" min="1" max="100" value="10"
                   style="width: 80px; padding: 8px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 1rem;">
            <span style="color: var(--text-muted);">ä½</span>
          </div>
        </div>

        <div class="lottery-controls">
          <button class="btn btn-primary" onclick="startAwardCeremony()" id="btn-lottery-start" disabled>
            ğŸ‰ é–‹å§‹é ’ç
          </button>
          <button class="btn btn-warning" onclick="revealNextWinner()" id="btn-lottery-next" disabled style="display: none;">
            ğŸŠ æ­æ›‰ä¸‹ä¸€ä½å¾—çè€…
          </button>
          <button class="btn btn-danger" onclick="closeAwardCeremony()" id="btn-lottery-close" style="display: none;">
            âŒ çµæŸé ’ç
          </button>
        </div>
        <div id="lottery-status" style="margin-top: 15px; display: none;">
          <p style="color: var(--info);">ğŸ¯ é ’çé€²è¡Œä¸­... <span id="award-progress"></span></p>
          <div id="lottery-winners-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto; font-size: 0.9rem;"></div>
        </div>
      </div>

      <!-- äº‹ä»¶æ—¥èªŒ -->
      <div class="panel-card full-width">
        <h3>ğŸ“ äº‹ä»¶æ—¥èªŒ</h3>
        <div class="event-log" id="event-log">
          <div class="log-item">
            <span class="log-time">[ç³»çµ±]</span>
            <span>ä¸»æŒäººæ§åˆ¶å°å·²å°±ç·’</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ­·å²ç´€éŒ„å½ˆçª— -->
  <div class="modal-overlay" id="history-modal" onclick="hideEventHistoryModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ“œ äº‹ä»¶æ­·å²ç´€éŒ„</h3>
        <button class="modal-close" onclick="hideEventHistoryModal()">âœ•</button>
      </div>
      <div class="modal-body" id="event-history-list">
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">å°šç„¡æ­·å²ç´€éŒ„</p>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket = null;
    let isHost = false;
    let events = [];
    let players = [];
    let selectedPlayers = new Set();
    let gameState = null;
    let awardActive = false;
    let awardWinners = [];
    let currentAwardIndex = 0;
    let totalPrizes = 0;
    let eventHistory = [];  // äº‹ä»¶æ­·å²ç´€éŒ„

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      socket = io();

      socket.on('connect', () => {
        addLog('å·²é€£ç·šåˆ°ä¼ºæœå™¨');
      });

      socket.on('disconnect', () => {
        addLog('é€£ç·šä¸­æ–·', 'error');
      });

      // ä¸»æŒäººäº‹ä»¶
      socket.on('host:registered', handleHostRegistered);
      socket.on('host:error', (data) => {
        alert(data.error);
        addLog(data.error, 'error');
      });
      socket.on('host:result', (result) => {
        if (result.success) {
          addLog('æ“ä½œæˆåŠŸ', 'success');
        } else {
          addLog(result.error || 'æ“ä½œå¤±æ•—', 'error');
        }
        refreshGameState();
      });
      socket.on('host:eventResult', (result) => {
        if (result.success) {
          addLog(`äº‹ä»¶ã€Œ${result.event.title}ã€å·²ç™¼å¸ƒ`, 'success');
        } else {
          addLog(result.error || 'äº‹ä»¶ç™¼å¸ƒå¤±æ•—', 'error');
        }
        refreshGameState();
      });

      // éŠæˆ²äº‹ä»¶
      socket.on('game:started', handleGameStarted);
      socket.on('game:buildingPhase', handleBuildingPhase);
      socket.on('game:eventTriggered', handleEventTriggered);
      socket.on('game:ended', handleGameEnded);
      socket.on('game:playerJoined', handlePlayerJoined);
      socket.on('game:playerLeft', handlePlayerLeft);
      socket.on('game:reset', handleGameReset);
      socket.on('game:buildingPurchased', handleBuildingPurchased);
      socket.on('game:scoreAdded', handleScoreAdded);
      socket.on('game:scoreBatchAdded', handleScoreBatchAdded);

      // æŠ½çäº‹ä»¶
      socket.on('lottery:results', handleLotteryResults);
      socket.on('lottery:status', handleLotteryStatus);

      // è§’è‰²äº‹ä»¶
      socket.on('game:rolesAssigned', handleRolesAssigned);

      // æ–°ç‰ˆæŠ½çä¸­çäº‹ä»¶
      socket.on('lottery:winnerAnnounced', handleLotteryWinner);

      // é™æ™‚æ¶è³¼äº‹ä»¶
      socket.on('game:flashSaleStarted', handleFlashSaleStarted);
      socket.on('game:flashSalePurchased', handleFlashSalePurchased);
      socket.on('game:flashSaleEnded', handleFlashSaleEnded);

      // ç™»å…¥è¡¨å–®
      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('host-password').value;
        socket.emit('host:register', { password });
      });
    });

    // ä¸»æŒäººç™»å…¥æˆåŠŸ
    function handleHostRegistered(data) {
      if (data.success) {
        isHost = true;
        events = data.events || [];
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('control-panel').style.display = 'block';
        addLog('ä¸»æŒäººç™»å…¥æˆåŠŸ');
        populateEventSelect();
        populateBuildingSelect();
        refreshGameState();
      } else {
        alert(data.error || 'ç™»å…¥å¤±æ•—');
      }
    }

    // å¡«å……å»ºç¯‰é¸æ“‡ï¼ˆé™æ™‚æ¶è³¼ç”¨ï¼‰
    async function populateBuildingSelect() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        const select = document.getElementById('flash-sale-building');

        if (!config.buildings) return;

        select.innerHTML = '';
        for (const [id, building] of Object.entries(config.buildings)) {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = `${building.emoji} ${building.name} (åŸåƒ¹ ${building.cost})`;
          option.dataset.cost = building.cost;
          select.appendChild(option);
        }

        // é è¨­ç‰¹åƒ¹ç‚ºåŸåƒ¹çš„ä¸€åŠ
        select.addEventListener('change', () => {
          const selected = select.options[select.selectedIndex];
          if (selected) {
            const originalCost = parseInt(selected.dataset.cost);
            document.getElementById('flash-sale-price').value = Math.floor(originalCost / 2);
          }
        });

        // è§¸ç™¼åˆå§‹å€¼
        if (select.options.length > 0) {
          const firstOption = select.options[0];
          document.getElementById('flash-sale-price').value = Math.floor(parseInt(firstOption.dataset.cost) / 2);
        }
      } catch (error) {
        console.error('Failed to populate building select:', error);
      }
    }

    // å¡«å……äº‹ä»¶é¸æ“‡ä¸‹æ‹‰
    function populateEventSelect() {
      const select = document.getElementById('event-select');

      // æŒ‰é¡å‹åˆ†çµ„
      const eventsByType = {};
      events.forEach(event => {
        if (!eventsByType[event.type]) {
          eventsByType[event.type] = [];
        }
        eventsByType[event.type].push(event);
      });

      const typeNames = {
        'BOOM': 'ğŸš€ æ™¯æ°£ç¹æ¦®',
        'RECESSION': 'ğŸ“‰ ç¶“æ¿Ÿè¡°é€€',
        'DISASTER': 'ğŸŒŠ å¤©ç½',
        'POLICY': 'ğŸ“œ æ”¿ç­–',
        'SPECIAL': 'âœ¨ ç‰¹æ®Šäº‹ä»¶'
      };

      for (const [type, typeEvents] of Object.entries(eventsByType)) {
        const group = document.createElement('optgroup');
        group.label = typeNames[type] || type;

        typeEvents.forEach(event => {
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = `${event.emoji || ''} ${event.title}`;
          group.appendChild(option);
        });

        select.appendChild(group);
      }
    }

    // é è¦½äº‹ä»¶
    function previewEvent() {
      const select = document.getElementById('event-select');
      const preview = document.getElementById('event-preview');
      const eventId = select.value;

      if (!eventId) {
        preview.style.display = 'none';
        document.getElementById('btn-trigger-event').disabled = true;
        return;
      }

      const event = events.find(e => e.id === eventId);
      if (!event) return;

      preview.style.display = 'block';
      document.getElementById('preview-title').textContent = `${event.emoji || ''} ${event.title}`;
      document.getElementById('preview-desc').textContent = event.description;

      const effectsHtml = event.effects.map(effect => {
        if (effect.building) {
          const multiplier = effect.multiplier;
          const isPositive = multiplier > 1;
          const percent = isPositive
            ? `+${Math.round((multiplier - 1) * 100)}%`
            : `-${Math.round((1 - multiplier) * 100)}%`;
          return `<span class="effect-tag ${isPositive ? 'positive' : 'negative'}">${effect.building}: ${percent}</span>`;
        }
        if (effect.type === 'all_multiplier') {
          const isPositive = effect.multiplier > 1;
          const percent = isPositive
            ? `+${Math.round((effect.multiplier - 1) * 100)}%`
            : `-${Math.round((1 - effect.multiplier) * 100)}%`;
          return `<span class="effect-tag ${isPositive ? 'positive' : 'negative'}">å…¨é«”: ${percent}</span>`;
        }
        if (effect.type === 'bonus_coins') {
          return `<span class="effect-tag positive">+${effect.amount} é‡‘å¹£</span>`;
        }
        if (effect.type === 'bonus_score') {
          return `<span class="effect-tag positive">+${effect.amount} åˆ†æ•¸</span>`;
        }
        return '';
      }).join('');

      document.getElementById('preview-effects').innerHTML = effectsHtml;
      document.getElementById('btn-trigger-event').disabled = false;
    }

    // åˆ·æ–°éŠæˆ²ç‹€æ…‹
    async function refreshGameState() {
      try {
        const response = await fetch('/api/game/state');
        gameState = await response.json();
        updateStatusDisplay(gameState);
      } catch (error) {
        console.error('Failed to fetch game state:', error);
      }
    }

    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateStatusDisplay(state) {
      const stateNames = {
        'WAITING': 'ç­‰å¾…ä¸­',
        'BUILDING': 'å»ºè¨­ä¸­',
        'EVENT': 'äº‹ä»¶çµç®—',
        'ENDED': 'å·²çµæŸ'
      };

      document.getElementById('status-state').textContent = stateNames[state.state] || state.state;
      document.getElementById('status-players').textContent = state.playerCount || 0;
      document.getElementById('status-buildings').textContent = state.totalBuildings || 0;

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      const isWaiting = state.state === 'WAITING';
      const isEnded = state.state === 'ENDED';
      const isPlaying = state.state === 'BUILDING' || state.state === 'EVENT';

      document.getElementById('btn-start').disabled = !isWaiting;
      document.getElementById('btn-end').disabled = !isPlaying;
      // æ›´æ–°æŠ½çæŒ‰éˆ•ç‹€æ…‹
      if (!awardActive) {
        document.getElementById('btn-lottery-start').disabled = !isEnded || (state.playerCount === 0);
      }

      // æ›´æ–°æŠ½çæç¤º
      const lotteryHint = document.getElementById('lottery-hint');
      if (isEnded) {
        const playerCount = state.playerCount || 0;
        if (playerCount > 0) {
          lotteryHint.textContent = `âœ… å¯ä»¥é–‹å§‹æŠ½çï¼å…± ${playerCount} ä½ç©å®¶åƒèˆ‡`;
          lotteryHint.style.color = 'var(--success)';
        } else {
          lotteryHint.textContent = 'âš ï¸ æ²’æœ‰ç©å®¶åƒèˆ‡ï¼Œç„¡æ³•æŠ½ç';
          lotteryHint.style.color = 'var(--warning)';
        }
      } else {
        lotteryHint.textContent = 'éœ€å…ˆã€ŒçµæŸéŠæˆ²ã€æ‰èƒ½é€²è¡ŒæŠ½ç';
        lotteryHint.style.color = 'var(--text-muted)';
      }

      // æ›´æ–°æ’è¡Œæ¦œ
      console.log('updateStatusDisplay - state:', state);
      console.log('updateStatusDisplay - leaderboard:', state.leaderboard);
      if (state.leaderboard) {
        players = state.leaderboard;
        console.log('Updated players array:', players);
        updatePlayerList(state.leaderboard);
      }

      // æ›´æ–°åŸå¸‚å»ºç¯‰çµ±è¨ˆ
      if (state.cityBuildings) {
        // cityBuildings å¯èƒ½æ˜¯ { stats: {...}, categories: {...} } æˆ–ç›´æ¥æ˜¯ stats å°è±¡
        const stats = state.cityBuildings.stats || state.cityBuildings;
        updateCityStats(stats);
      }
    }

    // æ›´æ–°åŸå¸‚çµ±è¨ˆ
    function updateCityStats(stats) {
      const container = document.getElementById('city-stats');
      const entries = Object.entries(stats);

      if (entries.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; grid-column: span 5;">å°šç„¡å»ºç¯‰</p>';
        return;
      }

      container.innerHTML = entries.map(([id, info]) => `
        <div class="city-stat-item">
          <div class="city-stat-emoji">${info.emoji}</div>
          <div class="city-stat-count">${info.count}</div>
          <div class="city-stat-name">${info.name}</div>
        </div>
      `).join('');
    }

    // æ›´æ–°ç©å®¶åˆ—è¡¨ - ç¶²æ ¼å¼ä½ˆå±€
    function updatePlayerList(leaderboard) {
      const list = document.getElementById('player-list');
      const totalSpan = document.getElementById('player-total');

      if (!leaderboard || leaderboard.length === 0) {
        list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>';
        totalSpan.textContent = '0';
        return;
      }

      totalSpan.textContent = leaderboard.length;

      list.innerHTML = `
        <div class="player-grid">
          ${leaderboard.map((player, index) => `
            <div class="player-chip ${selectedPlayers.has(player.id) ? 'selected' : ''}"
                 onclick="togglePlayerSelection('${player.id}')"
                 title="${player.name} - ${player.score}åˆ† - ğŸ ${player.buildingCount || 0}${player.role ? ` - ${player.role.name}` : ''}">
              <span class="rank ${index < 3 ? 'top-3' : ''}">${index + 1}</span>
              ${player.role ? `<span style="font-size: 1rem;">${player.role.emoji}</span>` : ''}
              <span class="name">${player.name}</span>
              <span class="score">${player.score}</span>
              <span class="check">${selectedPlayers.has(player.id) ? 'âœ“' : ''}</span>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('status-players').textContent = leaderboard.length;
      updateSelectedInfo();
    }

    // åˆ‡æ›ç©å®¶é¸æ“‡
    function togglePlayerSelection(playerId) {
      if (selectedPlayers.has(playerId)) {
        selectedPlayers.delete(playerId);
      } else {
        selectedPlayers.add(playerId);
      }
      updatePlayerList(players);
    }

    // å…¨é¸ç©å®¶
    function selectAllPlayers() {
      players.forEach(p => selectedPlayers.add(p.id));
      updatePlayerList(players);
    }

    // å–æ¶ˆå…¨é¸
    function deselectAllPlayers() {
      selectedPlayers.clear();
      updatePlayerList(players);
    }

    // åˆ‡æ›ç©å®¶åˆ—è¡¨å±•é–‹/æ”¶åˆ
    function togglePlayerListSection() {
      const section = document.getElementById('player-list-section');
      section.classList.toggle('collapsed');
    }

    // åˆ‡æ›ç©å®¶ç®¡ç†åˆ†é 
    async function switchPlayerTab(tabName) {
      // ç§»é™¤æ‰€æœ‰ active é¡åˆ¥
      document.querySelectorAll('.player-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.player-tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // å•Ÿç”¨é¸ä¸­çš„åˆ†é 
      if (tabName === 'scoring') {
        document.querySelector('.player-tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('player-tab-scoring').classList.add('active');
      } else if (tabName === 'roles') {
        document.querySelector('.player-tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('player-tab-roles').classList.add('active');
        // å…ˆåˆ·æ–°éŠæˆ²ç‹€æ…‹ä»¥ç¢ºä¿æœ‰æœ€æ–°çš„ç©å®¶æ•¸æ“š
        await refreshGameState();
        updateRolesOverview();
      }
    }

    // æ›´æ–°è§’è‰²èˆ‡ç©åˆ†ç¸½è¦½
    function updateRolesOverview() {
      const container = document.getElementById('roles-overview-list');

      console.log('updateRolesOverview called, players:', players);
      console.log('players length:', players ? players.length : 'null');
      console.log('gameState:', gameState);

      if (!players || players.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>';
        return;
      }

      // ä¾ç…§ç©åˆ†æ’åº
      const sortedPlayers = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));

      container.innerHTML = `
        <table class="roles-overview-table">
          <thead>
            <tr>
              <th style="width: 50px;">æ’å</th>
              <th>ç©å®¶åç¨±</th>
              <th>è§’è‰²</th>
              <th style="text-align: right;">ç©åˆ†</th>
              <th style="text-align: right;">å»ºç¯‰æ•¸</th>
            </tr>
          </thead>
          <tbody>
            ${sortedPlayers.map((player, index) => `
              <tr>
                <td style="font-weight: 600; color: ${index < 3 ? 'var(--primary)' : 'var(--text-muted)'};">
                  #${index + 1}
                </td>
                <td style="font-weight: 600;">${player.name}</td>
                <td>
                  ${player.role ? `
                    <span class="role-badge" style="background: ${player.role.color}20; color: ${player.role.color};">
                      ${player.role.emoji} ${player.role.name}
                    </span>
                  ` : '<span style="color: var(--text-muted);">æœªåˆ†é…</span>'}
                </td>
                <td style="text-align: right; font-weight: 600; color: var(--primary);">
                  ${player.score || 0}
                </td>
                <td style="text-align: right; color: var(--text-muted);">
                  ğŸ  ${player.buildingCount || 0}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // æ›´æ–°é¸ä¸­è³‡è¨Šèˆ‡å·²é¸ç©å®¶æ¨™ç±¤
    function updateSelectedInfo() {
      document.getElementById('selected-count').textContent = selectedPlayers.size;

      const display = document.getElementById('selected-display');
      if (selectedPlayers.size === 0) {
        display.innerHTML = '<span class="no-selection">é»æ“Šä¸‹æ–¹ç©å®¶ä¾†é¸æ“‡</span>';
        return;
      }

      const selectedList = players.filter(p => selectedPlayers.has(p.id));
      display.innerHTML = selectedList.map(p => `
        <span class="selected-player-tag">
          ${p.name}
          <span class="remove" onclick="event.stopPropagation(); removeSelectedPlayer('${p.id}')">âœ•</span>
        </span>
      `).join('');
    }

    // ç§»é™¤å–®ä¸€å·²é¸ç©å®¶
    function removeSelectedPlayer(playerId) {
      selectedPlayers.delete(playerId);
      updatePlayerList(players);
    }

    // è¨­å®šåˆ†æ•¸æ•¸é‡
    function setScoreAmount(amount) {
      document.getElementById('score-amount').value = amount;
      document.querySelectorAll('.score-preset-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === `+${amount}`) {
          btn.classList.add('active');
        }
      });
    }

    // ç‚ºé¸ä¸­ç©å®¶åŠ åˆ†
    function addScoreToSelected() {
      if (selectedPlayers.size === 0) {
        alert('è«‹å…ˆé¸æ“‡ç©å®¶');
        return;
      }

      const amount = parseInt(document.getElementById('score-amount').value);
      const reason = document.getElementById('score-reason').value || 'å°éŠæˆ²çå‹µ';

      if (isNaN(amount) || amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆ†æ•¸');
        return;
      }

      const playerIds = Array.from(selectedPlayers);

      if (confirm(`ç¢ºå®šè¦ç‚º ${playerIds.length} ä½ç©å®¶å„åŠ  ${amount} åˆ†å—ï¼Ÿ\nåŸå› ï¼š${reason}`)) {
        socket.emit('host:addScoreBatch', { playerIds, amount, reason });
        addLog(`ç‚º ${playerIds.length} ä½ç©å®¶åŠ åˆ† +${amount}ï¼ˆ${reason}ï¼‰`, 'success');
        selectedPlayers.clear();
        updatePlayerList(players);
      }
    }

    function addCoinsToSelected() {
      if (selectedPlayers.size === 0) {
        alert('è«‹å…ˆé¸æ“‡ç©å®¶');
        return;
      }

      const amount = parseInt(document.getElementById('score-amount').value);
      const reason = document.getElementById('score-reason').value || 'å°éŠæˆ²çå‹µ';

      if (isNaN(amount) || amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘å¹£æ•¸é‡');
        return;
      }

      const playerIds = Array.from(selectedPlayers);

      if (confirm(`ç¢ºå®šè¦ç‚º ${playerIds.length} ä½ç©å®¶å„åŠ  ${amount} é‡‘å¹£å—ï¼Ÿ\nåŸå› ï¼š${reason}`)) {
        socket.emit('host:addCoinsBatch', { playerIds, amount, reason });
        addLog(`ç‚º ${playerIds.length} ä½ç©å®¶åŠ é‡‘å¹£ +${amount}ï¼ˆ${reason}ï¼‰`, 'success');
        selectedPlayers.clear();
        updatePlayerList(players);
      }
    }

    // äº‹ä»¶è™•ç†
    function handleGameStarted(data) {
      addLog(`éŠæˆ²é–‹å§‹ï¼å…± ${data.playerCount} ä½ç©å®¶`, 'success');
      refreshGameState();
    }

    function handleBuildingPhase(data) {
      addLog('é€²å…¥å»ºè¨­éšæ®µ', 'success');
      refreshGameState();
    }

    function handleEventTriggered(data) {
      addLog(`äº‹ä»¶ã€Œ${data.event.title}ã€å·²çµç®—ï¼Œå½±éŸ¿ ${data.results.length} ä½ç©å®¶`);
      showSettlement(data.event, data.results);
      refreshGameState();
    }

    // é¡¯ç¤ºçµç®—æ˜ç´°
    function showSettlement(event, results) {
      const panel = document.getElementById('settlement-panel');
      const eventInfo = document.getElementById('settlement-event-info');
      const list = document.getElementById('settlement-list');
      const total = document.getElementById('settlement-total');

      // é¡¯ç¤ºäº‹ä»¶è³‡è¨Š
      eventInfo.innerHTML = `
        <div style="margin-bottom: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px;">
          <div style="font-size: 1.1rem; margin-bottom: 5px;">${event.emoji || 'ğŸ“¢'} ${event.title}</div>
          <div style="font-size: 0.85rem; color: var(--text-muted);">${event.display?.affected || ''}</div>
        </div>
      `;

      // æŒ‰ç‡Ÿæ”¶æ’åº
      const sortedResults = [...results].sort((a, b) => b.income - a.income);

      // è¨ˆç®—ç¸½ç‡Ÿæ”¶
      const totalIncome = results.reduce((sum, r) => sum + r.income, 0);

      // ç”Ÿæˆåˆ—è¡¨
      list.innerHTML = sortedResults.map((r, index) => {
        const incomeClass = r.income > 0 ? '' : (r.income < 0 ? 'negative' : '');
        const incomeSign = r.income >= 0 ? '+' : '';
        return `
          <div class="settlement-item">
            <span class="player-name">
              <span style="color: var(--text-muted); margin-right: 5px;">#${index + 1}</span>
              ${r.playerName}
              ${r.luckyTriggered ? '<span style="color: var(--warning);" title="å¹¸é‹è§¸ç™¼">ğŸ€</span>' : ''}
              ${r.itemIncomeBonus ? '<span style="color: var(--info);" title="é“å…·åŠ æˆ">ğŸ“¦</span>' : ''}
            </span>
            <span class="income-detail">
              <span class="income ${incomeClass}">${incomeSign}${r.income}</span>
              <span class="coins" title="é‡‘å¹£">ğŸ’° ${r.newCoins}</span>
              <span class="score" title="è²¢ç»åˆ†">â­ ${r.newScore}</span>
            </span>
          </div>
        `;
      }).join('');

      // ç¸½è¨ˆ
      total.innerHTML = `
        <span>å…± ${results.length} ä½ç©å®¶</span>
        <span style="color: var(--success);">ç¸½ç‡Ÿæ”¶ +${totalIncome}</span>
      `;

      panel.classList.add('show');

      // å°‡æ­¤æ¬¡äº‹ä»¶åŠ å…¥æ­·å²ç´€éŒ„
      eventHistory.unshift({
        event: event,
        results: sortedResults,
        totalIncome: totalIncome,
        timestamp: Date.now()
      });
      updateEventHistory();
    }

    // éš±è—çµç®—æ˜ç´°
    function hideSettlement() {
      document.getElementById('settlement-panel').classList.remove('show');
    }

    // é¡¯ç¤º/éš±è—äº‹ä»¶æ­·å²å½ˆçª—
    function showEventHistoryModal() {
      updateEventHistory();
      const modal = document.getElementById('history-modal');
      modal.classList.add('show');
    }

    function hideEventHistoryModal() {
      const modal = document.getElementById('history-modal');
      modal.classList.remove('show');
    }

    // æ›´æ–°äº‹ä»¶æ­·å²åˆ—è¡¨
    function updateEventHistory() {
      const list = document.getElementById('event-history-list');

      if (eventHistory.length === 0) {
        list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">å°šç„¡æ­·å²ç´€éŒ„</p>';
        return;
      }

      list.innerHTML = eventHistory.map((record, index) => {
        const timeStr = new Date(record.timestamp).toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <div style="background: var(--bg-card); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-size: 1rem; font-weight: bold;">
                ${record.event.emoji || 'ğŸ“¢'} ${record.event.title}
              </div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">${timeStr}</div>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
              ${record.event.description || ''}
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px;">
              <span>å…± ${record.results.length} ä½ç©å®¶</span>
              <span style="color: var(--success); font-weight: bold;">ç¸½ç‡Ÿæ”¶ +${record.totalIncome}</span>
            </div>
            <button class="btn btn-sm btn-info" onclick="showHistoryDetail(${index})" style="margin-top: 8px; width: 100%;">
              æŸ¥çœ‹çµç®—æ˜ç´°
            </button>
          </div>
        `;
      }).join('');
    }

    // é¡¯ç¤ºæ­·å²äº‹ä»¶çš„çµç®—æ˜ç´°
    function showHistoryDetail(index) {
      const record = eventHistory[index];
      if (!record) return;

      // å…ˆé—œé–‰æ­·å²ç´€éŒ„å½ˆçª—
      hideEventHistoryModal();

      const panel = document.getElementById('settlement-panel');
      const eventInfo = document.getElementById('settlement-event-info');
      const list = document.getElementById('settlement-list');
      const total = document.getElementById('settlement-total');

      // é¡¯ç¤ºäº‹ä»¶è³‡è¨Š
      const timeStr = new Date(record.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      eventInfo.innerHTML = `
        <div style="margin-bottom: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px;">
          <div style="font-size: 1.1rem; margin-bottom: 5px;">${record.event.emoji || 'ğŸ“¢'} ${record.event.title}</div>
          <div style="font-size: 0.85rem; color: var(--text-muted);">${record.event.description || ''}</div>
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">ç™¼å¸ƒæ™‚é–“ï¼š${timeStr}</div>
        </div>
      `;

      // ç”Ÿæˆåˆ—è¡¨
      list.innerHTML = record.results.map((r, idx) => {
        const incomeClass = r.income > 0 ? '' : (r.income < 0 ? 'negative' : '');
        const incomeSign = r.income >= 0 ? '+' : '';
        return `
          <div class="settlement-item">
            <span class="player-name">
              <span style="color: var(--text-muted); margin-right: 5px;">#${idx + 1}</span>
              ${r.playerName}
              ${r.luckyTriggered ? '<span style="color: var(--warning);" title="å¹¸é‹è§¸ç™¼">ğŸ€</span>' : ''}
              ${r.itemIncomeBonus ? '<span style="color: var(--info);" title="é“å…·åŠ æˆ">ğŸ“¦</span>' : ''}
            </span>
            <span class="income-detail">
              <span class="income ${incomeClass}">${incomeSign}${r.income}</span>
              <span class="coins" title="é‡‘å¹£">ğŸ’° ${r.newCoins}</span>
              <span class="score" title="è²¢ç»åˆ†">â­ ${r.newScore}</span>
            </span>
          </div>
        `;
      }).join('');

      // ç¸½è¨ˆ
      total.innerHTML = `
        <span>å…± ${record.results.length} ä½ç©å®¶</span>
        <span style="color: var(--success);">ç¸½ç‡Ÿæ”¶ +${record.totalIncome}</span>
      `;

      panel.classList.add('show');
      hideEventHistory();
    }

    function handleGameEnded(data) {
      addLog('éŠæˆ²çµæŸï¼', 'warning');
      refreshGameState();

      // ç¦ç”¨å°éŠæˆ²å’Œé™æ™‚æ¶è³¼é¢æ¿
      const minigamePanel = document.getElementById('minigame-panel');
      const flashSalePanel = document.getElementById('flash-sale-panel');
      if (minigamePanel) {
        minigamePanel.style.opacity = '0.5';
        minigamePanel.style.pointerEvents = 'none';
        const buttons = minigamePanel.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
      }
      if (flashSalePanel) {
        flashSalePanel.style.opacity = '0.5';
        flashSalePanel.style.pointerEvents = 'none';
        const buttons = flashSalePanel.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
      }
    }

    function handlePlayerJoined(player) {
      addLog(`ç©å®¶åŠ å…¥ï¼š${player.name}`);
      refreshGameState();
    }

    function handlePlayerLeft(data) {
      addLog(`ç©å®¶é›¢ç·šï¼š${data.id}`);
      refreshGameState();
    }

    function handleGameReset() {
      addLog('éŠæˆ²å·²é‡ç½®', 'warning');
      selectedPlayers.clear();
      refreshGameState();
    }

    function handleBuildingPurchased(data) {
      addLog(`${data.playerName} å»ºé€ äº† ${data.building.emoji} ${data.building.name}`);
      refreshGameState();
    }

    function handleScoreAdded(data) {
      addLog(`${data.playerName} ç²å¾— +${data.amount} åˆ†ï¼ˆ${data.reason}ï¼‰`, 'success');
    }

    function handleScoreBatchAdded(data) {
      addLog(`${data.playerIds.length} ä½ç©å®¶ç²å¾— +${data.amount} åˆ†ï¼ˆ${data.reason}ï¼‰`, 'success');
      refreshGameState();
    }

    function handleLotteryResults(results) {
      addLog(`æŠ½çå®Œæˆï¼Œå…± ${results.length} ä½å¾—çè€…`, 'success');

      // é¡¯ç¤ºçµæœå€åŸŸ
      const resultsContainer = document.getElementById('lottery-results');
      const resultsList = document.getElementById('lottery-results-list');
      resultsContainer.style.display = 'block';

      let html = '';
      results.forEach(result => {
        if (result.success) {
          addLog(`ğŸ‰ ${result.record.player.name} ç²å¾— ${result.prize.name}`);
          html += `<div style="padding: 8px; margin-bottom: 5px; background: var(--bg); border-radius: 8px; display: flex; justify-content: space-between;">
            <span>${result.record.player.name}</span>
            <span style="color: var(--success);">ğŸ ${result.prize.name}</span>
          </div>`;
        } else {
          html += `<div style="padding: 8px; margin-bottom: 5px; background: var(--bg); border-radius: 8px; color: var(--text-muted);">
            ${result.player?.name || 'æœªçŸ¥ç©å®¶'} - ç„¡çå“å¯æŠ½
          </div>`;
        }
      });

      if (results.length === 0) {
        html = '<p style="color: var(--text-muted); text-align: center;">æ²’æœ‰æŠ½ççµæœ</p>';
      }

      resultsList.innerHTML = html;
    }

    function handleLotteryStatus(status) {
      console.log('Lottery status:', status);
    }

    // è§’è‰²åˆ†é…è™•ç†
    function handleRolesAssigned(data) {
      addLog(`è§’è‰²åˆ†é…å®Œæˆï¼å…± ${data.assignments.length} ä½ç©å®¶`, 'success');
      data.assignments.forEach(a => {
        addLog(`${a.playerName} â†’ ${a.role.emoji} ${a.role.name}`);
      });
      refreshGameState();
    }

    // åˆ†é…è§’è‰²
    function assignRoles() {
      if (players.length === 0) {
        alert('ç›®å‰æ²’æœ‰ç©å®¶ï¼Œç„¡æ³•åˆ†é…è§’è‰²');
        return;
      }
      if (confirm(`ç¢ºå®šè¦ç‚º ${players.length} ä½ç©å®¶éš¨æ©Ÿåˆ†é…è§’è‰²å—ï¼Ÿ`)) {
        socket.emit('host:assignRoles');
        addLog('æ­£åœ¨åˆ†é…è§’è‰²...');
      }
    }

    // æ§åˆ¶å‡½æ•¸
    function startGame() {
      if (confirm('ç¢ºå®šè¦é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
        socket.emit('host:startGame');
      }
    }

    function startBuildingPhase() {
      socket.emit('host:startBuilding');
      addLog('é–‹å§‹å»ºè¨­éšæ®µ');
    }

    function triggerRandomEvent() {
      if (confirm('ç¢ºå®šè¦éš¨æ©Ÿç™¼å¸ƒä¸€å€‹äº‹ä»¶å—ï¼Ÿ')) {
        socket.emit('host:triggerEvent', { eventId: null });
        addLog('ç™¼å¸ƒéš¨æ©Ÿäº‹ä»¶...');
      }
    }

    function triggerSelectedEvent() {
      const eventId = document.getElementById('event-select').value;
      if (!eventId) {
        alert('è«‹é¸æ“‡äº‹ä»¶');
        return;
      }

      const eventName = events.find(e => e.id === eventId)?.title || eventId;

      if (confirm(`ç¢ºå®šè¦ç™¼å¸ƒã€Œ${eventName}ã€å—ï¼Ÿ`)) {
        socket.emit('host:triggerEvent', { eventId });
      }
    }

    function endGame() {
      if (confirm('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿ')) {
        socket.emit('host:endGame');
      }
    }

    function resetGame() {
      if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿæ‰€æœ‰ç©å®¶è³‡æ–™å°‡è¢«æ¸…é™¤ï¼')) {
        socket.emit('host:reset');
      }
    }

    // ========== é ’çå…¸ç¦®æ§åˆ¶ï¼ˆä¾æ’åé †åºï¼‰ ==========
    function startAwardCeremony() {
      // æª¢æŸ¥æ˜¯å¦æœ‰ç©å®¶
      if (!players || players.length === 0) {
        alert('æ²’æœ‰ç©å®¶åƒèˆ‡ï¼Œç„¡æ³•é€²è¡Œé ’çï¼');
        return;
      }

      const prizeCount = parseInt(document.getElementById('prize-count').value) || 10;
      if (prizeCount < 1) {
        alert('çå“æ•¸é‡è‡³å°‘è¦ 1 ä»½ï¼');
        return;
      }

      const actualPrizeCount = Math.min(prizeCount, players.length);
      if (actualPrizeCount < prizeCount) {
        alert(`ç©å®¶äººæ•¸ä¸è¶³ï¼Œå°‡é ’ç™¼ ${actualPrizeCount} ä»½çå“`);
      }

      if (confirm(`ç¢ºå®šè¦é–‹å§‹é ’çå—ï¼Ÿ\nå°‡é ’ç™¼å‰ ${actualPrizeCount} åçš„çå“`)) {
        // ä¾ç©åˆ†æ’åºç©å®¶
        const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
        awardWinners = sortedPlayers.slice(0, actualPrizeCount);
        totalPrizes = actualPrizeCount;
        currentAwardIndex = 0;

        // ç™¼é€çµ¦æŠ•å½±ç•«é¢
        socket.emit('host:awardStart', {
          players: sortedPlayers,
          prizeCount: actualPrizeCount
        });

        awardActive = true;
        updateAwardButtons('ready');

        document.getElementById('prize-count-section').style.display = 'none';
        document.getElementById('lottery-status').style.display = 'block';
        document.getElementById('lottery-winners-list').innerHTML = '';
        updateAwardProgress();
        addLog(`é–‹å§‹é ’çï¼Œå…± ${actualPrizeCount} ä»½çå“`);
      }
    }

    function revealNextWinner() {
      if (!awardActive || currentAwardIndex >= totalPrizes) return;

      // ç™¼é€æ­æ›‰ä¸‹ä¸€ä½çš„æŒ‡ä»¤
      socket.emit('host:awardReveal', {
        rank: currentAwardIndex + 1,
        winner: awardWinners[currentAwardIndex]
      });

      // æœ¬åœ°é¡¯ç¤º
      const winner = awardWinners[currentAwardIndex];
      const list = document.getElementById('lottery-winners-list');
      const item = document.createElement('div');
      item.style.cssText = 'padding: 8px; margin-bottom: 5px; background: var(--bg-hover); border-radius: 6px; display: flex; justify-content: space-between;';

      const rank = currentAwardIndex + 1;
      let rankEmoji = 'ğŸ–ï¸';
      if (rank === 1) rankEmoji = 'ğŸ¥‡';
      else if (rank === 2) rankEmoji = 'ğŸ¥ˆ';
      else if (rank === 3) rankEmoji = 'ğŸ¥‰';

      item.innerHTML = `
        <span>${rankEmoji} ç¬¬ ${rank} åï¼š<strong>${winner.name}</strong></span>
        <span style="color: var(--warning);">${winner.score} åˆ†</span>
      `;
      list.insertBefore(item, list.firstChild);
      addLog(`${rankEmoji} ç¬¬ ${rank} åï¼š${winner.name}ï¼ˆ${winner.score} åˆ†ï¼‰`, 'success');

      currentAwardIndex++;
      updateAwardProgress();

      // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä¸‹ä¸€ä½
      if (currentAwardIndex >= totalPrizes) {
        updateAwardButtons('finished');
        addLog('ğŸŠ é ’çå®Œæˆï¼', 'success');
      }
    }

    function closeAwardCeremony() {
      const message = currentAwardIndex < totalPrizes
        ? `é‚„æœ‰ ${totalPrizes - currentAwardIndex} ä½æœªé ’çï¼Œç¢ºå®šè¦çµæŸå—ï¼Ÿ`
        : 'ç¢ºå®šè¦çµæŸé ’çå…¸ç¦®å—ï¼Ÿ';

      if (confirm(message)) {
        socket.emit('host:awardClose');
        awardActive = false;
        awardWinners = [];
        currentAwardIndex = 0;
        totalPrizes = 0;
        updateAwardButtons('closed');
        document.getElementById('lottery-status').style.display = 'none';
        document.getElementById('prize-count-section').style.display = 'block';
        addLog('é ’ççµæŸ');
      }
    }

    function updateAwardProgress() {
      const progress = document.getElementById('award-progress');
      progress.textContent = `(${currentAwardIndex}/${totalPrizes})`;
    }

    function updateAwardButtons(state) {
      const btnStart = document.getElementById('btn-lottery-start');
      const btnNext = document.getElementById('btn-lottery-next');
      const btnClose = document.getElementById('btn-lottery-close');

      // å…ˆå…¨éƒ¨éš±è—
      btnStart.style.display = 'none';
      btnNext.style.display = 'none';
      btnClose.style.display = 'none';

      switch (state) {
        case 'ready': // é ’çä¸­ï¼Œå¯æ­æ›‰ä¸‹ä¸€ä½
          btnNext.style.display = 'inline-block';
          btnNext.disabled = false;
          btnClose.style.display = 'inline-block';
          break;
        case 'finished': // å·²å…¨éƒ¨é ’å®Œ
          btnClose.style.display = 'inline-block';
          break;
        case 'closed': // å·²çµæŸ
        default:
          btnStart.style.display = 'inline-block';
          btnStart.disabled = gameState !== 'ENDED';
          break;
      }
    }

    // è™•ç†é ’çäº‹ä»¶ï¼ˆå¾æŠ•å½±ç•«é¢å›å‚³ï¼‰
    function handleLotteryWinner(data) {
      // ä¿ç•™ç›¸å®¹æ€§ï¼Œä½†ä¸»è¦ç”±æœ¬åœ°è™•ç†
      console.log('Award winner:', data);
    }

    // èˆŠç‰ˆæŠ½çå‡½æ•¸ï¼ˆä¿ç•™ç›¸å®¹æ€§ï¼‰
    function executeLottery(type) {
      alert('è«‹ä½¿ç”¨æ–°ç‰ˆé ’çåŠŸèƒ½');
    }

    // ========== é™æ™‚æ¶è³¼æ§åˆ¶ ==========
    let flashSaleTimer = null;

    function startFlashSale() {
      const buildingId = document.getElementById('flash-sale-building').value;
      const salePrice = parseInt(document.getElementById('flash-sale-price').value);
      const quantity = parseInt(document.getElementById('flash-sale-quantity').value);
      const duration = parseInt(document.getElementById('flash-sale-duration').value);

      if (!buildingId) {
        alert('è«‹é¸æ“‡å»ºç¯‰');
        return;
      }

      if (isNaN(salePrice) || salePrice < 1) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‰¹åƒ¹é‡‘é¡');
        return;
      }

      if (isNaN(quantity) || quantity < 1) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');
        return;
      }

      const selected = document.getElementById('flash-sale-building').options[
        document.getElementById('flash-sale-building').selectedIndex
      ];
      const buildingName = selected.textContent;

      if (confirm(`ç¢ºå®šè¦é–‹å§‹é™æ™‚æ¶è³¼å—ï¼Ÿ\n${buildingName}\nç‰¹åƒ¹: ${salePrice} é‡‘å¹£\næ•¸é‡: ${quantity}\næŒçºŒ: ${duration} ç§’`)) {
        socket.emit('host:startFlashSale', {
          buildingId,
          salePrice,
          quantity,
          duration
        });
        addLog(`é–‹å§‹é™æ™‚æ¶è³¼ï¼š${buildingName} x${quantity}`, 'success');
      }
    }

    function endFlashSale() {
      if (confirm('ç¢ºå®šè¦æå‰çµæŸé™æ™‚æ¶è³¼å—ï¼Ÿ')) {
        socket.emit('host:endFlashSale');
        addLog('é™æ™‚æ¶è³¼å·²çµæŸ', 'warning');
      }
    }

    function handleFlashSaleStarted(data) {
      addLog(`âš¡ é™æ™‚æ¶è³¼é–‹å§‹ï¼${data.building.emoji} ${data.building.name} ${data.salePrice}é‡‘å¹£ x${data.quantity}`, 'success');

      // æ›´æ–° UI
      document.getElementById('flash-sale-control').style.display = 'none';
      document.getElementById('flash-sale-active').style.display = 'block';

      document.getElementById('flash-sale-item-display').textContent = data.building.emoji;
      document.getElementById('flash-sale-name-display').textContent = data.building.name;
      document.getElementById('flash-sale-original').textContent = data.originalPrice + ' é‡‘å¹£';
      document.getElementById('flash-sale-discount').textContent = data.salePrice + ' é‡‘å¹£ (-' + data.discount + '%)';
      document.getElementById('flash-sale-remaining').textContent = data.remaining;
      document.getElementById('flash-sale-total').textContent = data.quantity;

      // é–‹å§‹å€’è¨ˆæ™‚
      startFlashSaleCountdown(data.endTime);
    }

    function handleFlashSalePurchased(data) {
      addLog(`${data.playerName} æ¶è³¼æˆåŠŸï¼å‰©é¤˜ ${data.remaining} å€‹`);
      document.getElementById('flash-sale-remaining').textContent = data.remaining;
    }

    function handleFlashSaleEnded(data) {
      addLog(`é™æ™‚æ¶è³¼çµæŸï¼å”®å‡º ${data ? data.totalSold : 0}/${data ? data.totalQuantity : 0}`, 'warning');

      // æ›´æ–° UI
      document.getElementById('flash-sale-control').style.display = 'block';
      document.getElementById('flash-sale-active').style.display = 'none';

      if (flashSaleTimer) {
        clearInterval(flashSaleTimer);
        flashSaleTimer = null;
      }
    }

    function startFlashSaleCountdown(endTime) {
      if (flashSaleTimer) {
        clearInterval(flashSaleTimer);
      }

      const updateTimer = () => {
        const remaining = Math.max(0, endTime - Date.now());
        const seconds = Math.ceil(remaining / 1000);

        document.getElementById('flash-sale-timer').textContent = seconds + 's';

        if (remaining <= 0) {
          clearInterval(flashSaleTimer);
          flashSaleTimer = null;
        }
      };

      updateTimer();
      flashSaleTimer = setInterval(updateTimer, 1000);
    }

    // æ·»åŠ æ—¥èªŒ
    function addLog(message, type = 'info') {
      const log = document.getElementById('event-log');
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = `log-item fade-in ${type}`;
      item.innerHTML = `<span class="log-time">[${time}]</span><span>${message}</span>`;
      log.insertBefore(item, log.firstChild);

      // é™åˆ¶æ—¥èªŒæ•¸é‡
      while (log.children.length > 100) {
        log.removeChild(log.lastChild);
      }
    }

    // ========== å°éŠæˆ²æ§åˆ¶ ==========

    let beerParticipants = [];
    let pokerTimerInterval = null;

    // å¿«å•å¿«ç­”
    function startQuizGame() {
      if (confirm('ç¢ºå®šè¦é–‹å§‹å¿«å•å¿«ç­”å—ï¼Ÿ')) {
        socket.emit('host:startQuiz');
        addLog('é–‹å§‹å¿«å•å¿«ç­”', 'success');
      }
    }

    // å–å•¤é…’æ¯”è³½ - é–‹å§‹ç­‰å¾…
    function startBeerGame() {
      if (confirm('ç¢ºå®šè¦é–‹å§‹å–å•¤é…’æ¯”è³½å—ï¼Ÿå°‡é–‹å§‹ç­‰å¾…ç©å®¶åŠ å…¥')) {
        socket.emit('host:startBeerWaiting');
        document.getElementById('btn-beer-waiting').style.display = 'none';
        document.getElementById('beer-game-control').style.display = 'block';
        addLog('å–å•¤é…’æ¯”è³½ç­‰å¾…ç©å®¶åŠ å…¥', 'success');
      }
    }

    // å–å•¤é…’æ¯”è³½ - é–‹å§‹æ¯”è³½
    function startBeerGamePlay() {
      socket.emit('host:startBeerGame');
      document.getElementById('btn-beer-start').disabled = true;
      document.getElementById('beer-ranking-control').style.display = 'block';
      addLog('å–å•¤é…’æ¯”è³½é–‹å§‹ï¼', 'success');
      updateBeerRankingList();
    }

    // æ›´æ–°å–å•¤é…’æ’ååˆ—è¡¨
    function updateBeerRankingList() {
      const list = document.getElementById('beer-ranking-list');
      list.innerHTML = beerParticipants.map((p, index) => `
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 5px;">
          <span>${p.playerName}</span>
          <select id="rank-${p.playerId}" style="padding: 4px; border-radius: 4px;">
            ${[1, 2, 3, 4, 5].filter((_, i) => i < beerParticipants.length).map(r =>
              `<option value="${r}">${r}</option>`
            ).join('')}
          </select>
        </div>
      `).join('');
    }

    // ç¢ºèªå–å•¤é…’æ’å
    function confirmBeerRankings() {
      const rankings = beerParticipants.map(p => ({
        playerId: p.playerId,
        rank: parseInt(document.getElementById(`rank-${p.playerId}`).value)
      }));

      // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡æ’å
      const ranks = rankings.map(r => r.rank);
      if (new Set(ranks).size !== ranks.length) {
        alert('æ’åä¸èƒ½é‡è¤‡ï¼');
        return;
      }

      if (confirm('ç¢ºèªè¨­å®šæ’åä¸¦ç™¼æ”¾çå‹µï¼Ÿ')) {
        socket.emit('host:setBeerRankings', { rankings });
        addLog('å–å•¤é…’æ¯”è³½æ’åå·²è¨­å®š', 'success');
      }
    }

    // çµæŸå–å•¤é…’æ¯”è³½
    function endBeerGameFinal() {
      if (confirm('ç¢ºå®šè¦çµæŸå–å•¤é…’æ¯”è³½å—ï¼Ÿ')) {
        socket.emit('host:endBeerGame');
        document.getElementById('btn-beer-waiting').style.display = 'block';
        document.getElementById('beer-game-control').style.display = 'none';
        document.getElementById('beer-ranking-control').style.display = 'none';
        document.getElementById('btn-beer-start').disabled = false;
        beerParticipants = [];
        addLog('å–å•¤é…’æ¯”è³½çµæŸ', 'warning');
      }
    }

    // æ¯”å¤§å° - é–‹å§‹
    function startPokerGame() {
      if (confirm('ç¢ºå®šè¦é–‹å§‹æ¯”å¤§å°å—ï¼Ÿç©å®¶æœ‰20ç§’æ™‚é–“ä¸‹æ³¨')) {
        socket.emit('host:startPoker');
        document.getElementById('btn-poker-start').style.display = 'none';
        document.getElementById('poker-game-control').style.display = 'block';
        document.getElementById('poker-result-control').style.display = 'none';
        addLog('æ¯”å¤§å°éŠæˆ²é–‹å§‹', 'success');
      }
    }

    // æ¯”å¤§å° - ç«‹å³çµç®—
    function endPokerGameNow() {
      if (confirm('ç¢ºå®šè¦ç«‹å³çµç®—å—ï¼Ÿ')) {
        socket.emit('host:endPoker');
      }
    }

    // æ¯”å¤§å° - ä¸‹ä¸€å±€
    function nextPokerRound() {
      socket.emit('host:nextPokerRound');
      document.getElementById('btn-poker-start').style.display = 'block';
      document.getElementById('poker-game-control').style.display = 'none';
      document.getElementById('poker-result-control').style.display = 'none';
      if (pokerTimerInterval) {
        clearInterval(pokerTimerInterval);
        pokerTimerInterval = null;
      }
      addLog('æº–å‚™ä¸‹ä¸€å±€æ¯”å¤§å°', 'info');
    }

    // ========== å°éŠæˆ²äº‹ä»¶ç›£è½ ==========

    // å¿«å•å¿«ç­”äº‹ä»¶
    socket.on('minigame:quizStarted', (data) => {
      addLog(`å¿«å•å¿«ç­”é–‹å§‹ï¼Œå…± ${data.questionCount} é¡Œ`, 'success');
    });

    socket.on('minigame:quizEnded', (data) => {
      addLog(`å¿«å•å¿«ç­”çµæŸï¼Œ${data.results.length} ä½ç©å®¶åƒèˆ‡`, 'success');
    });

    // å–å•¤é…’æ¯”è³½äº‹ä»¶
    socket.on('minigame:beerWaitingStart', () => {
      beerParticipants = [];
      document.getElementById('beer-participants-count').textContent = '0';
      document.getElementById('beer-participants-list').innerHTML = '';
    });

    socket.on('minigame:beerPlayerJoined', (data) => {
      beerParticipants.push({ playerId: data.playerId, playerName: data.playerName });
      document.getElementById('beer-participants-count').textContent = data.currentCount;
      document.getElementById('beer-participants-list').innerHTML =
        beerParticipants.map(p => p.playerName).join(', ');

      if (data.canStart) {
        document.getElementById('btn-beer-start').disabled = false;
      }

      addLog(`${data.playerName} åŠ å…¥å–å•¤é…’æ¯”è³½ï¼ˆ${data.currentCount}/${data.maxPlayers}ï¼‰`);
    });

    socket.on('minigame:beerResultsSet', (data) => {
      addLog('å–å•¤é…’æ¯”è³½æ’åå·²ç¢ºèªï¼Œçå‹µå·²ç™¼æ”¾', 'success');
    });

    socket.on('minigame:beerEnded', () => {
      addLog('å–å•¤é…’æ¯”è³½çµæŸ', 'warning');
    });

    // æ¯”å¤§å°äº‹ä»¶
    socket.on('minigame:pokerStarted', (data) => {
      // å•Ÿå‹•å€’è¨ˆæ™‚
      const endTime = data.endTime;

      pokerTimerInterval = setInterval(() => {
        const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
        document.getElementById('poker-timer').textContent = remaining + 's';

        if (remaining <= 0) {
          clearInterval(pokerTimerInterval);
          pokerTimerInterval = null;
        }
      }, 100);
    });

    socket.on('minigame:pokerEnded', (data) => {
      if (pokerTimerInterval) {
        clearInterval(pokerTimerInterval);
        pokerTimerInterval = null;
      }

      document.getElementById('poker-game-control').style.display = 'none';
      document.getElementById('poker-result-control').style.display = 'block';

      const cardNames = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
      const cardDisplay = cardNames[data.card - 1] || data.card;
      const resultText = data.result === 'big' ? 'å¤§' : 'å°';

      document.getElementById('poker-card-display').textContent = cardDisplay;
      document.getElementById('poker-result-display').textContent = resultText;
      document.getElementById('poker-winners-count').textContent = data.winners.length;
      document.getElementById('poker-losers-count').textContent = data.losers.length;

      addLog(`æ¯”å¤§å°çµç®—ï¼š${cardDisplay} = ${resultText}ï¼Œ${data.winners.length}äººç²å‹`, 'success');
    });

    socket.on('minigame:pokerRoundEnd', () => {
      addLog('æ¯”å¤§å°æœ¬å±€çµæŸ', 'info');
    });

    // å®šæ™‚åˆ·æ–°
    setInterval(() => {
      if (isHost) {
        refreshGameState();
      }
    }, 3000);
  </script>
</body>
</html>
