<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰µæ™ºå‹•èƒ½ 2026 - åŸå¸‚å»ºè¨­</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    :root {
      /* å¡é€šå¯æ„›é¢¨é…è‰² */
      --primary: #FF6B9D;
      --secondary: #FFD93D;
      --success: #6BCB77;
      --info: #4D96FF;
      --danger: #FF6B6B;
      --purple: #C86BFA;
      --bg-sky: #87CEEB;
      --bg-card: rgba(255,255,255,0.95);
      --text: #4A4A4A;
      --text-light: #FFFFFF;
      --ground: #8BC34A;
      --ground-dark: #689F38;
      --shadow: rgba(0,0,0,0.15);
    }

    body {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(180deg, #4FC3F7 0%, #81D4FA 30%, #B3E5FC 50%, #E1F5FE 70%);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .display-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== é ‚éƒ¨æ¨™é¡Œåˆ— - é€æ˜ç„¡èƒŒæ™¯ ===== */
    .top-bar {
      background: transparent;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      position: relative;
    }

    .game-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 140px;  /* æ”¾å¤§ logo ä»¥æ¥è¿‘æ¨™é¡Œæ–‡å­—å¤§å° */
      height: auto;
      filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.25));
    }

    .title-text h1 {
      font-size: 2.2rem;
      font-weight: 900;
      color: #333;
      letter-spacing: 2px;
      text-shadow: 2px 2px 3px rgba(255,255,255,0.8);
    }

    .title-text .slogan {
      font-size: 1.1rem;
      color: #555;
      font-weight: 600;
      margin-top: 4px;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
    }

    .stats-bar {
      display: flex;
      gap: 30px;  /* å¢åŠ é–“è·å¾ 20px åˆ° 30px */
      align-items: center;
      margin-left: auto;
      margin-right: 30px;  /* èˆ‡ç‹€æ…‹å¾½ç« ä¿æŒé–“è· */
    }

    .stat-item {
      text-align: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 28px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 3px solid #FFD93D;
      min-width: 100px;
    }

    .stat-value {
      font-size: 2.5rem;  /* å¾ 1.8rem æ”¾å¤§åˆ° 2.5rem */
      font-weight: 900;
      color: #FF6B9D;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 4px;
      font-weight: 600;
    }

    .status-badge {
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 25px;
      border: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .status-badge.building {
      background: #4CAF50;
      color: #fff;
    }
    .status-badge.event {
      background: #FF9800;
      color: #fff;
    }
    .status-badge.waiting {
      background: #2196F3;
      color: #fff;
    }
    .status-badge.ended {
      background: #E91E63;
      color: #fff;
    }

    /* ===== ä¸»è¦åŸå¸‚å€åŸŸ ===== */
    .city-area {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* å¤©ç©ºèƒŒæ™¯ - å¯æ„›è—å¤© */
    .sky {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60%;
      /* ç§»é™¤èƒŒæ™¯ï¼Œä½¿ç”¨ body çš„æ¼¸å±¤èƒŒæ™¯ï¼Œé¿å…åˆ†ç•Œç·š */
      background: transparent;
    }

    /* éš±è—æ˜Ÿæ˜Ÿï¼ˆç™½å¤©ä¸éœ€è¦ï¼‰*/
    .stars {
      display: none;
    }

    /* å¯æ„›å¤ªé™½ */
    .sun {
      position: absolute;
      top: 8%;
      right: 10%;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, #FFF9C4 0%, #FFD93D 50%, #FFC107 100%);
      border-radius: 50%;
      box-shadow:
        0 0 60px rgba(255,217,61,0.6),
        0 0 100px rgba(255,193,7,0.4);
      animation: sunHappy 3s ease-in-out infinite;
    }

    /* å¤ªé™½è¡¨æƒ… */
    .sun::before {
      content: 'â—¡â€¿â—¡';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      color: #FF9800;
    }

    @keyframes sunHappy {
      0%, 100% {
        transform: scale(1) rotate(0deg);
        box-shadow: 0 0 60px rgba(255,217,61,0.6), 0 0 100px rgba(255,193,7,0.4);
      }
      50% {
        transform: scale(1.05) rotate(5deg);
        box-shadow: 0 0 80px rgba(255,217,61,0.7), 0 0 120px rgba(255,193,7,0.5);
      }
    }

    /* å¯æ„›é›²æœµ */
    .clouds {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 250px;
      overflow: hidden;
    }

    .cloud {
      position: absolute;
      background: white;
      border-radius: 50px;
      opacity: 0.9;
      animation: cloudFloat 50s linear infinite;
      filter: drop-shadow(0 3px 8px rgba(0,0,0,0.08));
      will-change: transform;  /* å„ªåŒ–å‹•ç•«æ•ˆèƒ½ */
    }

    .cloud::before, .cloud::after {
      content: '';
      position: absolute;
      background: white;
      border-radius: 50%;
    }

    .cloud-1 {
      width: 120px;
      height: 50px;
      top: 50px;
      left: -150px;
      animation-duration: 45s;
    }
    .cloud-1::before { width: 60px; height: 60px; top: -30px; left: 20px; }
    .cloud-1::after { width: 45px; height: 45px; top: -20px; left: 65px; }

    .cloud-2 {
      width: 150px;
      height: 60px;
      top: 100px;
      left: -200px;
      animation-duration: 55s;
      animation-delay: -20s;
    }
    .cloud-2::before { width: 70px; height: 70px; top: -35px; left: 30px; }
    .cloud-2::after { width: 55px; height: 55px; top: -25px; left: 85px; }

    .cloud-3 {
      width: 100px;
      height: 45px;
      top: 160px;
      left: -130px;
      animation-duration: 60s;
      animation-delay: -35s;
    }
    .cloud-3::before { width: 50px; height: 50px; top: -25px; left: 15px; }
    .cloud-3::after { width: 40px; height: 40px; top: -18px; left: 55px; }

    @keyframes cloudFloat {
      0% { transform: translateX(0); }
      100% { transform: translateX(calc(100vw + 250px)); }
    }

    /* åœ°é¢ - å¯æ„›è‰åœ° */
    .ground-area {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 22%;
      background: linear-gradient(180deg,
        #8BC34A 0%,
        #7CB342 30%,
        #689F38 60%,
        #558B2F 100%
      );
      border-top: 6px solid #9CCC65;
    }

    /* è‰åœ°è£é£¾ - å°èŠ± */
    .ground-area::before {
      content: 'ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼ ğŸŒ¸ ğŸŒ¼';
      position: absolute;
      top: -5px;
      left: 0;
      right: 0;
      font-size: 1.2rem;
      letter-spacing: 30px;
      opacity: 0.8;
      animation: flowerSway 4s ease-in-out infinite;
    }

    @keyframes flowerSway {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    /* é“è·¯ - å¯æ„›é¢¨æ ¼ */
    .road {
      position: absolute;
      bottom: 30px;
      left: 0;
      right: 0;
      height: 45px;
      background: linear-gradient(180deg, #78909C 0%, #607D8B 50%, #546E7A 100%);
      border-top: 5px solid #90A4AE;
      border-bottom: 5px solid #455A64;
      border-radius: 0;
    }

    .road::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 8px;
      background: repeating-linear-gradient(90deg,
        #FFFFFF 0px, #FFFFFF 50px,
        transparent 50px, transparent 100px
      );
      transform: translateY(-50%);
      border-radius: 4px;
    }

    /* äººè¡Œé“ - å¯æ„›ç£šå¡Š */
    .sidewalk {
      position: absolute;
      bottom: 105px;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(180deg, #FFCCBC 0%, #FFAB91 100%);
      border-top: 4px solid #FFE0B2;
      border-bottom: 4px solid #FF8A65;
    }

    .sidewalk::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(90deg,
        transparent 0px, transparent 38px,
        rgba(255,255,255,0.3) 38px, rgba(255,255,255,0.3) 40px
      );
    }

    /* å»ºç¯‰ç‰©å€åŸŸ - å¤šå±¤ç”±è¿‘è€Œé  */
    .buildings-container {
      position: absolute;
      bottom: 85px;
      left: 20px;
      right: 340px;
      top: 200px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      pointer-events: none;
      overflow: hidden;
    }

    /* å»ºç¯‰æ’ */
    .building-row {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 6px;
      padding: 0 10px;
      flex-wrap: wrap;
      position: relative;
    }

    /* å¾Œæ’ï¼ˆé è™•ï¼‰- æœ€å° */
    .building-row.row-back {
      transform: scale(0.5);
      transform-origin: bottom center;
      filter: brightness(0.75) saturate(0.75);
      z-index: 1;
      margin-bottom: -40px;
    }

    /* ä¸­æ’ */
    .building-row.row-mid {
      transform: scale(0.72);
      transform-origin: bottom center;
      filter: brightness(0.88) saturate(0.88);
      z-index: 2;
      margin-bottom: -20px;
    }

    /* å‰æ’ï¼ˆè¿‘è™•ï¼‰- æœ€å¤§ */
    .building-row.row-front {
      transform: scale(1);
      z-index: 3;
    }

    /* å–®å€‹å»ºç¯‰ */
    .building {
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: buildPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      cursor: default;
      pointer-events: auto;
    }

    /* ç©å®¶åç¨±æ¨™ç±¤ */
    .building-owner {
      margin-top: 4px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #5D4037;
      white-space: nowrap;
      max-width: 70px;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      border: 2px solid #FFB6C1;
    }

    @keyframes buildPop {
      0% {
        transform: scale(0) translateY(30px);
        opacity: 0;
      }
      60% {
        transform: scale(1.1) translateY(-10px);
      }
      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* å·²å­˜åœ¨çš„å»ºç¯‰ä¸è¦å‹•ç•« */
    .building.no-animation {
      animation: none;
    }

    .building:hover .css-building {
      transform: scale(1.1) translateY(-5px);
    }

    /* ===== CSS å¡é€šå»ºç¯‰ - å›ºå®šå°ºå¯¸ä¸è®Šå½¢ ===== */
    .css-building {
      position: relative;
      transition: transform 0.3s ease;
      filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));
    }

    .building:hover .css-building {
      transform: scale(1.1) translateY(-5px);
    }

    /* å‰æ’å»ºç¯‰å°ºå¯¸ */
    .building-row.row-front .css-building {
      transform: scale(1);
    }

    /* ä¸­æ’å»ºç¯‰å°ºå¯¸ */
    .building-row.row-mid .css-building {
      transform: scale(0.85);
    }

    /* å¾Œæ’å»ºç¯‰å°ºå¯¸ */
    .building-row.row-back .css-building {
      transform: scale(0.7);
    }

    /* === ä½å®… HOUSE === */
    .b-house {
      width: 50px;
      height: 55px;
    }
    .b-house .body {
      position: absolute;
      bottom: 0;
      left: 5px;
      width: 40px;
      height: 35px;
      background: linear-gradient(135deg, #FFCDD2 0%, #EF9A9A 100%);
      border-radius: 4px;
      z-index: 1;  /* å±‹èº«åœ¨ä¸‹å±¤ */
    }
    .b-house .roof {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 25px solid #E57373;
      z-index: 2;  /* å±‹é ‚åœ¨æœ€ä¸Šå±¤ */
    }
    .b-house .door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 18px;
      background: #8D6E63;
      border-radius: 2px 2px 0 0;
    }
    .b-house .window {
      position: absolute;
      top: 25px;
      width: 10px;
      height: 10px;
      background: #81D4FA;
      border: 2px solid #fff;
      border-radius: 2px;
    }
    .b-house .window.left { left: 10px; }
    .b-house .window.right { right: 10px; }

    /* === å…¬å¯“ APARTMENT === */
    .b-apartment {
      width: 45px;
      height: 70px;
    }
    .b-apartment .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 45px;
      height: 70px;
      background: linear-gradient(135deg, #90CAF9 0%, #64B5F6 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-apartment .window-row {
      position: absolute;
      left: 5px;
      right: 5px;
      display: flex;
      justify-content: space-between;
    }
    .b-apartment .window-row:nth-child(2) { top: 8px; }
    .b-apartment .window-row:nth-child(3) { top: 24px; }
    .b-apartment .window-row:nth-child(4) { top: 40px; }
    .b-apartment .win {
      width: 12px;
      height: 12px;
      background: #FFF9C4;
      border-radius: 2px;
    }
    .b-apartment .door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 16px;
      background: #5D4037;
      border-radius: 2px 2px 0 0;
    }

    /* === è±ªå®… MANSION === */
    .b-mansion {
      width: 65px;
      height: 65px;
    }
    .b-mansion .body {
      position: absolute;
      bottom: 0;
      left: 5px;
      width: 55px;
      height: 45px;
      background: linear-gradient(135deg, #CE93D8 0%, #BA68C8 100%);
      border-radius: 4px;
    }
    .b-mansion .roof {
      position: absolute;
      top: 5px;
      left: 0;
      width: 65px;
      height: 20px;
      background: #7B1FA2;
      clip-path: polygon(10% 100%, 0% 0%, 100% 0%, 90% 100%);
    }
    .b-mansion .tower {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 15px;
      height: 25px;
      background: #9C27B0;
      border-radius: 3px 3px 0 0;
    }
    .b-mansion .flag {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid #FFD93D;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
    }

    /* === å•†åº— SHOP === */
    .b-shop {
      width: 50px;
      height: 50px;
    }
    .b-shop .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 40px;
      background: linear-gradient(135deg, #FFCC80 0%, #FFB74D 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-shop .awning {
      position: absolute;
      top: 0;
      left: -3px;
      width: 56px;
      height: 15px;
      background: repeating-linear-gradient(90deg, #F44336 0px, #F44336 8px, #fff 8px, #fff 16px);
      border-radius: 0 0 8px 8px;
    }
    .b-shop .window-big {
      position: absolute;
      top: 18px;
      left: 5px;
      right: 5px;
      height: 18px;
      background: #E1F5FE;
      border: 2px solid #fff;
      border-radius: 2px;
    }

    /* === é¤å»³ RESTAURANT === */
    .b-restaurant {
      width: 55px;
      height: 55px;
    }
    .b-restaurant .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 55px;
      height: 45px;
      background: linear-gradient(135deg, #A5D6A7 0%, #81C784 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-restaurant .sign {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 35px;
      height: 15px;
      background: #C62828;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .b-restaurant .window-big {
      position: absolute;
      top: 18px;
      left: 8px;
      right: 8px;
      height: 15px;
      background: #FFF8E1;
      border: 2px solid #fff;
      border-radius: 2px;
    }
    .b-restaurant .door {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 14px;
      background: #5D4037;
      border-radius: 2px 2px 0 0;
    }

    /* === é£¯åº— HOTEL === */
    .b-hotel {
      width: 55px;
      height: 80px;
    }
    .b-hotel .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 55px;
      height: 80px;
      background: linear-gradient(135deg, #FFAB91 0%, #FF8A65 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-hotel .top {
      position: absolute;
      top: 0;
      left: 15px;
      width: 25px;
      height: 10px;
      background: #E64A19;
      border-radius: 3px 3px 0 0;
    }
    .b-hotel .h-sign {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 12px;
      background: #FFD93D;
      border-radius: 2px;
      font-size: 9px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #E64A19;
    }

    /* === ç™¾è²¨ MALL === */
    .b-mall {
      width: 70px;
      height: 70px;
    }
    .b-mall .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 70px;
      height: 60px;
      background: linear-gradient(135deg, #F8BBD9 0%, #F48FB1 100%);
      border-radius: 6px 6px 0 0;
    }
    .b-mall .roof-deco {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 15px;
      background: #E91E63;
      border-radius: 8px 8px 0 0;
    }
    .b-mall .windows {
      position: absolute;
      top: 20px;
      left: 5px;
      right: 5px;
      height: 35px;
      background: #E1F5FE;
      border: 3px solid #fff;
      border-radius: 3px;
    }

    /* === å·¥å»  FACTORY === */
    .b-factory {
      width: 65px;
      height: 60px;
    }
    .b-factory .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 45px;
      background: linear-gradient(135deg, #B0BEC5 0%, #90A4AE 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-factory .chimney {
      position: absolute;
      bottom: 40px;
      right: 0;
      width: 15px;
      height: 30px;
      background: #78909C;
      border-radius: 2px 2px 0 0;
    }
    .b-factory .smoke {
      position: absolute;
      top: -15px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: #ECEFF1;
      border-radius: 50%;
      animation: smokeFloat 2s ease-in-out infinite;
    }
    @keyframes smokeFloat {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
      50% { transform: translateY(-8px) scale(1.2); opacity: 0.4; }
    }

    /* === å€‰åº« WAREHOUSE === */
    .b-warehouse {
      width: 55px;
      height: 45px;
    }
    .b-warehouse .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 55px;
      height: 35px;
      background: linear-gradient(135deg, #BCAAA4 0%, #A1887F 100%);
      border-radius: 2px;
    }
    .b-warehouse .roof {
      position: absolute;
      top: 0;
      left: 0;
      width: 55px;
      height: 12px;
      background: #795548;
      clip-path: polygon(0% 100%, 5% 0%, 95% 0%, 100% 100%);
    }
    .b-warehouse .door-big {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 25px;
      height: 25px;
      background: #5D4037;
      border-radius: 2px 2px 0 0;
    }

    /* === ç§‘æŠ€åœ’å€ TECHPARK === */
    .b-techpark {
      width: 60px;
      height: 65px;
    }
    .b-techpark .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 55px;
      background: linear-gradient(135deg, #B2EBF2 0%, #80DEEA 100%);
      border-radius: 8px 8px 0 0;
    }
    .b-techpark .glass {
      position: absolute;
      top: 10px;
      left: 5px;
      right: 5px;
      bottom: 10px;
      background: linear-gradient(135deg, #E0F7FA 0%, #B2EBF2 100%);
      border-radius: 4px;
      border: 2px solid #4DD0E1;
    }
    .b-techpark .antenna {
      position: absolute;
      top: -10px;
      right: 15px;
      width: 4px;
      height: 15px;
      background: #00ACC1;
    }
    .b-techpark .antenna::after {
      content: '';
      position: absolute;
      top: -4px;
      left: -3px;
      width: 10px;
      height: 10px;
      background: #4DD0E1;
      border-radius: 50%;
      animation: blink 1.5s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* === å…¬åœ’ PARK === */
    .b-park {
      width: 55px;
      height: 55px;
    }
    .b-park .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 55px;
      height: 15px;
      background: #A5D6A7;
      border-radius: 8px;
    }
    .b-park .tree {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
    }
    .b-park .trunk {
      width: 8px;
      height: 15px;
      background: #8D6E63;
      margin: 0 auto;
      border-radius: 2px;
    }
    .b-park .leaves {
      width: 35px;
      height: 35px;
      background: radial-gradient(circle, #81C784 0%, #66BB6A 50%, #4CAF50 100%);
      border-radius: 50%;
      margin-bottom: -5px;
    }
    .b-park .flower {
      position: absolute;
      bottom: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .b-park .flower.f1 { left: 5px; background: #FF80AB; }
    .b-park .flower.f2 { right: 5px; background: #FFD54F; }

    /* === å­¸æ ¡ SCHOOL === */
    .b-school {
      width: 65px;
      height: 55px;
    }
    .b-school .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 65px;
      height: 45px;
      background: linear-gradient(135deg, #FFF59D 0%, #FFF176 100%);
      border-radius: 4px 4px 0 0;
    }
    .b-school .roof {
      position: absolute;
      top: 0;
      left: 0;
      width: 65px;
      height: 12px;
      background: #FBC02D;
      border-radius: 4px 4px 0 0;
    }
    .b-school .clock {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      border: 2px solid #F57F17;
    }
    .b-school .windows-row {
      position: absolute;
      top: 32px;
      left: 5px;
      right: 5px;
      display: flex;
      justify-content: space-between;
    }
    .b-school .win {
      width: 14px;
      height: 12px;
      background: #E3F2FD;
      border: 2px solid #fff;
      border-radius: 2px;
    }

    /* === é†«é™¢ HOSPITAL === */
    .b-hospital {
      width: 55px;
      height: 70px;
    }
    .b-hospital .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 55px;
      height: 70px;
      background: linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%);
      border-radius: 4px 4px 0 0;
      border: 2px solid #E0E0E0;
    }
    .b-hospital .cross {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 18px;
      background: #EF5350;
      clip-path: polygon(35% 0%, 65% 0%, 65% 35%, 100% 35%, 100% 65%, 65% 65%, 65% 100%, 35% 100%, 35% 65%, 0% 65%, 0% 35%, 35% 35%);
    }
    .b-hospital .entrance {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 20px;
      background: #90CAF9;
      border-radius: 4px 4px 0 0;
    }

    /* === é«”è‚²å ´ STADIUM === */
    .b-stadium {
      width: 75px;
      height: 50px;
    }
    .b-stadium .body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 75px;
      height: 35px;
      background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%);
      border-radius: 50% 50% 4px 4px;
    }
    .b-stadium .field {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 18px;
      background: #81C784;
      border-radius: 4px;
      border: 2px solid #fff;
    }
    .b-stadium .lights {
      position: absolute;
      top: 0;
      width: 6px;
      height: 20px;
      background: #9E9E9E;
    }
    .b-stadium .lights.l1 { left: 10px; }
    .b-stadium .lights.l2 { right: 10px; }
    .b-stadium .light-top {
      position: absolute;
      top: -5px;
      left: -2px;
      width: 10px;
      height: 8px;
      background: #FFEB3B;
      border-radius: 2px;
    }

    /* === åœ°æ¨™ LANDMARK === */
    .b-landmark {
      width: 45px;
      height: 85px;
    }
    .b-landmark .base {
      position: absolute;
      bottom: 0;
      left: 5px;
      width: 35px;
      height: 25px;
      background: linear-gradient(135deg, #FFCCBC 0%, #FFAB91 100%);
      border-radius: 4px;
    }
    .b-landmark .tower {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 50px;
      background: linear-gradient(135deg, #FF8A65 0%, #FF7043 100%);
      border-radius: 2px;
    }
    .b-landmark .top {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 18px solid #E64A19;
    }
    .b-landmark .antenna {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 3px;
      height: 12px;
      background: #BF360C;
    }

    /* === å¤ªç©ºç«™ SPACEPORT === */
    .b-spaceport {
      width: 60px;
      height: 80px;
    }
    .b-spaceport .base {
      position: absolute;
      bottom: 0;
      left: 5px;
      width: 50px;
      height: 20px;
      background: linear-gradient(135deg, #B0BEC5 0%, #90A4AE 100%);
      border-radius: 4px;
    }
    .b-spaceport .rocket {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 50px;
      background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
      border-radius: 10px 10px 0 0;
    }
    .b-spaceport .rocket-top {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 15px solid #EF5350;
    }
    .b-spaceport .fin {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-top: 12px solid transparent;
      border-bottom: 0 solid transparent;
    }
    .b-spaceport .fin.left {
      left: -8px;
      border-right: 10px solid #78909C;
    }
    .b-spaceport .fin.right {
      right: -8px;
      border-left: 10px solid #78909C;
    }
    .b-spaceport .window {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      background: #4FC3F7;
      border-radius: 50%;
      border: 2px solid #0288D1;
    }
    .b-spaceport .flame {
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 20px;
      background: linear-gradient(180deg, #FF9800 0%, #FF5722 50%, transparent 100%);
      border-radius: 0 0 6px 6px;
      animation: flameFlicker 0.3s ease-in-out infinite alternate;
    }
    @keyframes flameFlicker {
      0% { transform: translateX(-50%) scaleY(1); }
      100% { transform: translateX(-50%) scaleY(0.8); }
    }


    /* æ’è¡Œæ¦œå´é‚Šæ¬„ - å¡é€šå¯æ„›é¢¨æ ¼ + å¯æ”¶åˆ */
    .side-panel {
      position: absolute;
      top: 100px;
      right: 20px;
      width: 320px;
      background: var(--bg-card);
      border-radius: 25px;
      border: 4px solid #FFD93D;
      box-shadow: 0 8px 30px rgba(255,107,157,0.2), inset 0 2px 0 rgba(255,255,255,0.8);
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    /* å¯æ”¶åˆæ’è¡Œæ¦œ */
    .leaderboard-collapsible {
      right: -300px;  /* éš±è—æ’è¡Œæ¦œé¢æ¿ */
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                  background 0.3s ease,
                  border 0.3s ease,
                  box-shadow 0.3s ease;
      background: transparent;  /* éš±è—æ™‚èƒŒæ™¯é€æ˜ */
      border: 4px solid transparent;  /* éš±è—æ™‚é€æ˜é‚Šæ¡† */
      box-shadow: none;  /* éš±è—æ™‚ç„¡é™°å½± */
    }

    .leaderboard-collapsible:hover {
      right: 20px;  /* æ‡¸åœæ™‚å®Œå…¨å±•é–‹ */
      background: var(--bg-card);  /* å±•é–‹æ™‚é¡¯ç¤ºèƒŒæ™¯ */
      border: 4px solid #FFD93D;  /* å±•é–‹æ™‚é¡¯ç¤ºé‚Šæ¡† */
      box-shadow: 0 8px 30px rgba(255,107,157,0.2), inset 0 2px 0 rgba(255,255,255,0.8);  /* å±•é–‹æ™‚é¡¯ç¤ºé™°å½± */
    }

    .leaderboard-collapsible::before {
      content: 'â˜ï¸';  /* å›ºå®šé›²æœµ */
      position: absolute;
      left: -280px;  /* é›²æœµä½ç½®ï¼Œç¢ºä¿åœ¨è¢å¹•å…§ */
      top: 50%;
      transform: translateY(-50%);
      font-size: 5rem;  /* å¤§é›²æœµ */
      background: transparent;
      padding: 0;
      border: none;
      cursor: pointer;
      z-index: 10;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.08));
      transition: all 0.3s ease;
      pointer-events: auto;
      opacity: 0.75;  /* ç¨å¾®é€æ˜ï¼Œèå…¥èƒŒæ™¯ */
    }

    /* æ»‘é¼ ç§»å…¥é›²æœµæ™‚çš„æ•ˆæœ */
    .leaderboard-collapsible:hover::before {
      transform: translateY(-50%) scale(1.1);
      filter: drop-shadow(0 3px 8px rgba(0,0,0,0.12));
      opacity: 1;  /* å±•é–‹æ™‚å®Œå…¨ä¸é€æ˜ */
    }

    .panel-title {
      font-size: 1.3rem;
      font-weight: 900;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #FF6B9D;
      border-bottom: 3px dashed #FFB6C1;
      padding-bottom: 12px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;  /* å¾ 12px 15px ç¸®å°åˆ° 8px 12px */
      margin-bottom: 6px;  /* å¾ 10px ç¸®å°åˆ° 6px */
      background: linear-gradient(135deg, #FFF5F8 0%, #FFE4EC 100%);
      border-radius: 12px;  /* å¾ 15px ç¸®å°åˆ° 12px */
      border: 2px solid #FFB6C1;  /* å¾ 3px ç¸®å°åˆ° 2px */
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      transform: translateX(-3px);
      box-shadow: 0 3px 10px rgba(255,107,157,0.25);
    }

    .leaderboard-item:nth-child(1) {
      background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
      border-color: #FFD54F;
      box-shadow: 0 4px 15px rgba(255,213,79,0.3);
    }

    .leaderboard-item:nth-child(2) {
      background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%);
      border-color: #BDBDBD;
    }

    .leaderboard-item:nth-child(3) {
      background: linear-gradient(135deg, #FFCCBC 0%, #FFAB91 100%);
      border-color: #FF8A65;
    }

    .rank {
      font-size: 1.1rem;  /* å¾ 1.4rem ç¸®å°åˆ° 1.1rem */
      font-weight: 900;
      width: 30px;  /* å¾ 40px ç¸®å°åˆ° 30px */
      text-align: center;
    }

    .rank-1 { color: #FFC107; text-shadow: 1px 1px 0 #FF8F00; }
    .rank-2 { color: #9E9E9E; text-shadow: 1px 1px 0 #616161; }
    .rank-3 { color: #FF8A65; text-shadow: 1px 1px 0 #E64A19; }

    .player-info {
      flex: 1;
      margin-left: 8px;  /* å¾ 12px ç¸®å°åˆ° 8px */
    }

    .player-name {
      font-size: 0.95rem;  /* å¾ 1.1rem ç¸®å°åˆ° 0.95rem */
      font-weight: 700;
      color: #5D4037;
    }

    .player-buildings {
      font-size: 0.75rem;  /* å¾ 0.85rem ç¸®å°åˆ° 0.75rem */
      color: #8D6E63;
      margin-top: 2px;
    }

    .player-score {
      font-size: 1.1rem;  /* å¾ 1.3rem ç¸®å°åˆ° 1.1rem */
      font-weight: 900;
      color: #FF6B9D;
      text-shadow: 1px 1px 0 rgba(255,107,157,0.3);
    }

    /* äº‹ä»¶å…¬å‘Š - å¡é€šå¯æ„›é¢¨æ ¼ */
    .event-panel {
      position: absolute;
      top: 100px;
      left: 20px;
      width: 400px;
      background: var(--bg-card);
      border-radius: 25px;
      border: 4px solid #FFD93D;
      box-shadow: 0 8px 30px rgba(255,107,157,0.2), inset 0 2px 0 rgba(255,255,255,0.8);
      padding: 22px;
      display: none;
    }

    .event-panel.show {
      display: block;
      animation: eventPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes eventPopIn {
      0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
      60% { transform: scale(1.1) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .event-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      border-bottom: 3px dashed #FFB6C1;
      padding-bottom: 15px;
    }

    .event-icon {
      font-size: 3rem;
      filter: drop-shadow(2px 3px 0 rgba(0,0,0,0.15));
      animation: eventIconWiggle 1s ease-in-out infinite;
    }

    @keyframes eventIconWiggle {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }

    .event-title {
      font-size: 1.4rem;
      font-weight: 900;
      color: #FF6B9D;
    }

    .event-type {
      font-size: 0.95rem;
      color: #8D6E63;
      font-weight: 500;
    }

    .event-description {
      font-size: 1.1rem;
      margin-bottom: 15px;
      line-height: 1.6;
      color: #5D4037;
    }

    .event-effects {
      background: linear-gradient(135deg, #FFF5F8 0%, #FFE4EC 100%);
      border-radius: 15px;
      padding: 15px;
      border: 2px solid #FFB6C1;
    }

    .effect-title {
      font-size: 0.9rem;
      color: #8D6E63;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .effect-text {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .effect-text.positive { color: #4CAF50; }
    .effect-text.negative { color: #EF5350; }

    /* çµç®—æ˜ç´°é¢æ¿ */
    .settlement-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      cursor: pointer;
    }

    .settlement-panel.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .settlement-content {
      background: var(--bg-card);
      border-radius: 25px;
      border: 4px solid #FFD93D;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      padding: 30px;
      max-width: 90%;
      max-height: 85%;
      overflow-y: auto;
      cursor: default;
      animation: settlementPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes settlementPopIn {
      0% { transform: scale(0.5) translateY(100px); opacity: 0; }
      60% { transform: scale(1.05) translateY(-10px); }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    .settlement-header {
      text-align: center;
      margin-bottom: 25px;
      border-bottom: 3px dashed #FFB6C1;
      padding-bottom: 20px;
    }

    .settlement-title {
      font-size: 2rem;
      font-weight: 900;
      color: #FF6B9D;
      margin-bottom: 10px;
    }

    .settlement-event-name {
      font-size: 1.3rem;
      color: #5D4037;
      font-weight: 600;
    }

    .settlement-hint {
      font-size: 0.9rem;
      color: #8D6E63;
      margin-top: 10px;
    }

    .settlement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .settlement-player-card {
      background: linear-gradient(135deg, #FFF5F8 0%, #FFE4EC 100%);
      border-radius: 15px;
      border: 2px solid #FFB6C1;
      padding: 15px;
      transition: all 0.3s ease;
      animation: cardSlideIn 0.5s ease backwards;
    }

    @keyframes cardSlideIn {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .settlement-player-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
    }

    .settlement-player-rank {
      font-size: 1.8rem;
      font-weight: 900;
      color: #FF6B9D;
      margin-right: 10px;
    }

    .settlement-player-rank.top-3 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .settlement-player-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #5D4037;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settlement-player-income {
      font-size: 1.5rem;
      font-weight: 900;
      color: #4CAF50;
      margin: 8px 0;
    }

    .settlement-player-income.negative {
      color: #EF5350;
    }

    .settlement-player-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #8D6E63;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #FFB6C1;
    }

    .settlement-total {
      background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 900;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.98); }
    }

    /* å»ºç¯‰çµ±è¨ˆæ¬„ - å¡é€šå¯æ„›é¢¨æ ¼ */
    .stats-panel {
      position: absolute;
      bottom: 15px;
      left: 20px;
      right: 360px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .category-badge {
      background: var(--bg-card);
      border-radius: 20px;
      border: 3px solid #4FC3F7;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      font-weight: 500;
      color: #5D4037;
    }

    .category-badge:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 8px 20px rgba(79,195,247,0.3);
      border-color: #29B6F6;
    }

    .category-badge .emoji {
      font-size: 1.5rem;
    }

    .category-badge .count {
      font-weight: 900;
      color: #FF6B9D;
      font-size: 1.2rem;
    }

    /* ===== ç­‰å¾…ç•«é¢ - å¡é€šå¯æ„›é¢¨æ ¼ ===== */
    .waiting-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg,
        #87CEEB 0%,
        #B4E7FF 30%,
        #E8F8FF 60%,
        #FFF5F8 100%
      );
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
      overflow: hidden;
    }

    .waiting-content-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 80px;
      max-width: 1600px;
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    .waiting-left-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .waiting-top-section {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 60px;
      margin-bottom: 40px;
    }

    .waiting-icon-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .waiting-logo-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .waiting-bottom-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;  /* ç¢ºä¿å¯¬åº¦èˆ‡ä¸Šæ–¹ä¸€è‡´ */
      max-width: 760px;  /* é™åˆ¶æœ€å¤§å¯¬åº¦ä»¥åŒ¹é…ä¸Šæ–¹ icon + logo çš„ç¸½å¯¬åº¦ */
    }

    .waiting-right-section {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ç­‰å¾…ç•«é¢è£é£¾ - é£„å‹•çš„æ„›å¿ƒå’Œæ˜Ÿæ˜Ÿ */
    .waiting-overlay::before {
      content: 'â¤ï¸ â­ ğŸ’– âœ¨ ğŸ’• ğŸŒŸ ğŸ’— â­ â¤ï¸ âœ¨ ğŸ’– ğŸŒŸ';
      position: absolute;
      top: 50px;
      left: 0;
      right: 0;
      font-size: 2rem;
      text-align: center;
      letter-spacing: 40px;
      animation: floatDecor 4s ease-in-out infinite;
      opacity: 0.6;
    }

    .waiting-overlay::after {
      content: 'ğŸ  ğŸ¢ ğŸª ğŸ­ ğŸ« ğŸ¥ ğŸŸï¸ ğŸ—¼ ğŸš€';
      position: absolute;
      bottom: 80px;
      left: 0;
      right: 0;
      font-size: 2.5rem;
      text-align: center;
      letter-spacing: 30px;
      animation: floatBuildings 3s ease-in-out infinite;
    }

    @keyframes floatDecor {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-15px) rotate(2deg); }
    }

    @keyframes floatBuildings {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .waiting-overlay.hidden {
      display: none;
    }

    /* ===== å°éŠæˆ²é¡¯ç¤ºå€ ===== */
    .minigame-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.95) 0%, rgba(200, 107, 250, 0.95) 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 40px;
    }

    .minigame-overlay.show {
      display: flex;
    }

    .minigame-content {
      background: var(--bg-card);
      border-radius: 32px;
      padding: 50px;
      max-width: 1400px;
      width: 95%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .minigame-title {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 30px;
      color: var(--primary);
    }

    .minigame-icon {
      font-size: 6rem;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out infinite;
    }

    /* å¿«å•å¿«ç­”æ¨£å¼ */
    .quiz-question {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 30px;
      color: var(--text);
      line-height: 1.4;
    }

    .quiz-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .quiz-option {
      background: linear-gradient(135deg, var(--info) 0%, #2196F3 100%);
      color: white;
      padding: 25px;
      border-radius: 16px;
      font-size: 1.5rem;
      font-weight: bold;
      border: none;
      cursor: not-allowed;
      box-shadow: 0 4px 12px rgba(77, 150, 255, 0.4);
    }

    .quiz-progress {
      font-size: 1.2rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .quiz-timer {
      font-size: 2rem;
      font-weight: 900;
      color: var(--danger);
    }

    /* å–å•¤é…’æ¯”è³½æ¨£å¼ */
    .beer-status {
      font-size: 1.5rem;
      margin-bottom: 30px;
      color: var(--text);
      animation: pulseText 2s ease-in-out infinite;
    }

    @keyframes pulseText {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .beer-participants {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      min-height: 120px;
    }

    .beer-waiting-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .beer-waiting-slot {
      background: rgba(255, 255, 255, 0.05);
      border: 3px dashed rgba(255, 183, 0, 0.3);
      border-radius: 16px;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      animation: breathe 2s ease-in-out infinite;
      transition: all 0.3s ease;
    }

    .beer-waiting-slot:nth-child(1) { animation-delay: 0s; }
    .beer-waiting-slot:nth-child(2) { animation-delay: 0.2s; }
    .beer-waiting-slot:nth-child(3) { animation-delay: 0.4s; }
    .beer-waiting-slot:nth-child(4) { animation-delay: 0.6s; }
    .beer-waiting-slot:nth-child(5) { animation-delay: 0.8s; }
    .beer-waiting-slot:nth-child(6) { animation-delay: 1s; }

    @keyframes breathe {
      0%, 100% {
        transform: scale(1);
        opacity: 0.5;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .beer-waiting-icon {
      font-size: 3rem;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .beer-waiting-text {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.5);
      font-weight: 600;
    }

    .beer-participant {
      background: linear-gradient(135deg, rgba(255, 183, 0, 0.2) 0%, rgba(255, 140, 0, 0.2) 100%);
      padding: 30px 20px;
      border-radius: 16px;
      font-size: 1.3rem;
      font-weight: bold;
      border: 3px solid var(--warning);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.5s ease-out, glow 2s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideIn {
      0% {
        transform: scale(0) rotate(-10deg);
        opacity: 0;
      }
      60% {
        transform: scale(1.1) rotate(5deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(255, 183, 0, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(255, 183, 0, 0.6);
      }
    }

    .beer-participant::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .beer-participant-icon {
      font-size: 2.5rem;
    }

    .beer-participant-name {
      z-index: 1;
    }

    .beer-results {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
    }

    .beer-result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      padding: 20px 30px;
      border-radius: 16px;
      font-size: 1.5rem;
    }

    .beer-result-item.rank-1 {
      border: 4px solid #ffd700;
      background: linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,215,0,0.1) 100%);
    }

    .beer-result-item.rank-2 {
      border: 4px solid #c0c0c0;
      background: linear-gradient(135deg, rgba(192,192,192,0.2) 0%, rgba(192,192,192,0.1) 100%);
    }

    .beer-rank {
      font-size: 2rem;
      font-weight: 900;
    }

    .beer-rank.rank-1 { color: #ffd700; }
    .beer-rank.rank-2 { color: #c0c0c0; }
    .beer-rank.rank-3 { color: #cd7f32; }

    /* æ¯”å¤§å°æ¨£å¼ - å·¦å³ä½ˆå±€ */
    .poker-game-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      min-height: 0;
      max-height: calc(100vh - 60px);
      overflow: hidden;
    }

    /* å·¦å´ï¼šæ¨™é¡Œ+æ’²å…‹ç‰Œ */
    .poker-left-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
      border-radius: 24px;
      padding: 40px;
      border: 3px solid rgba(102, 126, 234, 0.3);
    }

    .poker-game-title {
      font-size: 2.8rem;
      font-weight: 900;
      color: var(--text);
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .poker-round-info {
      font-size: 1.5rem;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .poker-timer {
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--warning);
      margin-bottom: 20px;
      animation: timerPulse 1s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .poker-timer.urgent {
      color: var(--danger);
      animation: timerUrgent 0.5s ease-in-out infinite;
    }

    @keyframes timerUrgent {
      0%, 100% { transform: scale(1); color: var(--danger); }
      50% { transform: scale(1.1); color: #ff0000; }
    }

    .poker-card-back {
      width: 180px;
      height: 250px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      margin: 20px auto;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      border: 4px solid rgba(255,255,255,0.3);
      animation: cardFloat 3s ease-in-out infinite;
    }

    @keyframes cardFloat {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-12px) rotate(2deg); }
    }

    /* é–‹ç‰Œä¸­æ“ç‰Œå‹•ç•« */
    .poker-card-shuffling {
      width: 180px;
      height: 250px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      margin: 20px auto;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      border: 4px solid rgba(255,255,255,0.3);
      animation: cardShuffle 0.3s ease-in-out infinite;
    }

    @keyframes cardShuffle {
      0% { transform: translateY(-15px) rotate(-5deg); }
      25% { transform: translateY(10px) rotate(3deg); }
      50% { transform: translateY(-10px) rotate(-3deg); }
      75% { transform: translateY(15px) rotate(5deg); }
      100% { transform: translateY(-15px) rotate(-5deg); }
    }

    .poker-revealing-text {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--warning);
      margin-top: 20px;
      animation: textPulse 0.8s ease-in-out infinite;
    }

    @keyframes textPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.05); }
    }

    .poker-card {
      width: 200px;
      height: 280px;
      background: white;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 20px auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      border: 5px solid #333;
      position: relative;
      animation: cardReveal 0.8s ease-out;
    }

    @keyframes cardReveal {
      0% { transform: rotateY(90deg) scale(0.8); opacity: 0; }
      50% { transform: rotateY(45deg) scale(1); }
      100% { transform: rotateY(0deg) scale(1); opacity: 1; }
    }

    .poker-card.red { color: #e74c3c; }
    .poker-card.black { color: #2c3e50; }

    .poker-card-value {
      font-size: 5rem;
      font-weight: 900;
      line-height: 1;
    }

    .poker-card-suit {
      font-size: 2.5rem;
      margin-top: 8px;
    }

    .poker-card-corner {
      position: absolute;
      font-size: 1.3rem;
      font-weight: bold;
      line-height: 1.2;
    }

    .poker-card-corner.top-left { top: 10px; left: 10px; }
    .poker-card-corner.bottom-right { bottom: 10px; right: 10px; transform: rotate(180deg); }

    .poker-result-badge {
      font-size: 2.2rem;
      font-weight: 900;
      padding: 15px 40px;
      border-radius: 16px;
      margin-top: 20px;
      animation: resultPop 0.5s ease-out;
    }

    @keyframes resultPop {
      0% { transform: scale(0); }
      60% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .poker-result-badge.big {
      color: var(--success);
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.2) 0%, rgba(72, 219, 251, 0.2) 100%);
      border: 3px solid var(--success);
    }

    .poker-result-badge.small {
      color: var(--danger);
      background: linear-gradient(135deg, rgba(250, 130, 49, 0.2) 0%, rgba(247, 183, 51, 0.2) 100%);
      border: 3px solid var(--danger);
    }

    .poker-result-badge.tie {
      color: #95a5a6;
      background: linear-gradient(135deg, rgba(149, 165, 166, 0.2) 0%, rgba(127, 140, 141, 0.2) 100%);
      border: 3px solid #95a5a6;
    }

    .poker-rule-hint {
      font-size: 1.2rem;
      color: var(--text-muted);
      margin-top: 15px;
    }

    /* å³å´ï¼šä¸‹æ³¨å€ */
    .poker-right-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .poker-bet-section {
      flex: 1;
      background: var(--bg);
      padding: 25px;
      border-radius: 20px;
      border: 4px solid transparent;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .poker-bet-section.big {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.15) 0%, rgba(72, 219, 251, 0.15) 100%);
    }

    .poker-bet-section.small {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(250, 130, 49, 0.15) 0%, rgba(247, 183, 51, 0.15) 100%);
    }

    .poker-bet-section.winner {
      animation: winnerGlow 1s ease-in-out infinite;
    }

    @keyframes winnerGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(46, 213, 115, 0.5); }
      50% { box-shadow: 0 0 40px rgba(46, 213, 115, 0.8); }
    }

    .poker-bet-section.loser {
      opacity: 0.7;
      position: relative;
    }

    .poker-bet-section.loser::after {
      content: 'ğŸº';
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 2.5rem;
      animation: drinkBounce 1s ease-in-out infinite;
    }

    @keyframes drinkBounce {
      0%, 100% { transform: translateY(0) rotate(-10deg); }
      50% { transform: translateY(-10px) rotate(10deg); }
    }

    .poker-bet-title {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .poker-bet-title.big { color: var(--success); }
    .poker-bet-title.small { color: var(--danger); }

    .poker-bet-count {
      font-size: 1rem;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: auto;
    }

    .poker-bet-players {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-content: flex-start;
      overflow-y: auto;
      max-height: 250px;
    }

    .poker-bet-player {
      background: rgba(255, 255, 255, 0.15);
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      animation: playerJoin 0.4s ease-out;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes playerJoin {
      0% { transform: scale(0); opacity: 0; }
      60% { transform: scale(1.15); }
      100% { transform: scale(1); opacity: 1; }
    }

    .poker-bet-player.winner {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.3) 0%, rgba(72, 219, 251, 0.3) 100%);
      border: 2px solid var(--success);
    }

    .poker-bet-player.winner::after {
      content: ' ğŸ† +100';
      color: var(--warning);
      font-weight: bold;
    }

    .poker-bet-player.loser::after {
      content: ' ğŸ»';
    }

    .poker-no-bets {
      color: var(--text-muted);
      font-size: 1.1rem;
      text-align: center;
      padding: 30px;
    }

    /* ç­‰å¾…ä¸‹ä¸€å±€ç‹€æ…‹ */
    .poker-waiting-next {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 1.3rem;
    }

    /* çŒœæ­Œæ›²å‰å¥æ¨£å¼ */
    .song-guess-container {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 30px;
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 30px;
      height: 100vh;
      box-sizing: border-box;
    }

    .song-info {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.2) 0%, rgba(142, 68, 173, 0.2) 100%);
      padding: 40px;
      border-radius: 20px;
      border: 3px solid rgba(155, 89, 182, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: fit-content;
    }

    .song-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      animation: musicBounce 1.5s ease-in-out infinite;
    }

    @keyframes musicBounce {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .song-title {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .song-status {
      font-size: 1.5rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .song-answer-display {
      font-size: 3rem;
      font-weight: 900;
      color: var(--success);
      margin-top: 30px;
      padding: 20px 40px;
      background: rgba(46, 213, 115, 0.2);
      border-radius: 16px;
      border: 3px solid var(--success);
      animation: answerPop 0.5s ease-out;
    }

    @keyframes answerPop {
      0% { transform: scale(0); opacity: 0; }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .song-players-section {
      background: var(--bg);
      padding: 30px;
      border-radius: 20px;
      border: 3px solid rgba(155, 89, 182, 0.3);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      overflow: hidden;
    }

    .song-players-title {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .song-players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      overflow-y: auto;
      flex: 1;
      padding-right: 10px;
    }

    .song-players-grid::-webkit-scrollbar {
      width: 8px;
    }

    .song-players-grid::-webkit-scrollbar-track {
      background: rgba(155, 89, 182, 0.1);
      border-radius: 4px;
    }

    .song-players-grid::-webkit-scrollbar-thumb {
      background: rgba(155, 89, 182, 0.5);
      border-radius: 4px;
    }

    .song-players-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(155, 89, 182, 0.7);
    }

    .song-player-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      animation: playerFadeIn 0.4s ease-out;
      min-height: 60px;
    }

    .song-player-item.not-submitted {
      opacity: 0.6;
      border-color: rgba(255, 255, 255, 0.1);
    }

    @keyframes playerFadeIn {
      0% { transform: translateX(-20px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .song-player-item.submitted {
      border-color: var(--warning);
      background: rgba(241, 196, 15, 0.25);
      opacity: 1;
    }

    .song-player-item.correct {
      border-color: var(--success);
      background: rgba(46, 213, 115, 0.25);
      opacity: 1;
    }

    .song-player-item.wrong {
      border-color: var(--danger);
      background: rgba(231, 76, 60, 0.25);
      opacity: 1;
    }

    .song-player-name {
      font-size: 1.3rem;
      font-weight: 600;
      flex: 1;
    }

    .song-player-status {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .song-player-answer {
      font-size: 1rem;
      color: var(--text-muted);
      margin-top: 5px;
      font-style: italic;
    }

    .waiting-logo {
      font-size: 9rem;  /* ç¸®å°è·³å‹• icon å¾ 12rem åˆ° 9rem */
      margin: 0;
      filter: drop-shadow(6px 8px 0 rgba(255,107,157,0.4));
      animation: logoHop 0.8s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }

    @keyframes logoHop {
      0%, 100% { transform: translateY(0) scale(1) rotate(-3deg); }
      50% { transform: translateY(-30px) scale(1.08) rotate(3deg); }
    }

    .waiting-logo-img {
      max-width: 600px;  /* æ”¾å¤§ Logo å¾ 500px åˆ° 600px */
      width: 100%;
      height: auto;
      margin: 0;
      filter: drop-shadow(6px 8px 0 rgba(255,107,157,0.25));
      position: relative;
      z-index: 1;
    }

    .waiting-title {
      font-size: 3.5rem;  /* å¾ 3rem æ”¾å¤§åˆ° 3.5rem */
      font-weight: 900;
      color: #FF6B9D;
      text-shadow: 4px 4px 0 #fff, 8px 8px 0 rgba(255,107,157,0.3);
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
      letter-spacing: 6px;
    }

    .waiting-subtitle {
      font-size: 2.2rem;  /* æ”¾å¤§å‰¯æ¨™é¡Œ */
      color: #8B5A8B;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
      font-weight: 700;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
    }

    .waiting-players {
      font-size: 1.3rem;
      color: #5D4037;
      position: relative;
      z-index: 1;
      background: var(--bg-card);
      padding: 25px 50px;
      border-radius: 25px;
      border: 4px solid #FFD93D;
      box-shadow: 0 8px 30px rgba(255,107,157,0.2);
      font-weight: 500;
      text-align: center;
      margin-bottom: 20px;
    }

    .waiting-players span {
      color: #FF6B9D;
      font-weight: 900;
      font-size: 2.5rem;
    }

    .waiting-qr-section {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-hint {
      padding: 30px 60px;
      background: var(--bg-card);
      border-radius: 30px;
      border: 4px solid #4FC3F7;
      box-shadow: 0 8px 30px rgba(79,195,247,0.2);
      text-align: center;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 500px;
    }

    .qr-hint p {
      color: #5D4037;
      margin-bottom: 18px;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .qr-url {
      font-size: 1.4rem;
      font-weight: 900;
      color: #4FC3F7;
    }

    /* ===== çµæŸç•«é¢ - å¡é€šå¯æ„›é¢¨æ ¼ ===== */
    .end-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg,
        #FFE4EC 0%,
        #FFF5F8 30%,
        #E8F8FF 60%,
        #E1F5FE 100%
      );
      display: none;
      flex-direction: column;
      padding: 20px 30px 0 30px;
      z-index: 100;
      overflow-y: auto;
    }

    .end-overlay.show {
      display: flex;
    }

    .end-title {
      font-size: 2.8rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 15px;
      margin-top: 10px;
      color: #FF6B9D;
      text-shadow: 3px 3px 0 #fff, 6px 6px 0 rgba(255,107,157,0.3);
      animation: celebrateBounce 1s ease-in-out infinite;
    }

    @keyframes celebrateBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    /* åº•éƒ¨å»ºç¯‰å±•ç¤ºå€åŸŸ */
    .end-buildings-display {
      width: 100vw;
      margin-left: calc(-50vw + 50%);
      height: 80px;
      position: relative;
      margin-top: auto;
      overflow: visible;
    }

    .final-city-ground {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 25px;
      background: linear-gradient(180deg, #8BC34A 0%, #689F38 100%);
      border-top: 3px solid #9CCC65;
    }

    .final-buildings {
      position: absolute;
      bottom: 25px;
      left: 0;
      right: 0;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      gap: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: visible;
      padding: 0 10px 0 10px;
      z-index: 10;
    }

    .final-buildings .building {
      flex-shrink: 0;
      opacity: 1 !important;
      visibility: visible !important;
      transform-origin: bottom center;
    }

    .final-buildings .building-owner {
      background: rgba(255, 255, 255, 0.95);
      padding: 1px 3px;
      border-radius: 3px;
      border: 1px solid #667eea;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      font-size: 0.5rem !important;
      white-space: nowrap;
      max-width: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .final-buildings::-webkit-scrollbar {
      height: 6px;
    }

    .final-buildings::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
    }

    .final-buildings::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 3px;
    }

    .final-buildings::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.8);
    }

    /* ===== çµæŸç•«é¢å½±ç‰‡èˆ‡æ–‡æ¡ˆå€åŸŸ ===== */
    .end-video-section {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      background: linear-gradient(135deg, rgba(255,107,157,0.1) 0%, rgba(79,195,247,0.1) 100%);
      border-radius: 25px;
      padding: 25px;
      border: 3px solid rgba(255,215,61,0.5);
      margin-bottom: 20px;
    }

    .end-video-container {
      flex: 1;
      max-width: 500px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      border: 4px solid #FFD93D;
    }

    .end-video-container video {
      width: 100%;
      height: auto;
      display: block;
    }

    .end-slogan {
      flex: 1;
      text-align: center;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .end-slogan-logo {
      width: 380px;
      height: auto;
      margin-bottom: 30px;
      opacity: 0;
      animation: logoEntrance 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
    }

    @keyframes logoEntrance {
      0% {
        opacity: 0;
        transform: scale(0.5) translateY(-50px);
      }
      60% {
        transform: scale(1.1) translateY(0);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .end-slogan p {
      font-size: 2rem;
      font-weight: 600;
      color: #2C3E50;
      margin: 12px 0;
      letter-spacing: 1px;
      opacity: 0;
      animation: slideInLeft 0.8s ease-out forwards;
    }

    .end-slogan p:nth-child(2) {
      animation-delay: 0.4s;
    }

    .end-slogan p:nth-child(3) {
      animation-delay: 0.7s;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .end-slogan .highlight {
      font-size: 3.2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
      line-height: 1.4;
      padding: 10px 0;
      animation: slideInLeft 0.8s ease-out forwards, gradientShift 3s ease-in-out infinite;
      animation-delay: 0.7s, 1.5s;
    }

    @keyframes gradientShift {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }

    .final-leaderboard h2 {
      margin-bottom: 20px;
      color: #FF6B9D;
      font-weight: 900;
      font-size: 1.5rem;
    }

    /* ===== é ’çç•«é¢ - ç´«é‡‘é…è‰²åœ“å½¢è½‰ç›¤é¢¨æ ¼ ===== */
    .lottery-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 30%, #1a1a2e 60%, #0f0f1a 100%);
      display: none;
      z-index: 200;
      overflow: hidden;
    }

    .lottery-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 30%, rgba(138,43,226,0.3) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(255,215,0,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(147,112,219,0.15) 0%, transparent 60%);
      animation: auroraShift 8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes auroraShift {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    .lottery-overlay.show {
      display: flex;
    }

    /* é ’çä¸»è¦ä½ˆå±€ */
    .lottery-main-layout {
      display: flex;
      width: 100%;
      height: 100%;
      padding: 15px 20px;
      gap: 20px;
      overflow: hidden;
    }

    /* å·¦å´å€åŸŸï¼šè½‰ç›¤ + å¾—çè€…é¡¯ç¤º */
    .lottery-left-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      padding-top: 10px;
      overflow: hidden;
    }

    .lottery-title {
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 30%, #ffd700 60%, #daa520 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      filter: drop-shadow(0 4px 15px rgba(255,215,0,0.5));
      animation: lotteryTitleBounce 2s ease-in-out infinite;
      font-family: 'Noto Sans TC', "Microsoft JhengHei", sans-serif;
      letter-spacing: 0.1em;
      z-index: 10;
      flex-shrink: 0;
    }

    @keyframes lotteryTitleBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-5px) scale(1.02); }
    }

    .lottery-prize-label {
      font-size: 1.1rem;
      color: #ffd700;
      font-weight: 700;
      background: rgba(30,20,50,0.9);
      padding: 8px 25px;
      border-radius: 30px;
      border: 3px solid #9370db;
      box-shadow: 0 4px 20px rgba(147,112,219,0.4);
      flex-shrink: 0;
    }

    /* åœ“å½¢è½‰ç›¤å®¹å™¨ - ç¢ºä¿æ­£åœ“å½¢ */
    .lottery-wheel-container {
      position: relative;
      width: 320px;
      height: 320px;
      flex-shrink: 0;
    }

    /* åœ“å½¢è½‰ç›¤ - å¼·åˆ¶æ­£åœ“å½¢ */
    .lottery-wheel {
      width: 320px;
      height: 320px;
      border-radius: 50%;
      aspect-ratio: 1 / 1;
      background: conic-gradient(
        from 0deg,
        #8b5cf6 0deg 30deg,
        #ffd700 30deg 60deg,
        #a855f7 60deg 90deg,
        #fbbf24 90deg 120deg,
        #7c3aed 120deg 150deg,
        #f59e0b 150deg 180deg,
        #8b5cf6 180deg 210deg,
        #ffd700 210deg 240deg,
        #a855f7 240deg 270deg,
        #fbbf24 270deg 300deg,
        #7c3aed 300deg 330deg,
        #f59e0b 330deg 360deg
      );
      border: 8px solid #ffd700;
      box-shadow:
        0 0 0 6px #9370db,
        0 0 60px rgba(147,112,219,0.6),
        0 0 100px rgba(255,215,0,0.3),
        inset 0 0 40px rgba(255,255,255,0.2);
      position: relative;
      transition: transform 0.1s linear;
    }

    .lottery-wheel.spinning {
      animation: wheelSpin 0.5s linear infinite;
    }

    .lottery-wheel.stopping {
      transition: transform 2s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    }

    @keyframes wheelSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* è½‰ç›¤ä¸­å¿ƒ */
    .lottery-wheel-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, #2d1b4e 0%, #1a1a2e 50%, #2d1b4e 100%);
      border-radius: 50%;
      border: 5px solid #ffd700;
      box-shadow:
        0 5px 30px rgba(255,215,0,0.5),
        inset 0 2px 15px rgba(147,112,219,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .lottery-wheel-center-text {
      font-size: 1rem;
      font-weight: 900;
      color: #ffd700;
      text-align: center;
      line-height: 1.2;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }

    /* éš±è—è½‰ç›¤ä¸Šçš„åå­— */
    .lottery-wheel-names {
      display: none;
    }

    .lottery-wheel-name {
      display: none;
      transform: translateX(-50%);
    }

    /* æŒ‡é‡ */
    .lottery-pointer {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .lottery-pointer::before {
      content: '';
      display: block;
      width: 0;
      height: 0;
      border-left: 28px solid transparent;
      border-right: 28px solid transparent;
      border-top: 50px solid #ffd700;
      filter: drop-shadow(0 4px 15px rgba(255,215,0,0.8));
    }

    .lottery-pointer::after {
      content: 'â™¦';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1rem;
      color: #9370db;
    }

    /* å¾—çè€…é¡¯ç¤ºå€ */
    .lottery-winner-display {
      text-align: center;
      min-height: 150px;
      background: linear-gradient(135deg, rgba(45,27,78,0.95) 0%, rgba(26,26,46,0.95) 100%);
      border-radius: 30px;
      padding: 25px 50px;
      border: 4px solid #ffd700;
      box-shadow:
        0 10px 50px rgba(255,215,0,0.3),
        0 0 30px rgba(147,112,219,0.3),
        inset 0 2px 15px rgba(255,215,0,0.1);
      position: relative;
      max-width: 700px;
      width: 100%;
    }

    .lottery-winner-display::before,
    .lottery-winner-display::after {
      content: 'âœ¨';
      position: absolute;
      top: -15px;
      font-size: 2rem;
      animation: sparkle 1.5s ease-in-out infinite;
    }

    .lottery-winner-display::before {
      left: 30px;
    }

    .lottery-winner-display::after {
      right: 30px;
      animation-delay: 0.5s;
    }

    @keyframes sparkle {
      0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.2) rotate(15deg); opacity: 0.7; }
    }

    .lottery-winner-rank {
      font-size: 1.8rem;
      font-weight: 900;
      color: #ffd700;
      margin-bottom: 8px;
      text-shadow: 0 0 15px rgba(255,215,0,0.5);
    }

    /* åå­—å’Œç©åˆ†åœ¨åŒä¸€è¡Œ */
    .lottery-winner-info {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .lottery-winner-name {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd700 0%, #fff 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 4px 10px rgba(255,215,0,0.5));
      animation: winnerCelebrate 0.8s ease-in-out infinite alternate;
    }

    @keyframes winnerCelebrate {
      0% { transform: scale(1); }
      100% { transform: scale(1.03); }
    }

    .lottery-winner-score {
      font-size: 1.8rem;
      color: #dda0dd;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(221,160,221,0.5);
    }

    .lottery-hint {
      font-size: 1.2rem;
      color: #fff;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(147,112,219,0.3) 0%, rgba(45,27,78,0.5) 100%);
      padding: 12px 35px;
      border-radius: 50px;
      border: 3px solid #9370db;
      box-shadow: 0 4px 20px rgba(147,112,219,0.4);
    }

    /* å³å´å€åŸŸï¼šå·²å¾—çè€…åˆ—è¡¨ */
    .lottery-winners-list {
      width: 340px;
      height: calc(100vh - 60px);
      background: linear-gradient(135deg, rgba(45,27,78,0.95) 0%, rgba(26,26,46,0.95) 100%);
      border-radius: 25px;
      padding: 25px;
      overflow-y: auto;
      border: 4px solid #9370db;
      box-shadow:
        0 10px 50px rgba(147,112,219,0.4),
        inset 0 2px 15px rgba(255,215,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .lottery-winners-list h3 {
      color: #ffd700;
      font-size: 1.4rem;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 900;
      padding-bottom: 15px;
      border-bottom: 3px dashed #9370db;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }

    #lottery-winners-container {
      flex: 1;
      overflow-y: auto;
    }

    .lottery-winner-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, rgba(147,112,219,0.2) 0%, rgba(45,27,78,0.3) 100%);
      border-radius: 15px;
      border: 2px solid rgba(147,112,219,0.5);
      box-shadow: 0 3px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .lottery-winner-item:hover {
      transform: translateX(-5px);
      box-shadow: 0 5px 20px rgba(255,215,0,0.3);
      border-color: #ffd700;
    }

    .lottery-winner-item .rank {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, #9370db 0%, #7c3aed 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
      color: white;
      box-shadow: 0 3px 15px rgba(147,112,219,0.5);
      flex-shrink: 0;
    }

    .lottery-winner-item .rank.gold {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #5c4000;
      box-shadow: 0 3px 20px rgba(255,215,0,0.7);
    }

    .lottery-winner-item .rank.silver {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
      color: #4a4a4a;
      box-shadow: 0 3px 15px rgba(192,192,192,0.5);
    }

    .lottery-winner-item .rank.bronze {
      background: linear-gradient(135deg, #cd7f32 0%, #e69955 100%);
      color: white;
      box-shadow: 0 3px 15px rgba(205,127,50,0.5);
    }

    .lottery-winner-item .winner-info {
      flex: 1;
      margin-left: 12px;
    }

    .lottery-winner-item .winner-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: #fff;
    }

    .lottery-winner-item .winner-score {
      font-size: 0.9rem;
      color: #dda0dd;
      font-weight: 600;
    }

    /* å½©å¸¶å‹•ç•« - ç´«é‡‘é…è‰² */
    .lottery-confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 100;
    }

    .confetti-piece {
      position: absolute;
      width: 12px;
      height: 12px;
      opacity: 0;
      border-radius: 3px;
    }

    .confetti-piece.animate {
      animation: confettiFall 4s ease-out forwards;
    }

    @keyframes confettiFall {
      0% {
        opacity: 1;
        transform: translateY(-100px) rotate(0deg) scale(1);
      }
      50% {
        opacity: 0.9;
        transform: translateY(50vh) rotate(360deg) scale(1.1);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg) scale(0.5);
      }
    }

    /* éš±è—èˆŠçš„è½‰ç›¤ç›¸é—œå…ƒç´  */
    .lottery-spinner,
    .lottery-names-track,
    .lottery-pointer-bottom {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="display-container">
    <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
    <div class="top-bar">
      <div class="game-title">
        <img src="https://firebasestorage.googleapis.com/v0/b/christmas-tree-3fe6b.firebasestorage.app/o/logo%2F%E8%B3%87%E7%94%A2%2072.png?alt=media&token=54bd80ed-9c24-48fc-8a11-19aa95542d13" alt="Logo" class="logo">
        <div class="title-text">
          <h1>å‰µæ™ºå‹•èƒ½ 2026</h1>
          <p class="slogan">âœ¨ çœ¾å¿—æˆåŸãƒ»ç¯‰å¤¢æˆçœŸ âœ¨</p>
        </div>
      </div>

      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-value" id="total-buildings">0</div>
          <div class="stat-label">å»ºç¯‰ç¸½æ•¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="total-players">0</div>
          <div class="stat-label">åƒèˆ‡äººæ•¸</div>
        </div>
      </div>

      <div class="status-badge waiting" id="status-badge">ç­‰å¾…ä¸­</div>
    </div>

    <!-- åŸå¸‚å€åŸŸ -->
    <div class="city-area">
      <!-- å¤©ç©º -->
      <div class="sky"></div>
      <div class="stars"></div>

      <!-- å¤ªé™½ -->
      <div class="sun"></div>

      <!-- é›²æœµ -->
      <div class="clouds">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
      </div>

      <!-- åœ°é¢ -->
      <div class="ground-area"></div>

      <!-- äººè¡Œé“ -->
      <div class="sidewalk"></div>

      <!-- é“è·¯ -->
      <div class="road"></div>

      <!-- å»ºç¯‰ç‰© -->
      <div class="buildings-container" id="buildings-container">
        <!-- å‹•æ…‹ç”Ÿæˆå»ºç¯‰ -->
      </div>

      <!-- äº‹ä»¶å…¬å‘Š -->
      <div class="event-panel" id="event-panel" onclick="showSettlement()" style="cursor: pointer;">
        <div class="event-header">
          <span class="event-icon" id="event-icon">ğŸ“¢</span>
          <div>
            <div class="event-type" id="event-type">äº‹ä»¶</div>
            <div class="event-title" id="event-title">--</div>
          </div>
        </div>
        <div class="event-description" id="event-description">--</div>
        <div class="event-effects">
          <div class="effect-title">ç‡Ÿæ”¶åŠ æˆï¼ˆé‡‘å¹£ï¼‰</div>
          <div class="effect-text" id="event-effects">--</div>
        </div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #FF6B9D; font-weight: 700; animation: pulse 1.5s ease-in-out infinite;">
          ğŸ‘† é»æ“ŠæŸ¥çœ‹æœ¬æ¬¡çµç®—æ˜ç´°
        </div>
      </div>

      <!-- çµç®—æ˜ç´°é¢æ¿ -->
      <div class="settlement-panel" id="settlement-panel" onclick="hideSettlement()">
        <div class="settlement-content" onclick="event.stopPropagation()">
          <div class="settlement-header">
            <div class="settlement-title">ğŸ“Š æœ¬æ¬¡äº‹ä»¶çµç®—æ˜ç´°</div>
            <div class="settlement-event-name" id="settlement-event-name">--</div>
            <div class="settlement-hint">é»æ“Šå¤–éƒ¨å€åŸŸé—œé–‰</div>
          </div>
          <div class="settlement-grid" id="settlement-grid">
            <!-- å‹•æ…‹ç”Ÿæˆç©å®¶çµç®—å¡ç‰‡ -->
          </div>
          <div class="settlement-total" id="settlement-total-display">
            <!-- å‹•æ…‹ç”Ÿæˆç¸½è¨ˆè³‡è¨Š -->
          </div>
        </div>
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div class="side-panel leaderboard-collapsible">
        <div class="panel-title">ğŸ† ç©åˆ†æ’è¡Œæ¦œ</div>
        <div id="leaderboard">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- å»ºç¯‰çµ±è¨ˆ -->
      <div class="stats-panel" id="stats-panel">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- ç­‰å¾…ç•«é¢ -->
  <div class="waiting-overlay" id="waiting-overlay">
    <div class="waiting-content-wrapper">
      <!-- å·¦åŠéƒ¨ï¼šIcon + Logo + å‰¯æ¨™é¡Œ + ç©å®¶æ•¸ -->
      <div class="waiting-left-section">
        <!-- ä¸Šæ–¹ï¼šè·³å‹• iconï¼ˆå·¦ï¼‰+ Logoï¼ˆå³ï¼‰ -->
        <div class="waiting-top-section">
          <div class="waiting-icon-wrapper">
            <div class="waiting-logo">ğŸ—ï¸</div>
          </div>
          <div class="waiting-logo-wrapper">
            <img src="https://firebasestorage.googleapis.com/v0/b/christmas-tree-3fe6b.firebasestorage.app/o/logo%2F%E8%B3%87%E7%94%A2%2071.png?alt=media&token=dd82561c-60dc-4ffb-b478-5c5621bfa2a0"
                 alt="å‰µæ™ºå‹•èƒ½ Logo"
                 class="waiting-logo-img">
          </div>
        </div>

        <!-- ä¸‹æ–¹ï¼šå‰¯æ¨™é¡Œ + ç©å®¶æ•¸ -->
        <div class="waiting-bottom-section">
          <div class="waiting-subtitle">âœ¨ çœ¾å¿—æˆåŸãƒ»ç¯‰å¤¢æˆçœŸ âœ¨</div>
          <div class="waiting-players">
            ç›®å‰ <span id="waiting-player-count">0</span> ä½å¤¥ä¼´å·²å°±ä½
          </div>
        </div>
      </div>

      <!-- å³åŠéƒ¨ï¼šQR Code å€åŸŸ -->
      <div class="waiting-right-section">
        <div class="qr-hint">
          <p>æƒæ QR Code æˆ–è¼¸å…¥ç¶²å€åŠ å…¥éŠæˆ²</p>
          <div id="qr-code" style="margin: 20px auto; background: white; padding: 15px; border-radius: 8px; display: inline-block;"></div>
          <div class="qr-url" id="game-url">--</div>
        </div>
      </div>
    </div>

    <!-- éŸ³æ•ˆé–‹é—œæŒ‰éˆ•ï¼ˆå›ºå®šåœ¨å³ä¸Šè§’ï¼‰ -->
    <button id="sound-toggle-btn" onclick="toggleSound()" style="
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 30px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    ">
      <span id="sound-icon">ğŸ”‡</span>
      <span id="sound-text">å•Ÿç”¨éŸ³æ•ˆ</span>
    </button>
  </div>

  <!-- é ’çç•«é¢ -->
  <div class="lottery-overlay" id="lottery-overlay">
    <div class="lottery-confetti" id="lottery-confetti"></div>

    <div class="lottery-main-layout">
      <!-- å·¦å´ï¼šè½‰ç›¤å€åŸŸ -->
      <div class="lottery-left-section">
        <div class="lottery-title">ğŸ° å¹¸é‹å¤§æŠ½ç ğŸ°</div>
        <div class="lottery-prize-label" id="lottery-prize-label">æº–å‚™æ­æ›‰å¾—çè€…...</div>

        <!-- åœ“å½¢è½‰ç›¤ -->
        <div class="lottery-wheel-container">
          <div class="lottery-pointer"></div>
          <div class="lottery-wheel" id="lottery-wheel"></div>
          <div class="lottery-wheel-center">
            <div class="lottery-wheel-center-text" id="lottery-wheel-center-text">ç­‰å¾…<br>æŠ½ç</div>
          </div>
        </div>

        <!-- å¾—çè€…é¡¯ç¤º -->
        <div class="lottery-winner-display" id="lottery-winner-display">
          <!-- ä¸­çè€…é¡¯ç¤º -->
        </div>

        <div class="lottery-hint" id="lottery-hint">ç­‰å¾…ä¸»æŒäººæ­æ›‰å¾—çè€…...</div>
      </div>

      <!-- å³å´ï¼šå·²å¾—çè€…åˆ—è¡¨ -->
      <div class="lottery-winners-list" id="lottery-winners-list">
        <h3>ğŸ† å·²æŠ½å‡ºå¾—çè€…</h3>
        <div id="lottery-winners-container">
          <p style="text-align: center; color: rgba(150,150,150,0.8); font-size: 0.9rem;">ç­‰å¾…æ­æ›‰...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- å°éŠæˆ²é¡¯ç¤ºå€ -->
  <div class="minigame-overlay" id="minigame-overlay">
    <div class="minigame-content" id="minigame-content">
      <!-- å‹•æ…‹å…§å®¹ -->
    </div>
  </div>

  <!-- çµæŸç•«é¢ -->
  <div class="end-overlay" id="end-overlay">
    <div class="end-title">ğŸ‰ å‰µæ™ºåŸ å»ºè¨­å®Œæˆï¼ğŸ‰</div>

    <!-- ä¸­é–“ï¼šå½±ç‰‡èˆ‡æ–‡æ¡ˆå€åŸŸ -->
    <div class="end-video-section">
      <div class="end-video-container">
        <video id="end-video" autoplay loop muted playsinline>
          <source src="https://firebasestorage.googleapis.com/v0/b/christmas-tree-3fe6b.firebasestorage.app/o/VIDEO%2Fgrok-video-b0490a7f-5814-4ead-b9d8-f9aa65d51e30%20(1).mp4?alt=media&token=e954da8d-33cc-4bd6-9f1b-ceddb604ab24" type="video/mp4">
        </video>
      </div>
      <div class="end-slogan">
        <img src="https://firebasestorage.googleapis.com/v0/b/christmas-tree-3fe6b.firebasestorage.app/o/logo%2F%E8%B3%87%E7%94%A2%2071.png?alt=media&token=dd82561c-60dc-4ffb-b478-5c5621bfa2a0"
             alt="å‰µæ™ºå‹•èƒ½ Logo"
             class="end-slogan-logo">
        <p>ğŸŒŸ æœªä¾†ï¼Œå¤§å®¶å„è‡ªæ‰®æ¼”ä¸åŒè§’è‰²ç™¼æ®æ‰€é•·</p>
        <p class="highlight">2026 é½Šå¿ƒå”åŠ›ï¼Œå‰µé€ å‰µæ™ºå‹•èƒ½äºå¤ªä¼æ¥­ç‰ˆåœ–ï¼</p>
      </div>
    </div>

    <!-- åº•éƒ¨ï¼šåŸå¸‚å»ºç¯‰å±•ç¤º -->
    <div class="end-buildings-display">
      <div class="final-buildings" id="final-buildings"></div>
      <div class="final-city-ground"></div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ========== éŸ³æ•ˆç³»çµ± ==========
    const SoundFX = {
      audioContext: null,
      enabled: false,
      unlocked: false,

      init() {
        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        // å˜—è©¦æ¢å¾©è¢«æš«åœçš„ AudioContext
        if (this.audioContext.state === 'suspended') {
          this.audioContext.resume();
        }
        return this.audioContext;
      },

      // è§£é–éŸ³æ•ˆï¼ˆéœ€è¦ç”¨æˆ¶äº’å‹•ï¼‰
      unlock() {
        if (this.unlocked) return;
        const ctx = this.init();
        // æ’­æ”¾ä¸€å€‹ç©ºçš„éŸ³æ•ˆä¾†è§£é–
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.value = 0; // éœéŸ³
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.001);
        this.unlocked = true;
        this.enabled = true;
        console.log('ğŸ”Š éŸ³æ•ˆç³»çµ±å·²è§£é–');
      },

      // åˆ‡æ›éŸ³æ•ˆé–‹é—œ
      toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
      },

      // æª¢æŸ¥æ˜¯å¦å¯ä»¥æ’­æ”¾
      canPlay() {
        if (!this.enabled) return false;
        if (!this.unlocked) {
          console.log('âš ï¸ éŸ³æ•ˆæœªè§£é–ï¼Œè«‹é»æ“Šã€Œå•Ÿç”¨éŸ³æ•ˆã€æŒ‰éˆ•');
          return false;
        }
        return true;
      },

      // æ™‚é–“ç·Šè¿«éŸ³æ•ˆï¼ˆå˜€å˜€è²ï¼‰
      tick(urgent = false) {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.frequency.value = urgent ? 880 : 440;
        osc.type = 'square';

        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.08);
      },

      // å€’æ•¸æœ€å¾Œ5ç§’æ€¥ä¿ƒè²
      countdown() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.frequency.value = 600;
        osc.type = 'sine';

        gain.gain.setValueAtTime(0.4, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      },

      // é–‹ç‰ŒéŸ³æ•ˆï¼ˆç·Šå¼µçš„æ“ç‰Œè²ï¼‰
      shuffling() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        // å‰µå»ºå™ªéŸ³
        const bufferSize = ctx.sampleRate * 0.1;
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
          data[i] = (Math.random() * 2 - 1) * 0.3;
        }

        const noise = ctx.createBufferSource();
        noise.buffer = buffer;

        const filter = ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 2000;

        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0.2, ctx.currentTime);

        noise.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);

        noise.start(ctx.currentTime);
      },

      // é–‹ç‰Œæ­æ›‰éŸ³æ•ˆ
      reveal() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        [400, 500, 600, 800].forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.frequency.value = freq;
          osc.type = 'sine';

          const startTime = ctx.currentTime + i * 0.08;
          gain.gain.setValueAtTime(0.3, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.2);

          osc.start(startTime);
          osc.stop(startTime + 0.2);
        });
      },

      // ç²å‹æŒè²/æ­¡å‘¼éŸ³æ•ˆ
      applause() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        // æ¨¡æ“¬æŒè²ï¼šå¤šå±¤å™ªéŸ³ + éš¨æ©Ÿè„ˆè¡
        for (let j = 0; j < 20; j++) {
          setTimeout(() => {
            const bufferSize = ctx.sampleRate * 0.05;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
              data[i] = (Math.random() * 2 - 1);
            }

            const noise = ctx.createBufferSource();
            noise.buffer = buffer;

            const filter = ctx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1500 + Math.random() * 1000;

            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.15 + Math.random() * 0.1, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.05);

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);

            noise.start(ctx.currentTime);
          }, j * 50 + Math.random() * 30);
        }

        // å‹åˆ©éŸ³éš
        const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.frequency.value = freq;
          osc.type = 'sine';

          const startTime = ctx.currentTime + i * 0.12;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.3);

          osc.start(startTime);
          osc.stop(startTime + 0.3);
        });
      },

      // å¤±æ•—/å–é…’éŸ³æ•ˆ
      loser() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        // ä¸‹é™éŸ³éš
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.frequency.setValueAtTime(400, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(150, ctx.currentTime + 0.4);
        osc.type = 'sawtooth';

        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.5);
      },

      // å’Œå±€éŸ³æ•ˆ
      tie() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.frequency.value = 440;
        osc.type = 'triangle';

        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.5);
      },

      // éŠæˆ²é–‹å§‹éŸ³æ•ˆ
      gameStart() {
        if (!this.canPlay()) return;
        const ctx = this.init();

        const notes = [262, 330, 392, 523]; // C4, E4, G4, C5
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.frequency.value = freq;
          osc.type = 'sine';

          const startTime = ctx.currentTime + i * 0.1;
          gain.gain.setValueAtTime(0.3, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.25);

          osc.start(startTime);
          osc.stop(startTime + 0.25);
        });
      },

      // ========== å¿«å•å¿«ç­”éŸ³æ•ˆ ==========

      // é¡Œç›®å‡ºç¾éŸ³æ•ˆ
      questionAppear() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const notes = [523, 659, 784]; // C5, E5, G5
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.06;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.15);
          osc.start(startTime);
          osc.stop(startTime + 0.15);
        });
      },

      // ç­”å°éŸ³æ•ˆ
      correct() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.08;
          gain.gain.setValueAtTime(0.3, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.2);
          osc.start(startTime);
          osc.stop(startTime + 0.2);
        });
      },

      // ç­”éŒ¯éŸ³æ•ˆ
      wrong() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(300, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(150, ctx.currentTime + 0.3);
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.4);
      },

      // æ™‚é–“åˆ°éŸ³æ•ˆ
      timeUp() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        [400, 300, 200].forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'square';
          const startTime = ctx.currentTime + i * 0.15;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.15);
          osc.start(startTime);
          osc.stop(startTime + 0.15);
        });
      },

      // ========== å–å•¤é…’æ¯”è³½éŸ³æ•ˆ ==========

      // ç©å®¶åŠ å…¥éŸ³æ•ˆ
      playerJoin() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      },

      // æ¯”è³½é–‹å§‹å€’æ•¸
      raceCountdown() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 440;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.4, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      },

      // æ¯”è³½é–‹å§‹ GO!
      raceGo() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.5);
      },

      // ç²å¾—åæ¬¡éŸ³æ•ˆ
      rankReveal(rank) {
        if (!this.canPlay()) return;
        const ctx = this.init();
        // ç¬¬ä¸€åæœ€é«˜éŸ³ï¼Œä¾æ¬¡é™ä½
        const baseFreq = rank === 1 ? 1047 : (rank === 2 ? 784 : 523);
        const notes = [baseFreq * 0.75, baseFreq, baseFreq * 1.25];
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.1;
          gain.gain.setValueAtTime(0.3, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.25);
          osc.start(startTime);
          osc.stop(startTime + 0.25);
        });
      },

      // é ’çé¼“è²
      drumRoll() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 100 + Math.random() * 50;
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.15, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.05);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.05);
          }, i * 50);
        }
      },

      // ========== çŒœæ­Œæ›²å‰å¥éŸ³æ•ˆ ==========

      // æ–°ä¸€å±€é–‹å§‹
      songRoundStart() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const notes = [392, 494, 587, 784]; // G4, B4, D5, G5
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.08;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.2);
          osc.start(startTime);
          osc.stop(startTime + 0.2);
        });
      },

      // ç©å®¶æäº¤ç­”æ¡ˆ
      answerSubmit() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 660;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      },

      // å…¬å¸ƒç­”æ¡ˆ
      answerReveal() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        // æˆ²åŠ‡æ€§æ­æ›‰
        const notes = [262, 330, 392, 523, 659, 784];
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.1;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.3);
          osc.start(startTime);
          osc.stop(startTime + 0.3);
        });
      },

      // éŠæˆ²çµæŸ - ç¸½çµéŸ³æ•ˆ
      gameEnd() {
        if (!this.canPlay()) return;
        const ctx = this.init();
        // çµæŸéŸ³éš
        const notes = [523, 659, 784, 1047, 784, 659, 523];
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          const startTime = ctx.currentTime + i * 0.12;
          gain.gain.setValueAtTime(0.25, startTime);
          gain.gain.linearRampToValueAtTime(0, startTime + 0.25);
          osc.start(startTime);
          osc.stop(startTime + 0.25);
        });
      }
    };

    // éŸ³æ•ˆé–‹é—œå‡½æ•¸
    function toggleSound() {
      const btn = document.getElementById('sound-toggle-btn');
      const icon = document.getElementById('sound-icon');
      const text = document.getElementById('sound-text');

      if (!SoundFX.unlocked) {
        // é¦–æ¬¡é»æ“Šï¼šè§£é–éŸ³æ•ˆç³»çµ±
        SoundFX.unlock();
        icon.textContent = 'ğŸ”Š';
        text.textContent = 'éŸ³æ•ˆå·²é–‹å•Ÿ';
        btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
        // æ’­æ”¾ä¸€å€‹æ¸¬è©¦éŸ³æ•ˆè¡¨ç¤ºå·²å•Ÿç”¨
        SoundFX.gameStart();
      } else {
        // å·²è§£é–ï¼šåˆ‡æ›é–‹é—œ
        const enabled = SoundFX.toggle();
        if (enabled) {
          icon.textContent = 'ğŸ”Š';
          text.textContent = 'éŸ³æ•ˆå·²é–‹å•Ÿ';
          btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
        } else {
          icon.textContent = 'ğŸ”‡';
          text.textContent = 'éŸ³æ•ˆå·²é—œé–‰';
          btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
      }
    }

    // éŠæˆ²è¨­å®š
    let gameConfig = null;
    let socket = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // å–å¾—è¨­å®š
      const configRes = await fetch('/api/config');
      gameConfig = await configRes.json();

      // è¨­å®šéŠæˆ²ç¶²å€ä¸¦ç”¢ç”Ÿ QR Code
      const url = window.location.origin;
      document.getElementById('game-url').textContent = url;

      // ç”¢ç”Ÿ QR Code - ç¢ºä¿ QRCode å·²è¼‰å…¥
      const generateQRCode = () => {
        if (typeof QRCode === 'undefined') {
          console.error('QRCode library not loaded yet, retrying...');
          setTimeout(generateQRCode, 100);
          return;
        }

        try {
          const qrContainer = document.getElementById('qr-code');
          if (qrContainer) {
            qrContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

            // ä½¿ç”¨ qrcodejs åº«
            new QRCode(qrContainer, {
              text: url,
              width: 200,
              height: 200,
              colorDark: '#FF6B9D',  // ç²‰ç´…è‰²ï¼Œç¬¦åˆ UI ä¸»é¡Œ
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.H
            });

            console.log('QR Code generated successfully');
          }
        } catch (error) {
          console.error('QR Code generation failed:', error);
        }
      };

      generateQRCode();

      // é€£æ¥ Socket
      socket = io();

      socket.on('connect', () => {
        console.log('[Display] Socket å·²é€£æ¥, socket.id:', socket.id);
        fetchGameState();
      });

      socket.on('disconnect', () => {
        console.log('[Display] Socket å·²æ–·ç·š');
      });

      // éŠæˆ²äº‹ä»¶
      socket.on('game:started', handleGameStarted);
      socket.on('game:buildingPhase', handleBuildingPhase);
      socket.on('game:buildingPurchased', handleBuildingPurchased);
      socket.on('game:buildingUpgraded', handleBuildingUpgraded);  // å»ºç¯‰å‡ç´šäº‹ä»¶
      socket.on('game:cityBuildingsUpdate', handleCityBuildingsUpdate);  // åŸå¸‚å»ºç¯‰æ›´æ–°ï¼ˆé“å…·ä½¿ç”¨ç­‰ï¼‰
      socket.on('game:eventTriggered', handleEventTriggered);
      socket.on('game:scoreAdded', handleScoreAdded);
      socket.on('game:ended', handleGameEnded);

      // äº’å‹•äº‹ä»¶
      socket.on('game:interactiveEventSettled', handleInteractiveEventSettled);
      socket.on('game:interactiveEventCancelled', handleInteractiveEventCancelled);
      socket.on('game:playerJoined', handlePlayerJoined);
      socket.on('game:reset', handleReset);

      // å°éŠæˆ²äº‹ä»¶ç›£è½
      socket.on('minigame:quizStarted', handleQuizStarted);
      socket.on('minigame:quizQuestion', handleQuizQuestion);
      socket.on('minigame:quizEnded', handleQuizEnded);
      socket.on('minigame:quizClosed', handleQuizClosed);

      socket.on('minigame:beerWaitingStart', handleBeerWaitingStart);
      socket.on('minigame:beerPlayerJoined', handleBeerPlayerJoined);
      socket.on('minigame:beerGameStarted', handleBeerGameStarted);
      socket.on('minigame:beerResultsSet', handleBeerResultsSet);
      socket.on('minigame:beerEnded', handleBeerEnded);

      socket.on('minigame:pokerGameStarted', handlePokerGameStarted);
      socket.on('minigame:pokerRoundStarted', handlePokerRoundStarted);
      socket.on('minigame:pokerBetPlaced', handlePokerBetPlaced);
      socket.on('minigame:pokerRevealing', handlePokerRevealing);
      socket.on('minigame:pokerRoundEnded', handlePokerRoundEnded);
      socket.on('minigame:pokerGameEnded', handlePokerGameEnded);

      socket.on('minigame:songGuessGameStarted', handleSongGuessGameStarted);
      socket.on('minigame:songGuessRoundStarted', handleSongGuessRoundStarted);
      socket.on('minigame:songGuessPlayerSubmitted', handleSongGuessPlayerSubmitted);
      socket.on('minigame:songGuessRoundEnded', handleSongGuessRoundEnded);
      socket.on('minigame:songGuessGameEnded', () => {
        document.getElementById('song-guess-overlay').style.display = 'none';
      });

      // å¼·åˆ¶çµæŸå°éŠæˆ²äº‹ä»¶
      socket.on('minigame:quizForceEnded', () => {
        document.getElementById('quiz-overlay').style.display = 'none';
      });

      socket.on('minigame:beerForceEnded', () => {
        document.getElementById('beer-game-overlay').style.display = 'none';
      });

      socket.on('minigame:pokerForceEnded', () => {
        document.getElementById('poker-game-overlay').style.display = 'none';
      });

      socket.on('minigame:songGuessForceEnded', () => {
        document.getElementById('song-guess-overlay').style.display = 'none';
      });

      // AIæ˜¯çœŸæ˜¯å‡äº‹ä»¶ç›£è½
      socket.on('minigame:aiGameStarted', (data) => {
        console.log('[Display] æ”¶åˆ° minigame:aiGameStarted äº‹ä»¶', data);
        handleAIGameStarted(data);
      });
      socket.on('minigame:aiQuestionDisplay', (data) => {
        console.log('[Display] æ”¶åˆ° minigame:aiQuestionDisplay äº‹ä»¶', data);
        handleAIQuestionDisplay(data);
      });
      socket.on('minigame:aiPlayerAnswered', (data) => {
        console.log('[Display] æ”¶åˆ° minigame:aiPlayerAnswered äº‹ä»¶', data);
        handleAIPlayerAnswered(data);
      });
      socket.on('minigame:aiAnswerRevealed', (data) => {
        console.log('[Display] æ”¶åˆ° minigame:aiAnswerRevealed äº‹ä»¶', data);
        handleAIAnswerRevealed(data);
      });
      socket.on('minigame:aiGameEnded', (data) => {
        console.log('[Display] æ”¶åˆ° minigame:aiGameEnded äº‹ä»¶', data);
        // ç«‹å³é—œé–‰ overlay
        document.getElementById('minigame-overlay').classList.remove('show');
        aiGameState.active = false;
      });
      socket.on('minigame:aiGameForceEnded', () => {
        console.log('[Display] æ”¶åˆ° minigame:aiGameForceEnded äº‹ä»¶');
        document.getElementById('minigame-overlay').classList.remove('show');
        aiGameState.active = false;
      });

      // æŠ½çäº‹ä»¶ç›£è½
      socket.on('lottery:start', (data) => {
        resetLottery();
        startLotteryMode(data.players);
      });

      socket.on('lottery:spin', () => {
        if (!isSpinning && lotteryPlayers.length > 0) {
          startSpin();
        }
      });

      socket.on('lottery:stop', () => {
        if (isSpinning) {
          stopSpin();
        }
      });

      socket.on('lottery:next', () => {
        if (!isSpinning && lotteryPlayers.length > 0) {
          document.getElementById('lottery-prize-label').textContent = `ç¬¬ ${currentPrizeIndex} ä½å¹¸é‹å…’`;
          document.getElementById('lottery-winner-display').innerHTML = '';
          buildNamesTrack();
        }
      });

      socket.on('lottery:close', () => {
        closeLotteryMode();
      });

      // é ’çäº‹ä»¶ç›£è½
      socket.on('award:start', (data) => {
        console.log('ğŸ“¢ æ”¶åˆ° award:start äº‹ä»¶', data);
        awardPlayers = data.players.sort((a, b) => (b.score || 0) - (a.score || 0));
        awardPrizeCount = data.prizeCount;
        awardWinners = [];
        currentAwardRank = 0;
        console.log('ğŸ¯ æº–å‚™é¡¯ç¤ºæŠ½çç•«é¢ï¼Œç©å®¶æ•¸:', awardPlayers.length, 'çå“æ•¸:', awardPrizeCount);
        startAwardMode();
      });

      socket.on('award:reveal', (data) => {
        if (currentAwardRank < awardPlayers.length && !isRevealing) {
          revealWinner();
        }
      });

      socket.on('award:close', () => {
        closeAwardMode();
      });
    });

    // å–å¾—éŠæˆ²ç‹€æ…‹
    async function fetchGameState() {
      const res = await fetch('/api/game/state');
      const state = await res.json();
      updateDisplay(state);
    }

    // æ›´æ–°ç•«é¢
    function updateDisplay(state) {
      // æ›´æ–°çµ±è¨ˆ
      document.getElementById('total-buildings').textContent = state.totalBuildings || 0;
      document.getElementById('total-players').textContent = state.playerCount || 0;
      document.getElementById('waiting-player-count').textContent = state.playerCount || 0;

      // æ›´æ–°ç‹€æ…‹æ¨™ç±¤
      updateStatusBadge(state.state);

      // æ›´æ–°å»ºç¯‰è¦–è¦ºåŒ–ï¼ˆä½¿ç”¨å»ºç¯‰åˆ—è¡¨ï¼‰
      renderCityBuildings(state.cityBuildings, state.cityBuildingList);

      // æ›´æ–°æ’è¡Œæ¦œ
      renderLeaderboard(state.leaderboard);

      // æª¢æŸ¥æŠ½çç‹€æ…‹ä¸¦æ¢å¾©æŠ½çç•«é¢
      if (state.lotteryState && state.lotteryState.active) {
        // å¦‚æœæŠ½çç•«é¢å·²ç¶“é¡¯ç¤ºï¼Œä¸è¦é‡æ–°åˆå§‹åŒ–ï¼ˆé¿å…é–ƒçˆï¼‰
        const lotteryOverlay = document.getElementById('lottery-overlay');
        if (lotteryOverlay && lotteryOverlay.classList.contains('show')) {
          // æŠ½çç•«é¢å·²é¡¯ç¤ºï¼Œä¸éœ€è¦é‡æ–°åˆå§‹åŒ–
          return;
        }

        console.log('ğŸ° åµæ¸¬åˆ°é€²è¡Œä¸­çš„æŠ½çï¼Œæ¢å¾©æŠ½çç•«é¢');

        // æ¢å¾©æŠ½çæ•¸æ“š
        awardPlayers = state.lotteryState.players || [];
        awardPrizeCount = state.lotteryState.prizeCount || 0;
        currentAwardRank = state.lotteryState.currentRank || 0;

        // è½‰æ› winners æ ¼å¼ï¼ˆå¾Œç«¯æ ¼å¼æ˜¯ { rank, winner }ï¼Œå‰ç«¯éœ€è¦ { id, name, score, rank }ï¼‰
        const rawWinners = state.lotteryState.winners || [];
        awardWinners = rawWinners.map(item => {
          // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼ï¼ˆæœ‰ name å±¬æ€§ï¼‰
          if (item.name !== undefined) {
            return {
              id: item.id,
              name: item.name || 'æœªçŸ¥',
              score: item.score !== undefined ? item.score : 0,
              rank: item.rank || 0
            };
          }
          // å¦‚æœæ˜¯å¾Œç«¯æ ¼å¼ï¼ˆæœ‰ winner å±¬æ€§ï¼‰
          if (item.winner) {
            return {
              id: item.winner.id,
              name: item.winner.name || 'æœªçŸ¥',
              score: item.winner.score !== undefined ? item.winner.score : 0,
              rank: item.rank || 0
            };
          }
          // å…¶ä»–æƒ…æ³ï¼Œè¿”å›å®‰å…¨çš„é è¨­å€¼
          return {
            id: item.id || 'unknown',
            name: item.name || 'æœªçŸ¥',
            score: item.score !== undefined ? item.score : 0,
            rank: item.rank || 0
          };
        });

        console.log('ğŸ“Š è½‰æ›å¾Œçš„ awardWinners:', awardWinners);

        // é¡¯ç¤ºæŠ½çç•«é¢ï¼ˆstartAwardMode å…§éƒ¨æœƒè™•ç†å¾—çè€…åˆ—è¡¨çš„æ¢å¾©ï¼‰
        startAwardMode();
      } else if (state.state === 'ENDED') {
        // éŠæˆ²å·²çµæŸä½†æ²’æœ‰æŠ½çï¼Œé¡¯ç¤ºçµæŸç•«é¢
        const endOverlay = document.getElementById('end-overlay');
        if (endOverlay && !endOverlay.classList.contains('show')) {
          const lotteryOverlay = document.getElementById('lottery-overlay');
          if (!lotteryOverlay || !lotteryOverlay.classList.contains('show')) {
            console.log('ğŸ‰ é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢');

            // éš±è—æ‰€æœ‰å¯èƒ½é¡¯ç¤ºçš„éŠæˆ²ç•«é¢
            const pokerOverlay = document.getElementById('poker-game-overlay');
            if (pokerOverlay) pokerOverlay.style.display = 'none';

            // éš±è—äº‹ä»¶é¢æ¿
            hideEvent();

            endOverlay.classList.add('show');

            // æ¸²æŸ“æœ€çµ‚åŸå¸‚å»ºç¯‰
            renderFinalBuildings(state.cityBuildingList, state.cityBuildings, state.leaderboard);
          }
        }
      }

      // é¡¯ç¤º/éš±è—ç­‰å¾…ç•«é¢
      const waitingOverlay = document.getElementById('waiting-overlay');
      if (state.state === 'WAITING') {
        waitingOverlay.classList.remove('hidden');
      } else {
        waitingOverlay.classList.add('hidden');
      }

      // é¡¯ç¤ºäº‹ä»¶
      if (state.currentEvent && state.state === 'EVENT') {
        showEvent(state.currentEvent);
      }
    }

    // æ›´æ–°ç‹€æ…‹æ¨™ç±¤
    function updateStatusBadge(state) {
      const badge = document.getElementById('status-badge');
      const stateMap = {
        'WAITING': { text: 'ç­‰å¾…ä¸­', class: 'waiting' },
        'BUILDING': { text: 'å»ºè¨­ä¸­', class: 'building' },
        'EVENT': { text: 'äº‹ä»¶ç™¼ç”Ÿ', class: 'event' },
        'ENDED': { text: 'å·²çµæŸ', class: 'ended' }
      };
      const info = stateMap[state] || stateMap.WAITING;
      badge.textContent = info.text;
      badge.className = `status-badge ${info.class}`;
    }

    // CSS å»ºç¯‰æ¨¡æ¿
    function createCSSBuilding(buildingId) {
      switch(buildingId) {
        case 'HOUSE':
          return `<div class="css-building b-house">
            <div class="roof"></div>
            <div class="body">
              <div class="window left"></div>
              <div class="window right"></div>
              <div class="door"></div>
            </div>
          </div>`;
        case 'APARTMENT':
          return `<div class="css-building b-apartment">
            <div class="body">
              <div class="window-row"><div class="win"></div><div class="win"></div><div class="win"></div></div>
              <div class="window-row"><div class="win"></div><div class="win"></div><div class="win"></div></div>
              <div class="window-row"><div class="win"></div><div class="win"></div><div class="win"></div></div>
              <div class="door"></div>
            </div>
          </div>`;
        case 'MANSION':
          return `<div class="css-building b-mansion">
            <div class="tower"><div class="flag"></div></div>
            <div class="roof"></div>
            <div class="body"></div>
          </div>`;
        case 'SHOP':
          return `<div class="css-building b-shop">
            <div class="awning"></div>
            <div class="body">
              <div class="window-big"></div>
            </div>
          </div>`;
        case 'RESTAURANT':
          return `<div class="css-building b-restaurant">
            <div class="sign">ğŸœ</div>
            <div class="body">
              <div class="window-big"></div>
              <div class="door"></div>
            </div>
          </div>`;
        case 'HOTEL':
          return `<div class="css-building b-hotel">
            <div class="top"></div>
            <div class="body">
              <div class="h-sign">H</div>
            </div>
          </div>`;
        case 'MALL':
          return `<div class="css-building b-mall">
            <div class="roof-deco"></div>
            <div class="body">
              <div class="windows"></div>
            </div>
          </div>`;
        case 'FACTORY':
          return `<div class="css-building b-factory">
            <div class="chimney"><div class="smoke"></div></div>
            <div class="body"></div>
          </div>`;
        case 'WAREHOUSE':
          return `<div class="css-building b-warehouse">
            <div class="roof"></div>
            <div class="body">
              <div class="door-big"></div>
            </div>
          </div>`;
        case 'TECHPARK':
          return `<div class="css-building b-techpark">
            <div class="antenna"></div>
            <div class="body">
              <div class="glass"></div>
            </div>
          </div>`;
        case 'PARK':
          return `<div class="css-building b-park">
            <div class="tree">
              <div class="leaves"></div>
              <div class="trunk"></div>
            </div>
            <div class="ground"></div>
            <div class="flower f1"></div>
            <div class="flower f2"></div>
          </div>`;
        case 'SCHOOL':
          return `<div class="css-building b-school">
            <div class="roof"></div>
            <div class="body">
              <div class="clock"></div>
              <div class="windows-row">
                <div class="win"></div><div class="win"></div><div class="win"></div><div class="win"></div>
              </div>
            </div>
          </div>`;
        case 'HOSPITAL':
          return `<div class="css-building b-hospital">
            <div class="body">
              <div class="cross"></div>
              <div class="entrance"></div>
            </div>
          </div>`;
        case 'STADIUM':
          return `<div class="css-building b-stadium">
            <div class="lights l1"><div class="light-top"></div></div>
            <div class="lights l2"><div class="light-top"></div></div>
            <div class="body">
              <div class="field"></div>
            </div>
          </div>`;
        case 'LANDMARK':
          return `<div class="css-building b-landmark">
            <div class="antenna"></div>
            <div class="top"></div>
            <div class="tower"></div>
            <div class="base"></div>
          </div>`;
        case 'SPACEPORT':
          return `<div class="css-building b-spaceport">
            <div class="base"></div>
            <div class="rocket">
              <div class="rocket-top"></div>
              <div class="window"></div>
              <div class="fin left"></div>
              <div class="fin right"></div>
              <div class="flame"></div>
            </div>
          </div>`;
        default:
          return `<div class="css-building b-house">
            <div class="roof"></div>
            <div class="body"><div class="door"></div></div>
          </div>`;
      }
    }

    // è¿½è¹¤ç›®å‰å»ºç¯‰ç‹€æ…‹ï¼Œé¿å…é‡è¤‡æ¸²æŸ“å°è‡´é–ƒçˆ
    let currentBuildingKey = '';

    // æ¯æ’æœ€å¤šå¹¾æ£Ÿå»ºç¯‰
    const BUILDINGS_PER_ROW = 10;

    // Debounce æ©Ÿåˆ¶ï¼šé¿å…çŸ­æ™‚é–“å…§é‡è¤‡æ¸²æŸ“
    let renderDebounceTimer = null;
    let pendingRenderData = null;

    // æ¸²æŸ“åŸå¸‚å»ºç¯‰ï¼ˆä½¿ç”¨å»ºç¯‰åˆ—è¡¨ï¼Œå«ç©å®¶åç¨±ï¼‰- å¸¶ debounce
    function renderCityBuildings(cityBuildings, buildingList) {
      // å„²å­˜å¾…æ¸²æŸ“çš„è³‡æ–™
      pendingRenderData = { cityBuildings, buildingList };

      // å¦‚æœå·²ç¶“æœ‰æ’ç¨‹ä¸­çš„æ¸²æŸ“ï¼Œè·³é
      if (renderDebounceTimer) {
        return;
      }

      // è¨­å®š debounceï¼Œ100ms å¾ŒåŸ·è¡Œå¯¦éš›æ¸²æŸ“
      renderDebounceTimer = setTimeout(() => {
        renderDebounceTimer = null;
        if (pendingRenderData) {
          doRenderCityBuildings(pendingRenderData.cityBuildings, pendingRenderData.buildingList);
          pendingRenderData = null;
        }
      }, 100);
    }

    // å¯¦éš›æ¸²æŸ“åŸå¸‚å»ºç¯‰
    function doRenderCityBuildings(cityBuildings, buildingList) {
      const container = document.getElementById('buildings-container');
      const statsPanel = document.getElementById('stats-panel');

      // åªä½¿ç”¨æœ‰ç©å®¶åç¨±çš„ buildingListï¼Œä¸å¾ stats é‡å»º
      // é€™æ¨£å¯ä»¥ç¢ºä¿æ¯æ£Ÿå»ºç¯‰éƒ½é¡¯ç¤ºæ­£ç¢ºçš„ç©å®¶åç¨±

      // å¦‚æœæ²’æœ‰å»ºç¯‰åˆ—è¡¨ï¼Œæ¸…ç©º
      if (!buildingList || buildingList.length === 0) {
        if (currentBuildingKey !== '') {
          container.innerHTML = '';
          currentBuildingKey = '';
        }
        statsPanel.innerHTML = '';
        return;
      }

      // å»ºç«‹å»ºç¯‰ key ä¾†æ¯”è¼ƒæ˜¯å¦æœ‰è®ŠåŒ–
      const newKey = buildingList.map(b => b.id).join(',');

      // åªæœ‰å»ºç¯‰æœ‰è®ŠåŒ–æ™‚æ‰é‡æ–°æ¸²æŸ“
      if (newKey !== currentBuildingKey) {
        const oldCount = currentBuildingKey ? currentBuildingKey.split(',').filter(x => x).length : 0;
        currentBuildingKey = newKey;

        // å°‡å»ºç¯‰åˆ†æˆå¤šæ’ï¼ˆç”±è¿‘è€Œé ï¼‰
        const rows = [];
        for (let i = 0; i < buildingList.length; i += BUILDINGS_PER_ROW) {
          rows.push(buildingList.slice(i, i + BUILDINGS_PER_ROW));
        }

        // æ¸²æŸ“å¤šæ’å»ºç¯‰
        let html = '';
        rows.forEach((rowBuildings, rowIndex) => {
          // æ±ºå®šå±¤æ¬¡ï¼šæœ€å¾Œæ’æ˜¯å‰æ’ï¼Œæœ€å‰æ’æ˜¯å¾Œæ’
          let rowClass = 'row-front';
          if (rows.length > 1) {
            const fromEnd = rows.length - 1 - rowIndex;
            if (fromEnd >= 2) rowClass = 'row-back';
            else if (fromEnd === 1) rowClass = 'row-mid';
            else rowClass = 'row-front';
          }

          html += `<div class="building-row ${rowClass}">`;
          rowBuildings.forEach((b, indexInRow) => {
            const globalIndex = rowIndex * BUILDINGS_PER_ROW + indexInRow;
            const isNew = globalIndex >= oldCount;
            // æ ¹æ“šåå­—é•·åº¦å‹•æ…‹èª¿æ•´å­—é«”å¤§å°
            const nameLength = b.playerName.length;
            const fontSize = nameLength > 6 ? '0.65rem' : nameLength > 4 ? '0.75rem' : '0.85rem';
            html += `
              <div class="building ${isNew ? '' : 'no-animation'}" style="${isNew ? `animation-delay: ${(globalIndex - oldCount) * 0.08}s` : ''}" title="${b.playerName}">
                ${createCSSBuilding(b.buildingId)}
                <div class="building-owner" style="font-size: ${fontSize};">${b.playerName}</div>
              </div>
            `;
          });
          html += '</div>';
        });

        container.innerHTML = html;
      }

      // æ¸²æŸ“åˆ†é¡çµ±è¨ˆ
      statsPanel.innerHTML = '';
      if (cityBuildings && cityBuildings.categories) {
        for (const [catId, cat] of Object.entries(cityBuildings.categories)) {
          if (cat.count === 0) continue;

          const badge = document.createElement('div');
          badge.className = 'category-badge';
          badge.innerHTML = `
            <span class="emoji">${cat.emoji}</span>
            <span>${cat.name}</span>
            <span class="count">${cat.count}</span>
          `;
          statsPanel.appendChild(badge);
        }
      }
    }

    // æ¸²æŸ“æ’è¡Œæ¦œ
    function renderLeaderboard(leaderboard, targetId = 'leaderboard') {
      const list = document.getElementById(targetId);
      if (!leaderboard || leaderboard.length === 0) {
        list.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>';
        return;
      }

      list.innerHTML = leaderboard.slice(0, 10).map((player, index) => `
        <div class="leaderboard-item">
          <div class="rank rank-${index + 1}">${index + 1}</div>
          <div class="player-info">
            <div class="player-name">${player.name}</div>
            <div class="player-buildings">${player.buildingCount || 0} æ£Ÿå»ºç¯‰</div>
          </div>
          <div class="player-score">${player.score}</div>
        </div>
      `).join('');
    }

    // äº‹ä»¶è‡ªå‹•éš±è—è¨ˆæ™‚å™¨
    let eventAutoHideTimer = null;

    // é¡¯ç¤ºäº‹ä»¶
    function showEvent(event, participants = []) {
      const panel = document.getElementById('event-panel');
      const typeMap = {
        'BOOM': 'æ™¯æ°£ç¹æ¦®',
        'RECESSION': 'æ™¯æ°£è¡°é€€',
        'DISASTER': 'ç½é›£äº‹ä»¶',
        'POLICY': 'æ”¿ç­–åˆ©å¤š',
        'SPECIAL': 'ç‰¹æ®Šäº‹ä»¶',
        'INTERACTIVE': 'äº’å‹•ä»»å‹™'
      };

      document.getElementById('event-icon').textContent = event.icon || event.emoji || 'ğŸ“¢';
      document.getElementById('event-type').textContent = typeMap[event.type] || 'äº‹ä»¶';
      document.getElementById('event-title').textContent = event.title;

      // å¦‚æœæ˜¯äº’å‹•äº‹ä»¶ä¸”æœ‰åƒèˆ‡è€…ï¼Œé¡¯ç¤ºåƒèˆ‡è€…åå–®
      if (event.type === 'INTERACTIVE' && participants && participants.length > 0) {
        const instructionsText = event.instructions || event.description;
        const participantCards = participants.map(p => `
          <div style="
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
            border: 2px solid rgba(255,215,0,0.5);
            border-radius: 10px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
          ">
            ${p.role?.emoji || 'ğŸ‘¤'} ${p.name}
          </div>
        `).join('');

        document.getElementById('event-description').innerHTML = `
          <div style="margin-bottom: 15px; font-size: 1.1rem; line-height: 1.6;">${instructionsText}</div>
          <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-top: 15px;">
            <div style="color: #FFD700; font-weight: bold; margin-bottom: 12px; font-size: 1.2rem; text-align: center;">
              ğŸ“‹ åƒèˆ‡ç©å®¶ (${participants.length}äºº)
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              ${participantCards}
            </div>
          </div>
        `;
      } else {
        document.getElementById('event-description').textContent = event.description;
      }

      const effectsEl = document.getElementById('event-effects');
      effectsEl.textContent = event.display?.affected || '--';
      effectsEl.className = `effect-text ${event.display?.mood || ''}`;

      panel.classList.add('show');

      // æ¸…é™¤èˆŠè¨ˆæ™‚å™¨
      if (eventAutoHideTimer) {
        clearTimeout(eventAutoHideTimer);
      }

      // äº’å‹•äº‹ä»¶ä¸è‡ªå‹•éš±è—ï¼Œéœ€è¦ä¸»æŒäººæ‰‹å‹•çµç®—å¾Œæ‰é—œé–‰
      if (event.type !== 'INTERACTIVE') {
        eventAutoHideTimer = setTimeout(() => {
          hideEvent();
        }, 8000);
      }
    }

    // éš±è—äº‹ä»¶
    function hideEvent() {
      document.getElementById('event-panel').classList.remove('show');
      if (eventAutoHideTimer) {
        clearTimeout(eventAutoHideTimer);
        eventAutoHideTimer = null;
      }
    }

    // è™•ç†äº’å‹•äº‹ä»¶çµç®—å®Œæˆ
    function handleInteractiveEventSettled(data) {
      // éš±è—äº‹ä»¶å½ˆçª—
      hideEvent();

      // é¡¯ç¤ºäº’å‹•äº‹ä»¶çµç®—çµæœ
      showInteractiveEventResults(data);

      // æ›´æ–°æ’è¡Œæ¦œ
      if (data.leaderboard) {
        renderLeaderboard(data.leaderboard);
      }

      // æ›´æ–°ç‹€æ…‹ç‚ºå»ºè¨­éšæ®µ
      updateStatusBadge('BUILDING');

      // é‡æ–°ç²å–éŠæˆ²ç‹€æ…‹
      fetchGameState();
    }

    // é¡¯ç¤ºäº’å‹•äº‹ä»¶çµç®—çµæœ
    function showInteractiveEventResults(data) {
      const panel = document.getElementById('event-panel');
      const typeEl = document.getElementById('event-type');
      const iconEl = document.getElementById('event-icon');
      const titleEl = document.getElementById('event-title');
      const descEl = document.getElementById('event-description');
      const effectsEl = document.getElementById('event-effects');

      // è¨­å®šäº‹ä»¶è³‡è¨Š
      iconEl.textContent = data.event.icon || 'ğŸ®';
      typeEl.textContent = 'äº’å‹•ä»»å‹™çµç®—';
      titleEl.textContent = data.event.title;

      // å»ºç«‹çµç®—çµæœåˆ—è¡¨
      const winners = data.results.filter(r => r.result === 'winner');
      const losers = data.results.filter(r => r.result === 'loser');
      const participants = data.results.filter(r => r.result === 'participant');

      let resultHTML = '<div style="text-align: left; line-height: 1.8;">';

      if (winners.length > 0) {
        resultHTML += '<div style="margin-bottom: 12px;">';
        resultHTML += '<div style="color: #FFD700; font-weight: bold; margin-bottom: 6px;">ğŸ† è´å®¶</div>';
        winners.forEach(w => {
          const coinsText = w.coins >= 0 ? `+${w.coins}å…ƒ` : `${w.coins}å…ƒ`;
          const coinsColor = w.coins >= 0 ? '#4CAF50' : '#f44336';
          resultHTML += `<div style="padding: 4px 0;">
            <span style="color: rgba(255,255,255,0.9);">${w.playerName}</span>
            <span style="color: ${coinsColor}; font-weight: bold; margin-left: 10px;">${coinsText}</span>
          </div>`;
        });
        resultHTML += '</div>';
      }

      if (losers.length > 0) {
        resultHTML += '<div style="margin-bottom: 12px;">';
        resultHTML += '<div style="color: #ff9800; font-weight: bold; margin-bottom: 6px;">ğŸ˜¢ è¼¸å®¶</div>';
        losers.forEach(l => {
          const coinsText = l.coins >= 0 ? `+${l.coins}å…ƒ` : `${l.coins}å…ƒ`;
          const coinsColor = l.coins >= 0 ? '#4CAF50' : '#f44336';
          resultHTML += `<div style="padding: 4px 0;">
            <span style="color: rgba(255,255,255,0.9);">${l.playerName}</span>
            <span style="color: ${coinsColor}; font-weight: bold; margin-left: 10px;">${coinsText}</span>
          </div>`;
        });
        resultHTML += '</div>';
      }

      if (participants.length > 0) {
        resultHTML += '<div style="margin-bottom: 12px;">';
        resultHTML += '<div style="color: #90caf9; font-weight: bold; margin-bottom: 6px;">ğŸ‘ åƒèˆ‡ç</div>';
        participants.forEach(p => {
          const coinsText = p.coins >= 0 ? `+${p.coins}å…ƒ` : `${p.coins}å…ƒ`;
          const coinsColor = p.coins >= 0 ? '#4CAF50' : '#f44336';
          resultHTML += `<div style="padding: 4px 0;">
            <span style="color: rgba(255,255,255,0.9);">${p.playerName}</span>
            <span style="color: ${coinsColor}; font-weight: bold; margin-left: 10px;">${coinsText}</span>
          </div>`;
        });
        resultHTML += '</div>';
      }

      resultHTML += '</div>';

      descEl.innerHTML = resultHTML;
      effectsEl.textContent = `å…± ${data.results.length} ä½ç©å®¶åƒèˆ‡`;
      effectsEl.className = 'effect-text positive';

      // é¡¯ç¤ºé¢æ¿
      panel.classList.add('show');

      // 8ç§’å¾Œè‡ªå‹•éš±è—
      setTimeout(() => {
        hideEvent();
      }, 8000);
    }

    // è™•ç†äº’å‹•äº‹ä»¶å–æ¶ˆ
    function handleInteractiveEventCancelled(data) {
      // éš±è—äº‹ä»¶å½ˆçª—
      hideEvent();

      // æ›´æ–°ç‹€æ…‹ç‚ºå»ºè¨­éšæ®µ
      updateStatusBadge('BUILDING');

      // é‡æ–°ç²å–éŠæˆ²ç‹€æ…‹
      fetchGameState();
    }

    // é¡¯ç¤ºçµç®—æ˜ç´°
    function showSettlement() {
      if (!currentEventData) {
        console.warn('æ²’æœ‰äº‹ä»¶æ•¸æ“šå¯é¡¯ç¤º');
        return;
      }

      const panel = document.getElementById('settlement-panel');
      const eventNameEl = document.getElementById('settlement-event-name');
      const gridEl = document.getElementById('settlement-grid');
      const totalEl = document.getElementById('settlement-total-display');

      // è¨­å®šäº‹ä»¶åç¨±
      eventNameEl.textContent = `${currentEventData.event.emoji || 'ğŸ“¢'} ${currentEventData.event.title}`;

      // æ’åºçµæœï¼ˆä¾ç‡Ÿæ”¶ç”±é«˜åˆ°ä½ï¼‰
      const sortedResults = [...currentEventData.results].sort((a, b) => b.income - a.income);

      // ç”Ÿæˆç©å®¶å¡ç‰‡
      gridEl.innerHTML = sortedResults.map((result, index) => {
        const incomeClass = result.income > 0 ? '' : (result.income < 0 ? 'negative' : '');
        const incomeSign = result.income >= 0 ? '+' : '';
        const rankClass = index < 3 ? 'top-3' : '';

        let badges = '';
        if (result.luckyTriggered) badges += '<span style="font-size: 1.2rem;" title="å¹¸é‹è§¸ç™¼">ğŸ€</span>';
        if (result.itemIncomeBonus) badges += '<span style="font-size: 1.2rem;" title="é“å…·åŠ æˆ">ğŸ“¦</span>';

        const stagger = index * 0.05;

        return `
          <div class="settlement-player-card" style="animation-delay: ${stagger}s">
            <div class="settlement-player-name">
              <span class="settlement-player-rank ${rankClass}">#${index + 1}</span>
              ${result.playerName}
              ${badges}
            </div>
            <div class="settlement-player-income ${incomeClass}">
              ç‡Ÿæ”¶ ${incomeSign}${result.income}
            </div>
            <div class="settlement-player-stats">
              <span>ğŸ’° é‡‘å¹£: ${result.newCoins}</span>
              <span>â­ ç©åˆ†: ${result.newScore}</span>
            </div>
          </div>
        `;
      }).join('');

      // è¨ˆç®—ç¸½ç‡Ÿæ”¶
      const totalIncome = currentEventData.results.reduce((sum, r) => sum + r.income, 0);

      // é¡¯ç¤ºç¸½è¨ˆ
      totalEl.innerHTML = `
        å…± ${currentEventData.results.length} ä½ç©å®¶åƒèˆ‡ | ç¸½ç‡Ÿæ”¶: +${totalIncome}
      `;

      // é¡¯ç¤ºé¢æ¿
      panel.classList.add('show');

      // éš±è—äº‹ä»¶å…¬å‘Š
      hideEvent();
    }

    // éš±è—çµç®—æ˜ç´°
    function hideSettlement() {
      const panel = document.getElementById('settlement-panel');
      panel.classList.remove('show');
    }

    // äº‹ä»¶è™•ç†
    function handleGameStarted(data) {
      document.getElementById('waiting-overlay').classList.add('hidden');
      updateStatusBadge('BUILDING');
    }

    function handleBuildingPhase(data) {
      hideEvent();
      updateStatusBadge('BUILDING');
      // é‡æ–°å–å¾—å®Œæ•´ç‹€æ…‹ï¼ˆåŒ…å«å»ºç¯‰åˆ—è¡¨ï¼‰
      fetchGameState();
    }

    function handleBuildingPurchased(data) {
      // é‡æ–°æ¸²æŸ“å»ºç¯‰ï¼ˆä½¿ç”¨å»ºç¯‰åˆ—è¡¨ï¼‰
      renderCityBuildings(data.cityBuildings, data.cityBuildingList);

      // æ›´æ–°å»ºç¯‰ç¸½æ•¸
      const total = data.cityBuildingList ? data.cityBuildingList.length : 0;
      document.getElementById('total-buildings').textContent = total;
    }

    function handleBuildingUpgraded(data) {
      console.log('ğŸ—ï¸ Building upgraded:', data);

      // é‡æ–°æ¸²æŸ“å»ºç¯‰ï¼ˆä½¿ç”¨æ›´æ–°å¾Œçš„å»ºç¯‰åˆ—è¡¨ï¼‰
      renderCityBuildings(data.cityBuildings, data.cityBuildingList);

      // æ›´æ–°å»ºç¯‰ç¸½æ•¸
      const total = data.cityBuildingList ? data.cityBuildingList.length : 0;
      document.getElementById('total-buildings').textContent = total;

      // å¯é¸ï¼šé¡¯ç¤ºå‡ç´šé€šçŸ¥ï¼ˆç°¡å–®æç¤ºï¼‰
      console.log(`âœ¨ ${data.playerName} å‡ç´šäº† ${data.mergeCount} æ£Ÿ ${data.fromBuilding.name} â†’ ${data.toBuilding.name}ï¼`);
    }

    function handleCityBuildingsUpdate(data) {
      console.log('ğŸ City buildings update (item used):', data);

      // ç›´æ¥ä½¿ç”¨å‚³å…¥çš„å»ºç¯‰åˆ—è¡¨æ›´æ–°ç•«é¢
      if (data.cityBuildingList) {
        renderCityBuildings(data.cityBuildings, data.cityBuildingList);

        // æ›´æ–°å»ºç¯‰ç¸½æ•¸
        const total = data.cityBuildingList.length;
        document.getElementById('total-buildings').textContent = total;
      } else {
        // å¦‚æœæ²’æœ‰å»ºç¯‰åˆ—è¡¨ï¼Œé‡æ–°å–å¾—å®Œæ•´ç‹€æ…‹
        fetchGameState();
      }

      // æ›´æ–°æ’è¡Œæ¦œ
      if (data.leaderboard) {
        renderLeaderboard(data.leaderboard);
      }
    }

    let currentEventData = null;  // ä¿å­˜ç•¶å‰äº‹ä»¶æ•¸æ“š

    function handleEventTriggered(data) {
      console.log('=== display handleEventTriggered ===');
      console.log('Event:', data.event?.title, 'Type:', data.event?.type);
      console.log('Participants:', data.participants);

      currentEventData = data;  // ä¿å­˜äº‹ä»¶æ•¸æ“šä¾›çµç®—æ˜ç´°ä½¿ç”¨

      // å…ˆæ›´æ–°ç‹€æ…‹å’Œæ’è¡Œæ¦œ
      updateStatusBadge('EVENT');
      renderLeaderboard(data.leaderboard);

      // é‡æ–°å–å¾—å®Œæ•´ç‹€æ…‹ï¼ˆåŒ…å«å»ºç¯‰åˆ—è¡¨ï¼‰
      fetchGameState();

      // å»¶é²é¡¯ç¤ºäº‹ä»¶å½ˆçª—ï¼Œç¢ºä¿ä¸æœƒè¢« fetchGameState çš„ç‹€æ…‹æ›´æ–°å¹²æ“¾
      setTimeout(() => {
        console.log('Calling showEvent with participants:', data.participants);
        showEvent(data.event, data.participants);
      }, 200);
    }

    function handleScoreAdded(data) {
      fetchGameState();
    }

    // æ¸²æŸ“çµæŸç•«é¢çš„å»ºç¯‰ç‰©
    function renderFinalBuildings(cityBuildingList, cityBuildings, leaderboard) {
      const finalBuildings = document.getElementById('final-buildings');
      if (!finalBuildings) return;

      let buildingList = cityBuildingList || [];

      // If cityBuildingList is empty, try to construct from cityBuildings
      if (buildingList.length === 0 && cityBuildings) {
        console.log('cityBuildingList is empty, trying cityBuildings...');
        buildingList = Object.entries(cityBuildings || {}).flatMap(([buildingId, owners]) =>
          owners.map(playerId => {
            const player = (leaderboard || []).find(p => p.playerId === playerId);
            return {
              buildingId: parseInt(buildingId),
              playerId: playerId,
              playerName: player ? player.name : playerId
            };
          })
        );
      }

      console.log('Final buildingList to render:', buildingList.length, 'buildings');

      // å¦‚æœæ²’æœ‰å»ºç¯‰æ•¸æ“šï¼Œä½¿ç”¨æ¸¬è©¦æ•¸æ“š
      if (buildingList.length === 0) {
        console.warn('âš ï¸ No buildings data! Using test data for debugging...');
        buildingList = [
          { buildingId: 1, playerName: 'æ¸¬è©¦ç©å®¶1', playerId: 'test1' },
          { buildingId: 2, playerName: 'æ¸¬è©¦ç©å®¶2', playerId: 'test2' },
          { buildingId: 3, playerName: 'æ¸¬è©¦ç©å®¶3', playerId: 'test3' },
          { buildingId: 4, playerName: 'æ¸¬è©¦ç©å®¶4', playerId: 'test4' },
          { buildingId: 5, playerName: 'æ¸¬è©¦ç©å®¶5', playerId: 'test5' }
        ];
      }

      if (buildingList.length > 0) {
        finalBuildings.innerHTML = buildingList.map(b => {
          return `
            <div class="building no-animation" title="${b.playerName}" style="transform: scale(0.45); transform-origin: bottom center; margin: 0 -10px;">
              ${createCSSBuilding(b.buildingId)}
              <div class="building-owner">${b.playerName}</div>
            </div>
          `;
        }).join('');
        console.log('âœ… Final buildings HTML set successfully');
      }
    }

    function handleGameEnded(data) {
      console.log('=== handleGameEnded called ===');
      console.log('Received data:', JSON.stringify(data, null, 2));

      updateStatusBadge('ENDED');

      // éš±è—æ‰€æœ‰å¯èƒ½é¡¯ç¤ºçš„éŠæˆ²ç•«é¢
      const pokerOverlay = document.getElementById('poker-game-overlay');
      if (pokerOverlay) pokerOverlay.style.display = 'none';

      // éš±è—äº‹ä»¶é¢æ¿
      hideEvent();

      // é¡¯ç¤ºçµæŸç•«é¢
      const endOverlay = document.getElementById('end-overlay');
      endOverlay.classList.add('show');

      // æ¸²æŸ“æœ€çµ‚åŸå¸‚å»ºç¯‰
      renderFinalBuildings(data.cityBuildingList, data.cityBuildings, data.leaderboard);

      // æ¸²æŸ“æœ€çµ‚æ’è¡Œæ¦œ
      renderLeaderboard(data.leaderboard, 'final-leaderboard');
    }

    function handlePlayerJoined(player) {
      fetchGameState();
    }

    function handleReset() {
      document.getElementById('end-overlay').classList.remove('show');
      document.getElementById('waiting-overlay').classList.remove('hidden');
      hideEvent();
      fetchGameState();
    }

    // å®šæœŸåˆ·æ–°ï¼ˆ10ç§’ä¸€æ¬¡ï¼Œæ¸›å°‘ä¸å¿…è¦çš„æ¸²æŸ“ï¼‰
    setInterval(fetchGameState, 10000);

    // ========== å°éŠæˆ²ç³»çµ± ==========

    let quizCurrentQuestion = null;

    // å¿«å•å¿«ç­”
    function handleQuizStarted(data) {
      // æ’­æ”¾éŠæˆ²é–‹å§‹éŸ³æ•ˆ
      SoundFX.gameStart();

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="minigame-icon">ğŸ’¡</div>
          <div class="minigame-title">å¿«å•å¿«ç­”</div>
          <div class="quiz-status" style="font-size: 1.5rem; color: var(--text);">
            éŠæˆ²é–‹å§‹ï¼å…± ${data.questionCount} é¡Œ
          </div>
        </div>
      `;
      overlay.classList.add('show');
    }

    let quizTimerInterval = null;

    function handleQuizQuestion(data) {
      // æ’­æ”¾é¡Œç›®å‡ºç¾éŸ³æ•ˆ
      SoundFX.questionAppear();

      quizCurrentQuestion = data;
      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="minigame-title">ğŸ’¡ å¿«å•å¿«ç­”</div>
          <div class="quiz-progress">ç¬¬ ${data.questionIndex + 1} / ${data.totalQuestions} é¡Œ</div>
          <div class="quiz-question">${data.question}</div>
          <div class="quiz-options">
            ${data.options.map((opt, i) => `
              <div class="quiz-option">${opt}</div>
            `).join('')}
          </div>
          <div class="quiz-timer" id="quiz-timer-display">å€’æ•¸ ${data.timeLimit} ç§’</div>
        </div>
      `;
      overlay.classList.add('show');

      // å€’æ•¸è¨ˆæ™‚éŸ³æ•ˆ
      if (quizTimerInterval) clearInterval(quizTimerInterval);
      let lastSecond = data.timeLimit;
      const startTime = Date.now();
      quizTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = Math.max(0, data.timeLimit - elapsed);
        const timerEl = document.getElementById('quiz-timer-display');
        if (timerEl) {
          timerEl.textContent = `å€’æ•¸ ${remaining} ç§’`;
          if (remaining <= 3 && remaining !== lastSecond && remaining > 0) {
            lastSecond = remaining;
            SoundFX.countdown();
          }
        }
        if (remaining <= 0) {
          clearInterval(quizTimerInterval);
          quizTimerInterval = null;
          SoundFX.timeUp();
        }
      }, 100);
    }

    function handleQuizEnded(data) {
      console.log('ğŸ Display: Quiz ended, data:', data);

      // åœæ­¢è¨ˆæ™‚å™¨
      if (quizTimerInterval) {
        clearInterval(quizTimerInterval);
        quizTimerInterval = null;
      }

      // æ’­æ”¾éŠæˆ²çµæŸéŸ³æ•ˆ
      SoundFX.gameEnd();

      // å¦‚æœæœ‰äººç­”å°ï¼Œæ’­æ”¾æŒè²
      const hasCorrect = data.results && data.results.some(r => r.correctCount > 0);
      if (hasCorrect) {
        setTimeout(() => SoundFX.applause(), 500);
      }

      const overlay = document.getElementById('minigame-overlay');
      const results = data.results; // é¡¯ç¤ºæ‰€æœ‰ç©å®¶
      console.log('ğŸ“Š Showing results:', results);

      overlay.innerHTML = `
        <div class="minigame-content" style="
          position: relative;
          max-width: 1400px;
          max-height: 85vh;
          padding: 40px;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          display: flex;
          gap: 40px;
        ">
          <button onclick="closeQuizResultOverlay()" style="
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
          ">
            âœ•
          </button>

          <!-- å·¦å´ï¼šåœ–æ¨™å’Œæ¨™é¡Œ -->
          <div style="
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-width: 300px;
          ">
            <div style="font-size: 8rem; margin-bottom: 20px;">ğŸ†</div>
            <div style="
              font-size: 2.5rem;
              font-weight: bold;
              color: var(--text);
              text-align: center;
              margin-bottom: 10px;
            ">å¿«å•å¿«ç­”</div>
            <div style="
              font-size: 1.5rem;
              color: var(--text-secondary);
              text-align: center;
            ">çµæœæ’å</div>
            <div style="
              margin-top: 30px;
              padding: 20px;
              background: rgba(255,255,255,0.1);
              border-radius: 15px;
              text-align: center;
            ">
              <div style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 10px;">åƒè³½äººæ•¸</div>
              <div style="font-size: 3rem; font-weight: bold; color: var(--warning);">${results.length}</div>
            </div>
          </div>

          <!-- å³å´ï¼šåå–®å€åŸŸï¼ˆå¸¶æ»¾å‹•ï¼‰ -->
          <div class="quiz-results-scroll" style="
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            max-height: calc(85vh - 80px);
          ">
            <style>
              /* è‡ªå®šç¾©æ»¾å‹•è»¸æ¨£å¼ */
              .quiz-results-scroll::-webkit-scrollbar {
                width: 12px;
              }
              .quiz-results-scroll::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
              }
              .quiz-results-scroll::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 10px;
              }
              .quiz-results-scroll::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.5);
              }
            </style>
            <div style="display: grid; gap: 12px;">
              ${results.map((r, i) => `
                <div style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  padding: 18px 25px;
                  background: ${i === 0 ? 'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.2))' :
                              i === 1 ? 'linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(169, 169, 169, 0.2))' :
                              i === 2 ? 'linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(184, 115, 51, 0.2))' :
                              'rgba(255, 255, 255, 0.05)'};
                  border-radius: 12px;
                  border-left: 4px solid ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : 'rgba(255,255,255,0.2)'};
                  transition: all 0.3s;
                ">
                  <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                    <div style="
                      min-width: 60px;
                      height: 60px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      background: ${i < 3 ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)'};
                      border-radius: 50%;
                      font-size: ${i < 3 ? '1.8rem' : '1.5rem'};
                      font-weight: bold;
                      color: ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : 'var(--text)'};
                    ">
                      ${i < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] : i + 1}
                    </div>
                    <div style="
                      font-size: 1.4rem;
                      font-weight: ${i < 3 ? 'bold' : '600'};
                      color: var(--text);
                    ">${r.playerName}</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 30px;">
                    <div style="text-align: right;">
                      <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 3px;">ç­”å°ç‡</div>
                      <div style="font-size: 1.3rem; font-weight: bold; color: var(--success);">
                        ${r.correct}/${r.total} é¡Œ
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 3px;">çå‹µ</div>
                      <div style="font-size: 1.3rem; font-weight: bold; color: var(--warning);">
                        +${r.reward} å…ƒ
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      overlay.classList.add('show');

      // ç§»é™¤èƒŒæ™¯é»æ“Šé—œé–‰åŠŸèƒ½ï¼Œåªèƒ½é€éé—œé–‰æŒ‰éˆ•é—œé–‰
      overlay.onclick = null;

      // ç¢ºä¿é—œé–‰æŒ‰éˆ•å¯ä»¥é»æ“Š
      const closeBtn = overlay.querySelector('button');
      if (closeBtn) {
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeQuizResultOverlay();
        };
      }
    }

    function closeQuizResultOverlay(event) {
      // å¦‚æœæœ‰eventï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡
      if (event) {
        event.stopPropagation();
      }
      document.getElementById('minigame-overlay').classList.remove('show');
    }

    function handleQuizClosed() {
      console.log('ğŸ’¡ å¿«å•å¿«ç­”éŠæˆ²çµæŸï¼Œé—œé–‰ä»‹é¢');
      // ç«‹å³é—œé–‰å°éŠæˆ²ä»‹é¢ï¼Œå›åˆ°åŸå¸‚å»ºç¯‰ç•«é¢
      document.getElementById('minigame-overlay').classList.remove('show');
    }

    // å–å•¤é…’æ¯”è³½
    let beerParticipants = [];

    function handleBeerWaitingStart() {
      beerParticipants = [];

      // æ’­æ”¾ç­‰å¾…éŸ³æ•ˆ
      SoundFX.gameStart();

      const overlay = document.getElementById('minigame-overlay');
      const maxSlots = 5; // æœ€å¤šé¡¯ç¤º5å€‹ä½ç½®ï¼ˆä¸€å±€æœ€å¤š5äººï¼‰
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="minigame-icon">ğŸº</div>
          <div class="minigame-title">å–å•¤é…’æ¯”è³½</div>
          <div class="beer-status">ç­‰å¾…ç©å®¶åŠ å…¥...</div>
          <div class="beer-participants" id="beer-participants-display">
            <div class="beer-waiting-container">
              ${Array.from({length: maxSlots}, (_, i) => `
                <div class="beer-waiting-slot">
                  <div class="beer-waiting-icon">ğŸ‘¤</div>
                  <div class="beer-waiting-text">ç­‰å¾…ä¸­...</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      overlay.classList.add('show');
    }

    function handleBeerPlayerJoined(data) {
      // æ’­æ”¾ç©å®¶åŠ å…¥éŸ³æ•ˆ
      SoundFX.playerJoin();

      beerParticipants.push(data.playerName);
      const participantsDisplay = document.getElementById('beer-participants-display');
      if (participantsDisplay) {
        const maxSlots = 5; // æœ€å¤šé¡¯ç¤º5å€‹ä½ç½®
        const emptySlots = Math.max(0, maxSlots - beerParticipants.length);

        participantsDisplay.innerHTML = `
          <div class="beer-waiting-container">
            ${beerParticipants.map(name => `
              <div class="beer-participant">
                <div class="beer-participant-icon">ğŸº</div>
                <div class="beer-participant-name">${name}</div>
              </div>
            `).join('')}
            ${Array.from({length: emptySlots}, () => `
              <div class="beer-waiting-slot">
                <div class="beer-waiting-icon">ğŸ‘¤</div>
                <div class="beer-waiting-text">ç­‰å¾…ä¸­...</div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function handleBeerGameStarted(data) {
      // æ’­æ”¾å€’æ•¸éŸ³æ•ˆ 3-2-1-GO!
      SoundFX.raceCountdown();
      setTimeout(() => SoundFX.raceCountdown(), 1000);
      setTimeout(() => SoundFX.raceCountdown(), 2000);
      setTimeout(() => SoundFX.raceGo(), 3000);

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="minigame-icon">ğŸº</div>
          <div class="minigame-title">å–å•¤é…’æ¯”è³½</div>
          <div class="beer-status" id="beer-countdown">3</div>
          <div class="beer-participants">
            ${data.participants.map(p => `
              <div class="beer-participant">${p.playerName}</div>
            `).join('')}
          </div>
        </div>
      `;

      // é¡¯ç¤ºå€’æ•¸
      const countdownEl = document.getElementById('beer-countdown');
      let count = 3;
      const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.textContent = count;
          countdownEl.style.fontSize = '4rem';
        } else if (count === 0) {
          countdownEl.textContent = 'GO!';
          countdownEl.style.color = 'var(--success)';
          countdownEl.style.fontSize = '5rem';
        } else {
          countdownEl.textContent = 'æ¯”è³½é€²è¡Œä¸­...';
          countdownEl.style.fontSize = '2rem';
          countdownEl.style.color = 'var(--text)';
          clearInterval(countdownInterval);
        }
      }, 1000);
    }

    function handleBeerResultsSet(data) {
      // æ’­æ”¾é¼“è²
      SoundFX.drumRoll();

      // å»¶é²æ’­æ”¾åæ¬¡éŸ³æ•ˆ
      setTimeout(() => {
        SoundFX.applause();
        data.results.forEach((r, i) => {
          setTimeout(() => SoundFX.rankReveal(r.rank), i * 300);
        });
      }, 1000);

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="minigame-icon">ğŸº</div>
          <div class="minigame-title">å–å•¤é…’æ¯”è³½çµæœ</div>
          <div class="beer-results">
            ${data.results.map(r => `
              <div class="beer-result-item ${r.rank === 1 ? 'rank-1' : r.rank === 2 ? 'rank-2' : ''}">
                <div style="display: flex; align-items: center; gap: 15px;">
                  <div class="beer-rank rank-${r.rank}">ç¬¬${r.rank}å</div>
                  <div style="font-weight: bold; font-size: 1.3rem;">${r.playerName}</div>
                </div>
                <div style="color: var(--warning); font-weight: bold; font-size: 1.2rem;">+${r.reward}å…ƒ</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function handleBeerEnded() {
      console.log('ğŸº å–å•¤é…’æ¯”è³½çµæŸï¼Œé—œé–‰ä»‹é¢');

      // æ’­æ”¾çµæŸéŸ³æ•ˆ
      SoundFX.gameEnd();

      // ç«‹å³é—œé–‰å°éŠæˆ²ä»‹é¢ï¼Œå›åˆ°åŸå¸‚å»ºç¯‰ç•«é¢
      document.getElementById('minigame-overlay').classList.remove('show');
      beerParticipants = [];
    }

    // æ¯”å¤§å° - å·¦å³ä½ˆå±€ç‰ˆæœ¬
    let pokerBetsData = { big: [], small: [] };
    let pokerTimerInterval = null;
    let pokerCurrentRound = 0;

    function handlePokerGameStarted() {
      console.log('ğŸƒ Display: æ”¶åˆ° pokerGameStarted');
      pokerBetsData = { big: [], small: [] };
      pokerCurrentRound = 0;
      // éŠæˆ²é–‹å§‹ï¼Œç­‰å¾…ç¬¬ä¸€å±€
    }

    function handlePokerRoundStarted(data) {
      console.log('ğŸƒ Display: æ”¶åˆ° pokerRoundStarted', data);
      pokerBetsData = { big: [], small: [] };
      pokerCurrentRound = data.roundNumber;

      // æ’­æ”¾éŠæˆ²é–‹å§‹éŸ³æ•ˆ
      SoundFX.gameStart();

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content" style="max-width: 1400px; padding: 30px;">
        <div class="poker-game-container">
          <!-- å·¦å´ï¼šæ¨™é¡Œ+æ’²å…‹ç‰Œ -->
          <div class="poker-left-section">
            <div class="poker-game-title">ğŸƒ æ¯”å¤§å°</div>
            <div class="poker-round-info">ç¬¬ ${data.roundNumber} å±€</div>
            <div class="poker-timer" id="poker-timer-display">20s</div>
            <div class="poker-card-back">ğŸ‚ </div>
            <div class="poker-rule-hint">A~6 = å° | 7 = å’Œå±€ | 8~K = å¤§</div>
          </div>

          <!-- å³å´ï¼šä¸‹æ³¨å€ -->
          <div class="poker-right-section">
            <div class="poker-bet-section big" id="poker-section-big">
              <div class="poker-bet-title big">
                ğŸ“ˆ æŠ¼å¤§ (8~K)
                <span class="poker-bet-count" id="poker-count-big">0 äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-big">
                <div class="poker-no-bets">ç­‰å¾…ç©å®¶ä¸‹æ³¨...</div>
              </div>
            </div>
            <div class="poker-bet-section small" id="poker-section-small">
              <div class="poker-bet-title small">
                ğŸ“‰ æŠ¼å° (A~6)
                <span class="poker-bet-count" id="poker-count-small">0 äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-small">
                <div class="poker-no-bets">ç­‰å¾…ç©å®¶ä¸‹æ³¨...</div>
              </div>
            </div>
          </div>
        </div>
        </div>
      `;
      overlay.classList.add('show');

      // å€’è¨ˆæ™‚
      const endTime = data.endTime;
      if (pokerTimerInterval) clearInterval(pokerTimerInterval);

      let lastSecond = -1;
      pokerTimerInterval = setInterval(() => {
        const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
        const timerEl = document.getElementById('poker-timer-display');
        if (timerEl) {
          timerEl.textContent = remaining + 's';
          if (remaining <= 5) {
            timerEl.classList.add('urgent');
            // æ¯ç§’æ’­æ”¾ä¸€æ¬¡æ€¥ä¿ƒéŸ³æ•ˆ
            if (remaining !== lastSecond && remaining > 0) {
              lastSecond = remaining;
              SoundFX.countdown();
            }
          }
        }
        if (remaining <= 0) {
          clearInterval(pokerTimerInterval);
          pokerTimerInterval = null;
        }
      }, 100);
    }

    function handlePokerBetPlaced(data) {
      // ç§»é™¤èˆŠçš„ä¸‹æ³¨è¨˜éŒ„ï¼ˆå¦‚æœç©å®¶æ”¹è®Šé¸æ“‡ï¼‰
      pokerBetsData.big = pokerBetsData.big.filter(name => name !== data.playerName);
      pokerBetsData.small = pokerBetsData.small.filter(name => name !== data.playerName);

      // åŠ å…¥æ–°çš„é¸æ“‡
      if (data.bet === 'big') {
        pokerBetsData.big.push(data.playerName);
      } else if (data.bet === 'small') {
        pokerBetsData.small.push(data.playerName);
      }

      updatePokerBetsDisplay();
    }

    function updatePokerBetsDisplay(result = null) {
      const bigContainer = document.getElementById('poker-bets-big');
      const smallContainer = document.getElementById('poker-bets-small');
      const bigCount = document.getElementById('poker-count-big');
      const smallCount = document.getElementById('poker-count-small');
      const bigSection = document.getElementById('poker-section-big');
      const smallSection = document.getElementById('poker-section-small');

      if (bigCount) bigCount.textContent = pokerBetsData.big.length + ' äºº';
      if (smallCount) smallCount.textContent = pokerBetsData.small.length + ' äºº';

      if (bigContainer) {
        bigContainer.innerHTML = pokerBetsData.big.length > 0 ?
          pokerBetsData.big.map(name => {
            let cls = 'poker-bet-player';
            if (result) {
              cls += result === 'big' ? ' winner' : (result === 'tie' ? '' : ' loser');
            }
            return `<div class="${cls}">${name}</div>`;
          }).join('') :
          '<div class="poker-no-bets">ç­‰å¾…ç©å®¶ä¸‹æ³¨...</div>';
      }

      if (smallContainer) {
        smallContainer.innerHTML = pokerBetsData.small.length > 0 ?
          pokerBetsData.small.map(name => {
            let cls = 'poker-bet-player';
            if (result) {
              cls += result === 'small' ? ' winner' : (result === 'tie' ? '' : ' loser');
            }
            return `<div class="${cls}">${name}</div>`;
          }).join('') :
          '<div class="poker-no-bets">ç­‰å¾…ç©å®¶ä¸‹æ³¨...</div>';
      }

      // çµæœå‡ºä¾†å¾ŒåŠ å…¥å€å¡Šæ¨£å¼
      if (result && bigSection && smallSection) {
        bigSection.classList.remove('winner', 'loser');
        smallSection.classList.remove('winner', 'loser');

        if (result === 'big') {
          bigSection.classList.add('winner');
          smallSection.classList.add('loser');
        } else if (result === 'small') {
          smallSection.classList.add('winner');
          bigSection.classList.add('loser');
        }
      }
    }

    // é–‹ç‰Œä¸­å‹•ç•«ï¼ˆ5ç§’ç­‰å¾…ï¼‰
    function handlePokerRevealing(data) {
      if (pokerTimerInterval) {
        clearInterval(pokerTimerInterval);
        pokerTimerInterval = null;
      }

      // æ’­æ”¾æ“ç‰ŒéŸ³æ•ˆï¼ˆæ¯0.5ç§’æ’­æ”¾ä¸€æ¬¡ï¼Œå…±5ç§’ï¼‰
      let shuffleCount = 0;
      const shuffleInterval = setInterval(() => {
        SoundFX.shuffling();
        shuffleCount++;
        if (shuffleCount >= 10) {
          clearInterval(shuffleInterval);
        }
      }, 500);

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content" style="max-width: 1400px; padding: 20px;">
        <div class="poker-game-container">
          <!-- å·¦å´ï¼šæ“ç‰Œå‹•ç•« -->
          <div class="poker-left-section">
            <div class="poker-game-title">ğŸƒ æ¯”å¤§å°</div>
            <div class="poker-round-info">ç¬¬ ${data.roundNumber} å±€</div>
            <div class="poker-card-shuffling">ğŸƒ</div>
            <div class="poker-revealing-text">é–‹ç‰Œä¸­...</div>
          </div>

          <!-- å³å´ï¼šä¸‹æ³¨çµæœ -->
          <div class="poker-right-section">
            <div class="poker-bet-section big" id="poker-section-big">
              <div class="poker-bet-title big">
                ğŸ“ˆ æŠ¼å¤§
                <span class="poker-bet-count">${pokerBetsData.big.length} äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-big">
                ${pokerBetsData.big.length > 0 ?
                  pokerBetsData.big.map(name => `<div class="poker-bet-player">${name}</div>`).join('') :
                  '<div class="poker-no-bets">ç„¡äººä¸‹æ³¨</div>'
                }
              </div>
            </div>
            <div class="poker-bet-section small" id="poker-section-small">
              <div class="poker-bet-title small">
                ğŸ“‰ æŠ¼å°
                <span class="poker-bet-count">${pokerBetsData.small.length} äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-small">
                ${pokerBetsData.small.length > 0 ?
                  pokerBetsData.small.map(name => `<div class="poker-bet-player">${name}</div>`).join('') :
                  '<div class="poker-no-bets">ç„¡äººä¸‹æ³¨</div>'
                }
              </div>
            </div>
          </div>
        </div>
        </div>
      `;
    }

    function handlePokerRoundEnded(data) {
      if (pokerTimerInterval) {
        clearInterval(pokerTimerInterval);
        pokerTimerInterval = null;
      }

      // æ’­æ”¾é–‹ç‰Œæ­æ›‰éŸ³æ•ˆ
      SoundFX.reveal();

      // å»¶é²æ’­æ”¾çµæœéŸ³æ•ˆï¼ˆç­‰é–‹ç‰Œå‹•ç•«å®Œæˆï¼‰
      setTimeout(() => {
        if (data.result === 'tie') {
          SoundFX.tie();
        } else if (data.winners && data.winners.length > 0) {
          SoundFX.applause();
        }
        if (data.losers && data.losers.length > 0) {
          setTimeout(() => SoundFX.loser(), 800);
        }
      }, 500);

      const cardNames = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
      const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      const suit = suits[Math.floor(Math.random() * 4)];
      const cardValue = cardNames[data.card - 1] || data.card;
      const isRed = suit === 'â™¥' || suit === 'â™¦';

      let resultText, resultIcon;
      if (data.result === 'tie') {
        resultText = 'å’Œå±€ (7)';
        resultIcon = 'ğŸ¤';
      } else if (data.result === 'big') {
        resultText = 'å¤§';
        resultIcon = 'ğŸ“ˆ';
      } else {
        resultText = 'å°';
        resultIcon = 'ğŸ“‰';
      }

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content" style="max-width: 1400px; padding: 30px;">
        <div class="poker-game-container">
          <!-- å·¦å´ï¼šæ’²å…‹ç‰Œçµæœ -->
          <div class="poker-left-section">
            <div class="poker-game-title">ğŸƒ æ¯”å¤§å°</div>
            <div class="poker-round-info">ç¬¬ ${data.roundNumber} å±€ - çµæœ</div>
            <div class="poker-card ${isRed ? 'red' : 'black'}">
              <div class="poker-card-corner top-left">${cardValue}<br>${suit}</div>
              <div class="poker-card-value">${cardValue}</div>
              <div class="poker-card-suit">${suit}</div>
              <div class="poker-card-corner bottom-right">${cardValue}<br>${suit}</div>
            </div>
            <div class="poker-result-badge ${data.result}">${resultIcon} ${resultText}</div>
            <div class="poker-waiting-next">ç­‰å¾…ä¸»æŒäººé–‹å§‹ä¸‹ä¸€å±€...</div>
          </div>

          <!-- å³å´ï¼šçµæœé¡¯ç¤º -->
          <div class="poker-right-section">
            <div class="poker-bet-section big ${data.result === 'big' ? 'winner' : (data.result === 'tie' ? '' : 'loser')}" id="poker-section-big">
              <div class="poker-bet-title big">
                ğŸ“ˆ æŠ¼å¤§
                <span class="poker-bet-count">${pokerBetsData.big.length} äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-big">
                ${pokerBetsData.big.length > 0 ?
                  pokerBetsData.big.map(name => {
                    const cls = data.result === 'big' ? 'poker-bet-player winner' :
                               (data.result === 'tie' ? 'poker-bet-player' : 'poker-bet-player loser');
                    return `<div class="${cls}">${name}</div>`;
                  }).join('') :
                  '<div class="poker-no-bets">ç„¡äººä¸‹æ³¨</div>'
                }
              </div>
            </div>
            <div class="poker-bet-section small ${data.result === 'small' ? 'winner' : (data.result === 'tie' ? '' : 'loser')}" id="poker-section-small">
              <div class="poker-bet-title small">
                ğŸ“‰ æŠ¼å°
                <span class="poker-bet-count">${pokerBetsData.small.length} äºº</span>
              </div>
              <div class="poker-bet-players" id="poker-bets-small">
                ${pokerBetsData.small.length > 0 ?
                  pokerBetsData.small.map(name => {
                    const cls = data.result === 'small' ? 'poker-bet-player winner' :
                               (data.result === 'tie' ? 'poker-bet-player' : 'poker-bet-player loser');
                    return `<div class="${cls}">${name}</div>`;
                  }).join('') :
                  '<div class="poker-no-bets">ç„¡äººä¸‹æ³¨</div>'
                }
              </div>
            </div>
          </div>
        </div>
        </div>
      `;
    }

    function handlePokerGameEnded(data) {
      if (pokerTimerInterval) {
        clearInterval(pokerTimerInterval);
        pokerTimerInterval = null;
      }

      // æ’­æ”¾éŠæˆ²çµæŸéŸ³æ•ˆ
      SoundFX.gameEnd();

      setTimeout(() => {
        document.getElementById('minigame-overlay').classList.remove('show');
        pokerBetsData = { big: [], small: [] };
        pokerCurrentRound = 0;
      }, 1000);
    }

    function closePokerResult() {
      document.getElementById('minigame-overlay').classList.remove('show');
    }

    // ===== çŒœæ­Œæ›²å‰å¥ =====
    let songGuessState = {
      allPlayers: [], // æ‰€æœ‰ç©å®¶åˆ—è¡¨
      players: new Map(), // playerId -> { name, submitted, answer, isCorrect }
      correctAnswer: null,
      currentRound: 0
    };

    function handleSongGuessGameStarted(data) {
      // æ’­æ”¾éŠæˆ²é–‹å§‹éŸ³æ•ˆ
      SoundFX.gameStart();

      songGuessState.allPlayers = data?.allPlayers || [];
      songGuessState.players.clear();
      songGuessState.correctAnswer = null;
      songGuessState.currentRound = 0;

      // éŠæˆ²é–‹å§‹æœƒè‡ªå‹•é–‹å§‹ç¬¬ä¸€å±€ï¼Œé€™è£¡åªåˆå§‹åŒ–ç‹€æ…‹
      // å¯¦éš›ç•«é¢ç”± handleSongGuessRoundStarted è™•ç†
    }

    function handleSongGuessRoundStarted(data) {
      // ç¬¬ä¸€å±€æ’­æ”¾éŠæˆ²é–‹å§‹éŸ³æ•ˆï¼Œå…¶ä»–å±€æ’­æ”¾æ–°ä¸€å±€éŸ³æ•ˆ
      if (data.round === 1) {
        SoundFX.gameStart();
      } else {
        SoundFX.songRoundStart();
      }

      songGuessState.allPlayers = data.allPlayers || [];
      songGuessState.players.clear();
      songGuessState.correctAnswer = null;
      songGuessState.currentRound = data.round;

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon">ğŸµ</div>
              <div class="song-title">çŒœæ­Œæ›²å‰å¥</div>
              <div class="song-status">ç¬¬ ${data.round} å±€</div>
              <div class="song-status" style="margin-top: 15px; font-size: 1.2rem; color: var(--warning);">
                è†è½éŸ³æ¨‚ï¼ŒçŒœçŒœæ­Œå...
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title">ğŸ¤ ç©å®¶ç­”é¡Œç‹€æ…‹</div>
              <div class="song-players-grid" id="song-players-grid">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
      `;
      overlay.classList.add('show');
      updateSongPlayersDisplay();
    }

    function handleSongGuessPlayerSubmitted(data) {
      // æ’­æ”¾æäº¤ç­”æ¡ˆéŸ³æ•ˆ
      SoundFX.answerSubmit();

      songGuessState.players.set(data.playerId, {
        name: data.playerName,
        submitted: true,
        answer: null,
        isCorrect: null
      });
      updateSongPlayersDisplay();
    }

    function handleSongGuessRoundEnded(data) {
      // æ’­æ”¾ç­”æ¡ˆæ­æ›‰éŸ³æ•ˆ
      SoundFX.answerReveal();

      songGuessState.correctAnswer = data.correctAnswer;

      // å»ºç«‹å›ç­”ç©å®¶çš„ Mapï¼ˆç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾ï¼‰
      const answeredPlayers = new Map();
      data.results.forEach(result => {
        answeredPlayers.set(result.playerId, result);
        songGuessState.players.set(result.playerId, {
          name: result.playerName,
          submitted: true,
          answer: result.answer,
          isCorrect: result.isCorrect
        });
      });

      // å»ºç«‹å®Œæ•´çš„ç©å®¶çµæœåˆ—è¡¨ï¼ˆåŒ…å«æ²’å›ç­”çš„ç©å®¶ï¼‰
      const allPlayerResults = songGuessState.allPlayers.map(player => {
        const answered = answeredPlayers.get(player.id);
        if (answered) {
          return answered;
        } else {
          // æ²’å›ç­”çš„ç©å®¶ç®—ç­”éŒ¯
          return {
            playerId: player.id,
            playerName: player.name,
            answer: '',  // ç©ºç™½
            isCorrect: false
          };
        }
      });

      // å¦‚æœæœ‰äººç­”å°ï¼Œæ’­æ”¾æŒè²
      const hasCorrect = allPlayerResults.some(r => r.isCorrect);
      if (hasCorrect) {
        setTimeout(() => SoundFX.applause(), 600);
      } else {
        // å…¨éŒ¯æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
        setTimeout(() => SoundFX.wrong(), 600);
      }

      // æ›´æ–°é¡¯ç¤º
      const overlay = document.getElementById('minigame-overlay');
      const correctCount = allPlayerResults.filter(r => r.isCorrect).length;
      const wrongCount = allPlayerResults.length - correctCount;

      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon">ğŸµ</div>
              <div class="song-title">çŒœæ­Œæ›²å‰å¥</div>
              <div class="song-status">ç¬¬ ${data.round} å±€çµæœ</div>
              <div class="song-answer-display">
                ğŸ¤ ${data.correctAnswer}
              </div>
              <div style="margin-top: 20px; font-size: 1.3rem;">
                <span style="color: var(--success);">âœ“ ${correctCount}äººç­”å°</span>
                <span style="margin: 0 15px; color: var(--text-muted);">|</span>
                <span style="color: var(--danger);">âœ— ${wrongCount}äººç­”éŒ¯</span>
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title">ğŸ¤ ç­”é¡Œçµæœ</div>
              <div class="song-players-grid">
                ${allPlayerResults.map(r => `
                  <div class="song-player-item ${r.isCorrect ? 'correct' : 'wrong'}">
                    <div style="flex: 1;">
                      <div class="song-player-name">${r.playerName}</div>
                      <div class="song-player-answer">${r.answer ? `"${r.answer}"` : 'ï¼ˆæœªä½œç­”ï¼‰'}</div>
                    </div>
                    <div class="song-player-status">
                      ${r.isCorrect ? 'âœ“' : 'âœ—'}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function updateSongPlayersDisplay() {
      const grid = document.getElementById('song-players-grid');
      if (!grid) return;

      if (songGuessState.allPlayers.length === 0) {
        grid.innerHTML = `
          <div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1 / -1;">
            ç­‰å¾…ç©å®¶åŠ å…¥...
          </div>
        `;
        return;
      }

      // é¡¯ç¤ºæ‰€æœ‰ç©å®¶ï¼Œä¸¦æ¨™è¨˜å“ªäº›å·²æäº¤
      grid.innerHTML = songGuessState.allPlayers.map(player => {
        const playerData = songGuessState.players.get(player.id);
        const submitted = playerData && playerData.submitted;
        const isCorrect = playerData && playerData.isCorrect;

        let className = 'song-player-item';
        let statusIcon = 'â³';

        if (isCorrect !== null && isCorrect !== undefined) {
          // å·²å…¬å¸ƒçµæœ
          className += isCorrect ? ' correct' : ' wrong';
          statusIcon = isCorrect ? 'âœ“' : 'âœ—';
        } else if (submitted) {
          // å·²æäº¤ä½†æœªå…¬å¸ƒ
          className += ' submitted';
          statusIcon = 'âœ“';
        } else {
          // æœªæäº¤
          className += ' not-submitted';
          statusIcon = 'â³';
        }

        return `
          <div class="${className}">
            <div class="song-player-name">${player.name}</div>
            <div class="song-player-status">${statusIcon}</div>
          </div>
        `;
      }).join('');
    }

    // ========== AIæ˜¯çœŸæ˜¯å‡ éŠæˆ² ==========
    let aiGameState = {
      active: false,
      currentQuestion: 0,
      survivors: [],
      answeredCount: 0,
      roundResults: []
    };

    function handleAIGameStarted(data) {
      console.log('[AIGame Display] éŠæˆ²é–‹å§‹', data);
      SoundFX.gameStart();

      aiGameState = {
        active: true,
        currentQuestion: 0,
        survivors: data.survivors || [],
        answeredCount: 0,
        roundResults: []
      };

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon">ğŸ¤–</div>
              <div class="song-title">AIæ˜¯çœŸæ˜¯å‡ï¼Ÿ</div>
              <div class="song-status">ç­‰å¾…ä¸»æŒäººç™¼é€ç¬¬ä¸€é¡Œ...</div>
              <div class="song-status" style="margin-top: 20px; font-size: 1.3rem; color: var(--text-muted);">
                å­˜æ´»ç©å®¶: ${data.survivors.length} äºº
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title">ğŸ® åƒè³½ç©å®¶</div>
              <div class="song-players-grid" id="ai-players-grid">
                ${data.survivors.map(s => `
                  <div class="song-player-item">
                    <div class="song-player-name">${s.playerName}</div>
                    <div class="song-player-status">â³</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      overlay.classList.add('show');
    }

    function handleAIQuestionDisplay(data) {
      console.log('[AIGame Display] é¡¯ç¤ºé¡Œç›®', data);

      aiGameState.currentQuestion = data.questionIndex;
      aiGameState.survivors = data.survivors;
      aiGameState.answeredCount = 0;

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon">ğŸ¤–</div>
              <div class="song-title">AIæ˜¯çœŸæ˜¯å‡ï¼Ÿ</div>
              <div class="song-status">ç¬¬ ${data.questionIndex + 1} / ${data.totalQuestions} é¡Œ</div>
              <div style="margin-top: 20px; font-size: 1.5rem; color: var(--warning);">
                ${data.question}
              </div>
              <div style="margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                ${data.options.map((opt, idx) => `
                  <div style="background: var(--bg-hover); padding: 15px 25px; border-radius: 10px; font-size: 1.2rem;">
                    ${idx + 1}. ${opt}
                  </div>
                `).join('')}
              </div>
              <div style="margin-top: 30px; font-size: 1.1rem; color: var(--text-muted);">
                å·²ä½œç­”: <span id="ai-answered-display">0</span> / ${data.survivors.length} äºº
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title">ğŸ® å­˜æ´»ç©å®¶ (${data.survivors.length}äºº)</div>
              <div class="song-players-grid" id="ai-players-grid">
                ${data.survivors.map(s => `
                  <div class="song-player-item" id="ai-player-${s.playerId}">
                    <div class="song-player-name">${s.playerName}</div>
                    <div class="song-player-status">â³</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      overlay.classList.add('show');
    }

    function handleAIPlayerAnswered(data) {
      console.log('[AIGame Display] ç©å®¶ä½œç­”', data);
      aiGameState.answeredCount = data.answeredCount;

      // æ›´æ–°ä½œç­”è¨ˆæ•¸
      const countDisplay = document.getElementById('ai-answered-display');
      if (countDisplay) {
        countDisplay.textContent = data.answeredCount;
      }

      // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
      const playerEl = document.getElementById(`ai-player-${data.playerId}`);
      if (playerEl) {
        playerEl.classList.add('submitted');
        const statusEl = playerEl.querySelector('.song-player-status');
        if (statusEl) {
          statusEl.textContent = 'âœ“';
        }
      }

      SoundFX.answerSubmit();
    }

    function handleAIAnswerRevealed(data) {
      console.log('[AIGame Display] ç­”æ¡ˆå…¬å¸ƒ', data);
      SoundFX.answerReveal();

      const correctCount = data.correctPlayers.length;
      const wrongCount = data.wrongPlayers.length;
      const playerAnswerDetails = data.playerAnswerDetails || [];

      // å¦‚æœæœ‰äººç­”å°ï¼Œæ’­æ”¾æŒè²ï¼›å¦å‰‡æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
      if (correctCount > 0) {
        setTimeout(() => SoundFX.applause(), 600);
      } else {
        setTimeout(() => SoundFX.wrong(), 600);
      }

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon">ğŸ¤–</div>
              <div class="song-title">AIæ˜¯çœŸæ˜¯å‡ï¼Ÿ</div>
              <div class="song-status">ç¬¬ ${data.questionIndex + 1} é¡Œçµæœ</div>
              <div class="song-answer-display" style="background: var(--success); color: white; padding: 20px 40px; border-radius: 15px; margin: 20px 0; font-size: 1.8rem;">
                æ­£ç¢ºç­”æ¡ˆ: ${data.correctAnswerText}
              </div>
              <div style="margin-top: 20px; font-size: 1.3rem;">
                <span style="color: var(--success);">âœ“ ${correctCount}äººç­”å°</span>
                <span style="margin: 0 15px; color: var(--text-muted);">|</span>
                <span style="color: var(--danger);">âœ— ${wrongCount}äººç­”éŒ¯</span>
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title">ğŸ“Š æ¯ä½ç©å®¶çš„ç­”æ¡ˆ</div>
              <div class="song-players-grid" style="justify-content: center;">
                ${playerAnswerDetails.map(p => `
                  <div class="song-player-item ${p.isCorrect ? 'correct' : 'wrong'}" style="min-width: 150px;">
                    <div class="song-player-name">${p.playerName}</div>
                    <div class="song-player-status" style="font-size: 0.9rem; margin-top: 5px;">
                      é¸: ${p.answerText}
                    </div>
                    <div style="font-size: 1.2rem; margin-top: 5px;">
                      ${p.isCorrect ? 'âœ“' : 'âœ—'}
                    </div>
                  </div>
                `).join('') || '<div style="color: var(--text-muted); padding: 10px;">ç„¡ç©å®¶ä½œç­”</div>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function handleAIGameEnded(data) {
      console.log('[AIGame Display] éŠæˆ²çµæŸ', data);
      SoundFX.applause();

      const overlay = document.getElementById('minigame-overlay');
      overlay.innerHTML = `
        <div class="minigame-content">
          <div class="song-guess-container">
            <div class="song-info">
              <div class="song-icon" style="font-size: 5rem;">ğŸ†</div>
              <div class="song-title">AIæ˜¯çœŸæ˜¯å‡ï¼Ÿ</div>
              <div class="song-status" style="font-size: 2rem; color: var(--success);">éŠæˆ²çµæŸï¼</div>
              <div style="margin-top: 30px; font-size: 1.5rem;">
                æœ€çµ‚å­˜æ´»: ${data.finalSurvivors.length} äºº
              </div>
            </div>
            <div class="song-players-section">
              <div class="song-players-title" style="font-size: 1.5rem;">ğŸ‰ æœ€çµ‚å­˜æ´»è€…</div>
              <div class="song-players-grid" style="justify-content: center;">
                ${data.finalSurvivors.length > 0 ? data.finalSurvivors.map(s => `
                  <div class="song-player-item correct" style="font-size: 1.3rem; padding: 20px;">
                    <div class="song-player-name">${s.playerName}</div>
                    <div class="song-player-status">ğŸ†</div>
                  </div>
                `).join('') : `
                  <div style="color: var(--text-muted); padding: 30px; font-size: 1.2rem;">
                    ç„¡äººå­˜æ´»
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;

      // é¡¯ç¤ºçµæœ5ç§’å¾Œé—œé–‰
      setTimeout(() => {
        overlay.classList.remove('show');
        aiGameState.active = false;
      }, 5000);
    }

    // å¼·åˆ¶é—œé–‰ AI éŠæˆ² overlayï¼ˆä¸»æŒäººæ‰‹å‹•çµæŸæ™‚ç«‹å³é—œé–‰ï¼‰
    function closeAIGameOverlay() {
      const overlay = document.getElementById('minigame-overlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
      aiGameState.active = false;
    }

    // ========== æŠ½çç³»çµ± ==========
    let lotteryPlayers = [];       // å¯æŠ½ççš„ç©å®¶åˆ—è¡¨
    let lotteryWinners = [];       // å·²ä¸­ççš„ç©å®¶
    let isSpinning = false;        // æ˜¯å¦æ­£åœ¨è½‰å‹•
    let spinInterval = null;       // è½‰å‹•è¨ˆæ™‚å™¨
    let currentPrizeIndex = 1;     // ç›®å‰çé …ç·¨è™Ÿ

    // é–‹å§‹æŠ½çæ¨¡å¼
    function startLotteryMode(players) {
      lotteryPlayers = players.filter(p => !lotteryWinners.some(w => w.id === p.id));
      if (lotteryPlayers.length === 0) {
        alert('æ²’æœ‰å¯æŠ½ççš„ç©å®¶äº†ï¼');
        return;
      }

      document.getElementById('lottery-overlay').classList.add('show');
      document.getElementById('lottery-prize-label').textContent = `ç¬¬ ${currentPrizeIndex} ä½å¹¸é‹å…’`;
      document.getElementById('lottery-hint').textContent = 'ç­‰å¾…ä¸»æŒäººé»æ“ŠæŠ½ç...';
      document.getElementById('lottery-winner-display').innerHTML = '';

      // å»ºç«‹åå­—è»Œé“
      buildNamesTrack();
      updateWinnersList();
    }

    // å»ºç«‹åå­—è»Œé“ï¼ˆé‡è¤‡å¤šæ¬¡ä»¥ç”¢ç”Ÿç„¡é™æ»¾å‹•æ•ˆæœï¼‰
    function buildNamesTrack() {
      const track = document.getElementById('lottery-names-track');
      const repeatCount = 10; // é‡è¤‡æ¬¡æ•¸
      let html = '';

      for (let i = 0; i < repeatCount; i++) {
        lotteryPlayers.forEach(player => {
          html += `
            <div class="lottery-name-item" data-id="${player.id}">
              <div class="name">${player.name}</div>
              <div class="score">${player.score} åˆ†</div>
            </div>
          `;
        });
      }

      track.innerHTML = html;
      track.style.transform = 'translateX(0)';
      track.classList.remove('stopping');
    }

    // é–‹å§‹è½‰å‹•
    function startSpin() {
      if (isSpinning || lotteryPlayers.length === 0) return;

      isSpinning = true;
      document.getElementById('lottery-hint').textContent = 'æŠ½çä¸­...';
      document.getElementById('lottery-winner-display').innerHTML = '';

      const track = document.getElementById('lottery-names-track');
      track.classList.remove('stopping');

      // ç§»é™¤ä¹‹å‰çš„ winner æ¨™è¨˜
      track.querySelectorAll('.lottery-name-item').forEach(item => {
        item.classList.remove('winner');
      });

      let position = 0;
      const speed = 30; // é€Ÿåº¦ï¼ˆæ¯å¹€ç§»å‹•çš„åƒç´ ï¼‰
      const itemWidth = 220; // æ¯å€‹é …ç›®å¯¬åº¦ï¼ˆ200px + 20px marginï¼‰

      spinInterval = setInterval(() => {
        position -= speed;
        track.style.transform = `translateX(${position}px)`;

        // ç„¡é™å¾ªç’°
        const totalWidth = lotteryPlayers.length * itemWidth;
        if (Math.abs(position) >= totalWidth * 3) {
          position += totalWidth;
        }
      }, 16);
    }

    // åœæ­¢è½‰å‹•ï¼ˆé¸ä¸­è´å®¶ï¼‰
    function stopSpin() {
      if (!isSpinning) return;

      clearInterval(spinInterval);

      // éš¨æ©Ÿé¸æ“‡ä¸€å€‹è´å®¶ï¼ˆå¯ä»¥åŠ å…¥æ¬Šé‡ï¼‰
      const winnerIndex = Math.floor(Math.random() * lotteryPlayers.length);
      const winner = lotteryPlayers[winnerIndex];

      const track = document.getElementById('lottery-names-track');
      const itemWidth = 220;
      const containerCenter = 300; // å®¹å™¨å¯¬åº¦çš„ä¸€åŠ

      // è¨ˆç®—åœæ­¢ä½ç½®ï¼ˆè®“è´å®¶åœ¨ä¸­é–“ï¼‰
      // æ‰¾åˆ°ç¬¬5çµ„çš„è´å®¶ä½ç½®
      const targetPosition = -(winnerIndex * itemWidth + lotteryPlayers.length * 4 * itemWidth) + containerCenter - itemWidth / 2;

      track.classList.add('stopping');
      track.style.transform = `translateX(${targetPosition}px)`;

      // ç­‰å¾…å‹•ç•«å®Œæˆ
      setTimeout(() => {
        isSpinning = false;

        // æ¨™è¨˜è´å®¶
        const winnerItems = track.querySelectorAll(`[data-id="${winner.id}"]`);
        winnerItems.forEach(item => item.classList.add('winner'));

        // é¡¯ç¤ºè´å®¶
        showWinner(winner);

        // æ·»åŠ åˆ°å·²ä¸­çåˆ—è¡¨
        lotteryWinners.push({
          ...winner,
          prizeIndex: currentPrizeIndex
        });

        // å¾å¯æŠ½çåˆ—è¡¨ç§»é™¤
        lotteryPlayers = lotteryPlayers.filter(p => p.id !== winner.id);

        currentPrizeIndex++;
        updateWinnersList();

        // æ”¾å½©å¸¶
        launchConfetti();

        // æ›´æ–°æç¤º
        if (lotteryPlayers.length > 0) {
          document.getElementById('lottery-hint').textContent = 'é»æ“Šç¹¼çºŒæŠ½ä¸‹ä¸€ä½...';
        } else {
          document.getElementById('lottery-hint').textContent = 'ğŸŠ æ‰€æœ‰çé …å·²æŠ½å®Œï¼';
        }

        // ç™¼é€ä¸­ççµæœåˆ°ä¼ºæœå™¨
        socket.emit('lottery:winner', {
          winner: winner,
          prizeIndex: currentPrizeIndex - 1
        });
      }, 3000);
    }

    // é¡¯ç¤ºè´å®¶
    function showWinner(winner) {
      const display = document.getElementById('lottery-winner-display');
      display.innerHTML = `
        <div class="lottery-winner-name">ğŸ‰ ${winner.name} ğŸ‰</div>
        <div class="lottery-winner-score">ç©åˆ†ï¼š${winner.score} åˆ†</div>
      `;
    }

    // æ›´æ–°å·²ä¸­çåˆ—è¡¨
    function updateWinnersList() {
      const container = document.getElementById('lottery-winners-container');

      if (lotteryWinners.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 0.9rem;">å°šæœªæŠ½å‡º</p>';
        return;
      }

      container.innerHTML = lotteryWinners.map((winner, index) => {
        let rankClass = '';
        if (index === 0) rankClass = 'gold';
        else if (index === 1) rankClass = 'silver';
        else if (index === 2) rankClass = 'bronze';

        return `
          <div class="lottery-winner-item">
            <span class="rank ${rankClass}">${index + 1}</span>
            <span style="flex: 1; margin-left: 10px;">${winner.name}</span>
            <span style="color: #FFD93D;">${winner.score}</span>
          </div>
        `;
      }).join('');
    }

    // æ”¾å½©å¸¶æ•ˆæœ - ç´«é‡‘é…è‰²
    function launchConfetti() {
      const container = document.getElementById('lottery-confetti');
      // ç´«é‡‘é…è‰²å½©å¸¶
      const colors = ['#FFD700', '#9370DB', '#8B5CF6', '#FFED4E', '#7C3AED', '#DDA0DD', '#A855F7', '#F59E0B', '#FBBF24'];

      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-piece';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.8 + 's';
        confetti.style.boxShadow = `0 0 10px ${colors[Math.floor(Math.random() * colors.length)]}`;
        container.appendChild(confetti);

        setTimeout(() => confetti.classList.add('animate'), 10);

        // æ¸…ç†
        setTimeout(() => confetti.remove(), 4500);
      }
    }

    // é—œé–‰æŠ½çæ¨¡å¼
    function closeLotteryMode() {
      document.getElementById('lottery-overlay').classList.remove('show');
    }

    // é‡ç½®æŠ½ç
    function resetLottery() {
      lotteryWinners = [];
      currentPrizeIndex = 1;
      isSpinning = false;
      if (spinInterval) clearInterval(spinInterval);
    }

    // æŠ½çäº‹ä»¶ç›£è½å™¨å·²ç§»è‡³ DOMContentLoaded å…§

    // ========== æ–°ç‰ˆé ’çå…¸ç¦®ï¼ˆåœ“å½¢è½‰ç›¤é¢¨æ ¼ï¼‰ ==========
    let awardPlayers = [];        // æ‰€æœ‰ç©å®¶ï¼ˆä¾æ’åï¼‰
    let awardWinners = [];        // å·²é ’ççš„å¾—çè€…
    let awardPrizeCount = 0;      // ç¸½çå“æ•¸
    let currentAwardRank = 0;     // ç›®å‰é ’åˆ°ç¬¬å¹¾å
    let isRevealing = false;      // æ˜¯å¦æ­£åœ¨æ­æ›‰å‹•ç•«ä¸­
    let wheelRotation = 0;        // è½‰ç›¤ç•¶å‰è§’åº¦

    // é–‹å§‹é ’çå…¸ç¦®
    function startAwardMode() {
      console.log('ğŸ¬ åŸ·è¡Œ startAwardMode()');

      // éš±è—çµæŸç•«é¢ï¼ˆå¦‚æœé¡¯ç¤ºä¸­ï¼‰
      const endOverlay = document.getElementById('end-overlay');
      if (endOverlay && endOverlay.classList.contains('show')) {
        endOverlay.classList.remove('show');
        console.log('âœ… å·²éš±è—çµæŸç•«é¢');
      }

      // é¡¯ç¤ºé ’çç•«é¢
      const lotteryOverlay = document.getElementById('lottery-overlay');
      console.log('ğŸ“º lottery-overlay å…ƒç´ :', lotteryOverlay);

      if (lotteryOverlay) {
        lotteryOverlay.classList.add('show');
        console.log('âœ… å·²æ·»åŠ  show class');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ° lottery-overlay å…ƒç´ ï¼');
      }

      document.getElementById('lottery-prize-label').textContent = `å…± ${awardPrizeCount} ä½å¾—çè€…`;

      // æ›´æ–°è½‰ç›¤ä¸­å¿ƒæ–‡å­—
      const centerText = document.getElementById('lottery-wheel-center-text');

      // å¦‚æœå·²ç¶“æœ‰å¾—çè€…ï¼Œæ¢å¾©é¡¯ç¤ºæœ€å¾Œä¸€ä½å¾—çè€…
      if (awardWinners.length > 0) {
        const lastWinner = awardWinners[awardWinners.length - 1];
        showAwardWinner(lastWinner, lastWinner.rank);
        if (centerText) {
          centerText.innerHTML = `ç¬¬${lastWinner.rank}å<br>ğŸ‰`;
        }
        if (currentAwardRank < awardPrizeCount) {
          document.getElementById('lottery-hint').textContent = 'ç­‰å¾…æ­æ›‰ä¸‹ä¸€ä½å¾—çè€…...';
        } else {
          document.getElementById('lottery-hint').textContent = 'ğŸŠ é ’çå…¸ç¦®åœ“æ»¿çµæŸï¼';
        }
      } else {
        document.getElementById('lottery-hint').textContent = 'ç­‰å¾…ä¸»æŒäººæ­æ›‰å¾—çè€…...';
        document.getElementById('lottery-winner-display').innerHTML = '';
        if (centerText) {
          centerText.innerHTML = 'ç­‰å¾…<br>æŠ½ç';
        }
      }

      // æ›´æ–°å³å´å¾—çè€…åˆ—è¡¨ï¼ˆåªå‘¼å«ä¸€æ¬¡ï¼‰
      updateAwardWinnersList();

      // é‡ç½®è½‰ç›¤è§’åº¦
      wheelRotation = 0;
      const wheel = document.getElementById('lottery-wheel');
      if (wheel) {
        wheel.style.transform = `rotate(0deg)`;
        wheel.classList.remove('spinning', 'stopping');
      }

      console.log('ğŸ‰ æŠ½çç•«é¢åˆå§‹åŒ–å®Œæˆ');
    }

    // å»ºç«‹è½‰ç›¤ä¸Šçš„åå­—ï¼ˆå·²ç§»é™¤é¡¯ç¤ºï¼Œä¿ç•™ç©ºå‡½æ•¸ä»¥é˜²å‘¼å«éŒ¯èª¤ï¼‰
    function buildWheelNames() {
      // åå­—å·²ç§»é™¤ï¼Œè½‰ç›¤åªé¡¯ç¤ºé¡è‰²
    }

    // æ­æ›‰å¾—çè€…
    function revealWinner() {
      if (isRevealing || currentAwardRank >= awardPlayers.length) return;
      isRevealing = true;

      const winner = awardPlayers[currentAwardRank];
      const rank = currentAwardRank + 1;

      document.getElementById('lottery-hint').textContent = `æ­£åœ¨æ­æ›‰ç¬¬ ${rank} å...`;

      // æ›´æ–°è½‰ç›¤ä¸­å¿ƒæ–‡å­—
      const centerText = document.getElementById('lottery-wheel-center-text');
      if (centerText) {
        centerText.innerHTML = 'æŠ½çä¸­<br>...';
      }

      // æ’­æ”¾åœ“å½¢è½‰ç›¤å‹•ç•«
      playWheelAnimation(winner, rank);
    }

    // é—œé–‰é ’ç
    function closeAwardMode() {
      document.getElementById('lottery-overlay').classList.remove('show');
      awardPlayers = [];
      awardWinners = [];
      currentAwardRank = 0;
      wheelRotation = 0;
    }

    // æ’­æ”¾è½‰ç›¤å‹•ç•«
    function playWheelAnimation(winner, rank) {
      const wheel = document.getElementById('lottery-wheel');
      const centerText = document.getElementById('lottery-wheel-center-text');

      if (!wheel) {
        console.error('æ‰¾ä¸åˆ°è½‰ç›¤å…ƒç´ ');
        isRevealing = false;
        return;
      }

      // ç§»é™¤ä¹‹å‰çš„æ¨£å¼
      wheel.classList.remove('stopping');
      wheel.classList.add('spinning');

      // è½‰å‹• 1.5-2.5 ç§’
      const spinDuration = 1500 + Math.random() * 1000;

      setTimeout(() => {
        // åœæ­¢å¿«é€Ÿæ—‹è½‰
        wheel.classList.remove('spinning');
        wheel.classList.add('stopping');

        // è¨ˆç®—æœ€çµ‚è§’åº¦ï¼ˆéš¨æ©Ÿå¤šè½‰å¹¾åœˆï¼‰
        const extraRotations = 3 + Math.floor(Math.random() * 2); // 3-4åœˆ
        const targetRotation = wheelRotation + (extraRotations * 360) + Math.random() * 360;
        wheelRotation = targetRotation;

        wheel.style.transform = `rotate(${targetRotation}deg)`;

        // ç­‰å¾…è½‰ç›¤åœæ­¢
        setTimeout(() => {
          // é¡¯ç¤ºå¾—çè€…è³‡è¨Š
          showAwardWinner(winner, rank);

          // æ›´æ–°ä¸­å¿ƒæ–‡å­—
          if (centerText) {
            centerText.innerHTML = `ç¬¬${rank}å<br>ğŸ‰`;
          }

          // æ·»åŠ åˆ°å·²å¾—çåˆ—è¡¨ï¼ˆç¢ºä¿æ ¼å¼æ­£ç¢ºï¼‰
          awardWinners.push({
            id: winner.id,
            name: winner.name || 'æœªçŸ¥',
            score: winner.score !== undefined ? winner.score : 0,
            rank: rank
          });
          updateAwardWinnersList();

          // æ›´æ–°ç•¶å‰æ’å
          currentAwardRank++;

          // æ”¾å½©å¸¶ï¼ˆä½¿ç”¨ç´«é‡‘é…è‰²ï¼‰
          launchConfetti();

          // æ›´æ–°æç¤º
          if (currentAwardRank < awardPrizeCount) {
            document.getElementById('lottery-hint').textContent = 'ç­‰å¾…æ­æ›‰ä¸‹ä¸€ä½å¾—çè€…...';
          } else {
            document.getElementById('lottery-hint').textContent = 'ğŸŠ é ’çå…¸ç¦®åœ“æ»¿çµæŸï¼';
          }

          isRevealing = false;
        }, 2000); // ç­‰å¾…åœæ­¢å‹•ç•«å®Œæˆ
      }, spinDuration);
    }

    // é¡¯ç¤ºå¾—çè€…
    function showAwardWinner(winner, rank) {
      const display = document.getElementById('lottery-winner-display');
      let rankEmoji = 'ğŸ–ï¸';
      if (rank === 1) rankEmoji = 'ğŸ¥‡';
      else if (rank === 2) rankEmoji = 'ğŸ¥ˆ';
      else if (rank === 3) rankEmoji = 'ğŸ¥‰';

      const winnerName = winner.name || 'æœªçŸ¥';
      const winnerScore = winner.score !== undefined ? winner.score : 0;

      display.innerHTML = `
        <div class="lottery-winner-rank">${rankEmoji} ç¬¬ ${rank} å ${rankEmoji}</div>
        <div class="lottery-winner-info">
          <div class="lottery-winner-name">${winnerName}</div>
          <div class="lottery-winner-score">${winnerScore} åˆ†</div>
        </div>
      `;
    }

    // æ›´æ–°å·²å¾—çåˆ—è¡¨
    function updateAwardWinnersList() {
      const container = document.getElementById('lottery-winners-container');

      if (awardWinners.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: rgba(221,160,221,0.8); font-size: 0.9rem;">ç­‰å¾…æ­æ›‰...</p>';
        return;
      }

      container.innerHTML = awardWinners.map((winner) => {
        // ç¢ºä¿ winner ç‰©ä»¶æœ‰æ­£ç¢ºçš„å±¬æ€§ï¼ˆä¿®å¾© undefined å•é¡Œï¼‰
        const winnerName = winner.name || 'æœªçŸ¥';
        const winnerScore = winner.score !== undefined ? winner.score : 0;
        const winnerRank = winner.rank || 0;

        let rankClass = '';
        if (winnerRank === 1) rankClass = 'gold';
        else if (winnerRank === 2) rankClass = 'silver';
        else if (winnerRank === 3) rankClass = 'bronze';

        return `
          <div class="lottery-winner-item">
            <span class="rank ${rankClass}">${winnerRank}</span>
            <div class="winner-info">
              <div class="winner-name">${winnerName}</div>
              <div class="winner-score">${winnerScore} åˆ†</div>
            </div>
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
